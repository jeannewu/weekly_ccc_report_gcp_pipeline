---
title: "Connect Weekly Operations Metrics"
date: "`r format(Sys.Date(), '%d %B, %Y')`"
author: "JingWU"

output:
  pdf_document:
    extra_dependencies:
    - float
    toc: yes
    toc_depth: 2
    keep_tex: yes
    fig_width: 8
    fig_height: 6
    fig_caption: yes
    latex_engine: xelatex
    df_print: paged

header-includes: \usepackage[labelformat=empty]{caption}

# knit: (function(inputFile, encoding) {rmarkdown::render("consolidated_weekly_report.RMD", output_file=paste("Connect_WeeklyOperationsMetrics_", Sys.Date(), ".pdf", sep=""))})

---
## General Information

This Consolidated weekly report is a summary with tables and plots for the Connect Recruitment Progress by week from Invitation, through Sign-In, Consent, User Profile, and Verification. The de-identified demographic information provided the the sites for the recruits is summarized by age, race/ethnicity, and sex. Response rate is calculated as the total number of participants verified from active recruitment both among all sites and for each site individually. The activity completion status of all verified participants is based on the completion of the four baseline survey modules and biospecimen donations.

The analytic data set for this report is created from the“nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP” table in BQ which is updated daily. Not Active recruits and duplicates in the Active recruits are excluded from these analyses. 

All variables are stored as CIDs which can be found in the master dictionary: “https:// episphere.github.io/conceptGithubActions/aggregate.json” 

This report contains data as of `r format(Sys.Date(), '%d %B, %Y')`. Atypical records under investigation are not included in the metrics tables and may result in Total columns that do not add up to 100%

```{r setup, include=FALSE,eval=TRUE,echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
# The working data applied is the recruitment data 'nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP' synchronouslly updated with the ongoing study, without any inactive participants, or duplicates found in the active recruitments.
# 
# All the variable are masked under the CIDs which can be tracked in the master dictionary: "https://episphere.github.io/conceptGithubActions/aggregate.json"
# 
#this report is requested from Michelle and Amelia on their post "https://whiteboard.office.com/me/whiteboards/p/c3BvOmh0dHBzOi8vbmloLW15LnNoYXJlcG9pbnQuY29tL3BlcnNvbmFsL3JvYmVydHNhbW1fbmloX2dvdg%3d%3d/b!Eb7hM1dN60q8-hG5dOCRdAw005hidr1Gs3sPmv59pnJP7YgyoSdAT4Ly-hfFmaLg/01TLSRKTEVFJFSAXCIFFAY4J7R4E7L5H4P" 

###Amelia requested and commented on Mar. 29, 2023, change the footnote in table 40 to say the same thing as 41a 'Note: Excludes those with sign in time later than consent time (data being corrected).' and then change the filename of the report to 'Connect_WeeklyOperationsMetrics_YYYYMMDD'. And carry this filename across the future reports as well

library(bigrquery)
library(data.table) ###to write or read and data management 
library(boxr) ###read or write data from/to box
library(tidyverse) ###for data management https://tidyselect.r-lib.org/reference/faq-external-vector.html
library(dplyr) ###data management
library(reshape)  ###to work on transition from long to wide or wide to long data
library(listr) ###to work on a list of vector, files or..
library(sqldf) ##sql
library(lubridate) ###date time
library(ggplot2) ###plots
library(ggpubr) ###for the publications of plots
library(RColorBrewer) ###visions color http://www.sthda.com/english/wiki/colors-in-r
library(gridExtra)
library(stringr) ###to work on patterns, charaters
library(plyr)
library(tidyr)
library(tinytex) #for pdf
library(rmarkdown) ###for the output tables into other files: pdf, rtf, etc.
library(janitor) #to get the summary sum
library(finalfit) #https://cran.r-project.org/web/packages/finalfit/vignettes/export.html t
library(expss) ###to add labels
library(epiDisplay) ##recommended applied here crosstable, tab1
library(summarytools) ##recommended
library(gmodels) ##recommended
library(magrittr)
library(arsenal)
library(gtsummary)
library(kableExtra)
#library(patchwork)
library(rio)
library(jsonlite)
options(knitr.table.format = "latex")
currentDate <- Sys.Date()

write_to_box <- FALSE

#dictionary <- rio::import("https://github.com/episphere/conceptGithubActions/blob/master/aggregate.json",format = "json")
dictionary <- rio::import("https://episphere.github.io/conceptGithubActions/aggregate.json",format = "json")
dd <- dplyr::bind_rows(dictionary,.id="CID")
#dd <- dd[!duplicated(dd),] #remove 140duplicates
#THIS TABLE HAS REPLICATED (CIDS+LABELS) WITH DIFFERENT VARIABLE NAMES,
dd$`Variable Label` <- ifelse(is.na(dd$`Variable Label`), dd$`Variable Name`, dd$`Variable Label`)
#dd <- as.data.frame.matrix(do.call("rbind",dictionary)) #3523, some CID and labels are linked to different variable names 

#dd1 <- dd[!duplicated(dd[,c("CID","Variable Label")]),]
length(unique(dd$CID))

#the master dd with more info. on the formats (levels)
urlfile<- "https://raw.githubusercontent.com/episphere/conceptGithubActions/master/csv/masterFile.csv" ###to grab the updated dd from github
y <- read.csv(urlfile)
#dd$labels.combo <- paste(dd$`Variable Label`,dd$`Variable Name`,sep="$")
 bq_auth()
#The bigrquery package is requesting access to your Google account.
#Select a pre-authorised account or enter '0' to obtain a new token.
#Press Esc/Ctrl + C to cancel.

 1 #: wuj12@nih.gov
  project <- "nih-nci-dceg-connect-prod-6d04"
  billing <- "nih-nci-dceg-connect-prod-6d04" ##project and billing should be consistent

recr_var <- bq_project_query(project, query="SELECT * FROM  `nih-nci-dceg-connect-prod-6d04.FlatConnect`.INFORMATION_SCHEMA.COLUMN_FIELD_PATHS WHERE table_name='participants_JP'")
recrvar <- bigrquery::bq_table_download(recr_var,bigint = "integer64")
recrvar_d <- recrvar[grepl("d_",recrvar$column_name),]

nvar = floor((length(recrvar_d$column_name))/5) ##to define the number of variables in each sql extract from GCP
nvar

# Start column for each split data frame
 start = seq(1,length(recrvar_d$column_name),nvar)
 end <- length(recrvar_d$column_name)

 recrbq <- list()

 for (i in (1:length(start)))  {
   select <- paste(recrvar_d$column_name[start[i]:(min(start[i]+nvar-1,end))],collapse=",")
   tmp <- eval(parse(text=paste("bq_project_query(project, query=\"SELECT token,Connect_ID,", select,"FROM  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` Where d_512820379 != '180583933' or d_821247024='197316935' \")",sep=" ")))

   recrbq[[i]] <- bq_table_download(tmp, bigint="integer64")
 }

  recr_noinact_wl <- recrbq %>% reduce(inner_join, by = c("token","Connect_ID"))

 # Check that it doesn't match any non-number
  numbers_only <- function(x) !grepl("\\D", x)

 ###convert the numeric
 recr_noinact_wl1 <- recr_noinact_wl
 cnames <- names(recr_noinact_wl)
# # to check variables in recr_noinact_wl1
 for (i in 1: length(cnames)){
    varname <- cnames[i]
    var<-pull(recr_noinact_wl1,varname)
    recr_noinact_wl1[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
  }


# saveRDS(recr_noinact_wl1, paste("recruit",currentDate,".rds", sep=""))
  # recr_noinact_wl1 <- readRDS("~/Documents/CONNECT_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/recruit2023-03-27.rds" )

data <- recr_noinact_wl1[which(recr_noinact_wl1$d_512820379 != 180583933 | recr_noinact_wl1$d_821247024 == 197316935),] #0 removeal

data <- recr_noinact_wl1[which (recr_noinact_wl1$d_821247024 != 922622075 | recr_noinact_wl1$d_512820379 !=486306141),] #248

#for the verification mode as a hierachy one: outreach&manual, manual and automatical: the automation only be the automation without any mannual checks
data <- data %>% mutate(race = case_when(state_d_684926335 == 635279662 | state_d_849518448 == 768826601 | state_d_119643471 == 635279662 ~ "White" ,#768826601
          state_d_684926335 %in% c(232334767,401335456) | state_d_849518448 == 181769837 |
                                          state_d_119643471 == 232334767| state_d_119643471  ==211228524|state_d_119643471 ==308427446| state_d_119643471  ==432722256| state_d_119643471  ==232663805| state_d_119643471  ==785578696| state_d_119643471  ==200929978| state_d_119643471  ==490725843| state_d_119643471  == 965998904 ~ "Other", #181769837
                                         state_d_684926335 == 178420302  | state_d_849518448 ==178420302 | state_d_119643471 == 986445321| state_d_119643471  == 746038746| state_d_119643471  == 178420302 | (is.na(state_d_119643471) & d_827220437== 657167265) ~ "Unknown"),
                      
                        sex = case_when(state_d_706256705 == 536341288 | state_d_435027713 == 536341288 ~ "Female",
                                        state_d_706256705 == 654207589 | state_d_435027713 == 654207589 ~ "Male",
                                        state_d_706256705 == 830573274 ~ "Intersex or Other",
                                        state_d_706256705 %in% c(178420302,NA) | state_d_435027713 %in% c(178420302,NA) ~ "Unknown"),
                        age = case_when(state_d_934298480 == 124276120 ~ "40-45",
                                        state_d_934298480 == 450985724 ~ "46-50",
                                        state_d_934298480 == 363147933 ~ "51-55",
                                        state_d_934298480 == 636706443 ~ "56-60",
                                        state_d_934298480 == 771230670 ~ "61-65"),
                        recruit_type = case_when(d_512820379 == 486306141 ~ "Active",
                                                d_512820379 == 854703046 ~ "Passive",
                                                d_512820379 == 180583933 & d_821247024 == 197316935 ~ "Not Active But Verified"),
                        verified_type = case_when(d_821247024 == 197316935 & state_d_444699761	== 426360242 & state_d_953614051 == 734437214 ~ "Automated Verification", #RcrtV_Automated_v1r0
                                                  d_821247024 == 197316935 &  state_d_953614051	== 426360242 & (state_d_188797763 %in% c(104430631,NA)) ~ "Manual Verification",#	RcrtV_Mannual_v1r0 without outreach
                                                  d_821247024 == 197316935 & state_d_953614051	== 426360242 & state_d_188797763 == 353358909 ~ "Manual Verification and outreach", #	RcrtV_Mannual_v1r0
                        ),
                        active_camptype = case_when(state_d_667474224 == 926338735 ~ "Random",
                                                    state_d_667474224 == 348281054 ~ "Screening appointment",
                                                    state_d_667474224 == 324692899 ~ "Non-screening appointment",
                                                    state_d_667474224 == 351257378 ~ "Demographic Group",
                                                    state_d_667474224 == 647148178 ~ "Aging out of study",
                                                    state_d_667474224 == 834544960 ~ "Geographic group",
                                                    state_d_667474224 == 682916147 ~ "Post-screening appointment",
                                                    state_d_667474224 == 153365143 ~ "Technology adapters",
                                                    state_d_667474224 == 663706936 ~ "Low-income/health professional shortage areas",
                                                    state_d_667474224 == 181769837 ~ "Other",
                                                    state_d_667474224 == 398561594 ~ "None of these apply",
                                                    is.na(state_d_667474224)  ~ "NA/Unknown"),
                        
                        recrt_steps_v1r0 = case_when((d_230663853 == 104430631) ~"Never Signed In",
                                                     (d_230663853 == 353358909 & d_919254129 == 104430631) ~ "Signed in, No Consent",
                                                     (d_230663853 == 353358909 & d_919254129 == 353358909 & d_699625233 == 104430631) ~ "Consented, No Profile",
                                                     (d_230663853 == 353358909 & d_919254129 == 353358909 & d_699625233 == 353358909 & d_821247024 == 875007964) ~ "Profile Verification Incomplete",
                                                     (d_230663853 == 353358909 & d_919254129 == 353358909 & d_699625233 == 353358909 & d_821247024 %in% c(197316935,219863910,922622075)) ~ "Verification Complete"),
                        Rcrt_Verified_v1r0 = ifelse(is.na(d_821247024) | d_821247024 != 197316935, 104430631, 353358909),
                        verified = case_when(d_821247024 == 875007964 ~ "Not yet verified",
                                             d_821247024 == 197316935  ~ "Verified",
                                             d_821247024 ==  219863910 ~ "Cannot be verified",
                                             d_821247024 ==  922622075 ~ "Duplicate",
                                             d_821247024 ==  160161595 ~ "Outreach timed out"),                                             
                        Rcrt_completion_v1r0 = case_when((d_821247024 == 875007964) ~ 104430631,
                                                         (d_821247024 %in% c(197316935,219863910,922622075)) ~ 353358909),
                        verified = case_when(d_821247024 == 875007964 ~ "Not yet verified",
                                             d_821247024 == 197316935  ~ "Verified",
                                             d_821247024 ==  219863910 ~ "Cannot be verified",
                                             d_821247024 ==  922622075 ~ "Duplicate",
                                             d_821247024 ==  160161595 ~ "Outreach timed out"),
                        
                        Preconsent = case_when(state_d_158291096 == 104430631 ~ "No", #d_158291096	as	RcrtSI_OptOut_v1r0,
                                               state_d_158291096 == 353358909 ~ "Yes"),
                        SSN = case_when(d_311580100 == 353358909 ~ "Full SSN Given",
                                        d_311580100 == 104430631 & d_914639140 == 353358909 ~ "Partial SSN Given",
                                        d_311580100 == 104430631 & d_914639140 == 104430631 ~ "No SSN Given"),
                        CSSigned = case_when(d_230663853 ==353358909 & d_919254129 == 104430631 ~ "Signed-In, no Consent",
                                             d_230663853 == 104430631 & d_919254129 == 104430631 ~ "Never Signed-In",
                                             d_230663853 ==353358909 & d_919254129 == 353358909 ~"Signed-In, Consent Submitted"),
                        biocol_type = case_when(d_878865966 ==353358909 & d_167958071 == 353358909 & d_684635302 == 353358909 ~ "All",
                                                d_878865966 ==353358909 & d_167958071 == 353358909 & d_684635302 == 104430631 ~ "Blood & Urine Only",
                                                d_878865966 ==353358909 & d_167958071 == 104430631 & d_684635302 == 353358909 ~ "Blood & Mouthwash Only",
                                                d_878865966 ==104430631 & d_167958071 == 353358909 & d_684635302 == 353358909 ~ "Mouthwash & Urine Only",
                                                d_878865966 ==353358909 & d_167958071 == 104430631 & d_684635302 == 104430631 ~ "Blood Only",
                                                d_878865966 ==104430631 & d_167958071 == 353358909 & d_684635302 == 104430631 ~ "Urine Only",
                                                d_878865966 ==104430631 & d_167958071 == 104430631 & d_684635302 == 353358909 ~ "Mouthwash Only",
                                                d_878865966 ==104430631 & d_167958071 == 104430631 & d_684635302 == 104430631 ~ "None")) 

data$biocol_type <- factor(data$biocol_type, levels=c("All","Blood & Urine Only","Blood & Mouthwash Only","Mouthwash & Urine Only","Blood Only","Urine Only","Mouthwash Only","None"))
#data$Rcrt_Verified_v1r0 <- factor(data$Rcrt_Verified_v1r0,exclude=NULL)

data$verified <- factor(data$verified,exclude=NULL, levels=c("Not yet verified","Verified","Cannot be verified","Duplicate","Outreach timed out"))

data$basesvcomplt <- ifelse(data$d_949302066 %in% c(615768760,972455046, NA) ,"None",
                            ifelse(data$d_949302066 == 231311385 & data$d_536735468 == 231311385 & data$d_663265240 == 231311385 & data$d_976570371 == 231311385, "All",
                                   ifelse(data$d_949302066 == 231311385 & data$d_536735468 != 231311385 & data$d_663265240 != 231311385 & data$d_976570371 != 231311385 , "BOH only",
                                          "2 or 3 sections")))

data$basesvcomplt <- factor(data$basesvcomplt,levels=c("All","2 or 3 sections","BOH only","None"))

data <- expss::apply_labels(data,d_827220437 = "Site",#RcrtES_Site_v1r0
                     d_827220437 = c("HealthPartners"= 531629870, "Henry Ford Health System"=548392715, "Kaiser Permanente Colorado" = 125001209, "Kaiser Permanente Georgia" = 327912200,"Kaiser Permanente Hawaii" = 300267574,"Kaiser Permanente Northwest" = 452412599, "Marshfield Clinic Health System" = 303349821,"Sanford Health" = 657167265, "University of Chicago Medicine" = 809703864, "National Cancer Institute" = 517700004,"National Cancer Institute" = 13,"Other" = 181769837))
#RcrtSI_SignedIn_v1r0 RcrtCS_Consented_v1r0 RcrtUP_Submitted_v1r0  Rcrt_completion_v1r0 Rcrt_Verified_v1r

data$site <- factor(data$d_827220437,exclude=NULL,
                    levels=c("HealthPartners", "Henry Ford Health System","Marshfield Clinic Health System",
                             "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado",
                             "Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest",
                             "National Cancer Institute","Other"))
data$site <- droplevels(data$site)

data <- data %>% filter(!is.na(site)) %>% arrange(site)

process <- c("d_230663853","d_919254129","d_699625233","Rcrt_completion_v1r0","Rcrt_Verified_v1r0")

recr_process_long <- NULL
for (i in 1:length(process)){
  
  tmp<- data[,c("token","Connect_ID","d_827220437")]
  tmp$recr_Process_v1r0 <- data[,which(colnames(data) == process[i])]
  tmp$stage <- i
  tmp <- tmp[which(tmp$stage ==1 |(tmp$stage >1 & tmp$recr_Process_v1r0==353358909)),]
  recr_process_long <- rbind(tmp,recr_process_long)

}

recr_process_long <- recr_process_long %>% mutate(stage_new = ifelse(recr_Process_v1r0 == 104430631 & stage ==1, 0,
                                                                 ifelse(recr_Process_v1r0 == 353358909 & stage == 1, 1,
                                                                  ifelse(recr_Process_v1r0 == 353358909 & stage == 2, 2,
                                                                   ifelse( recr_Process_v1r0 == 353358909 & stage == 3, 3,
                                                                   ifelse(recr_Process_v1r0 == 353358909 & stage == 4,4,
                                                                   ifelse( recr_Process_v1r0 == 353358909 & stage == 5 ,5,NA)))))))

recr_process_long <- apply_labels(recr_process_long,
                            d_827220437 = "Site",#RcrtES_Site_v1r0
                            d_827220437 = c("HealthPartners"= 531629870, "Henry Ford Health System"=548392715, "Kaiser Permanente Colorado" = 125001209,
                                            "Kaiser Permanente Georgia" = 327912200,"Kaiser Permanente Hawaii" = 300267574,"Kaiser Permanente Northwest" = 452412599,
                                            "Marshfield Clinic Health System" = 303349821,"Sanford Health" = 657167265, "University of Chicago Medicine" = 809703864,
                                            "National Cancer Institute" = 517700004,"National Cancer Institute" = 13,"Other" = 181769837),
                            
                            stage_new = "Work Flow",
                            stage_new = c("Never Signed-In" = 0,"Signed-in" = 1,  "Consented"=  2, "Profile Done" = 3,"Verification Complete" = 4, "Verified"= 5 ))

recr_process_long$stage1 <- factor(recr_process_long$stage_new,exclude=NULL,levels=c("Never Signed-In","Signed-in","Consented", "Profile Done","Verification Complete", "Verified"))
recr_process_long$site <- factor(recr_process_long$d_827220437,exclude=NULL)  

recr_count <- recr_process_long[which(recr_process_long$d_827220437>0),] %>%
  group_by(stage_new,d_827220437) %>%
  dplyr::summarise(count=n())

recr_count <- apply_labels(recr_count,                        d_827220437 = "Site",#RcrtES_Site_v1r0
                            d_827220437 = c("HealthPartners"= 531629870, "Henry Ford Health System"=548392715, "Kaiser Permanente Colorado" = 125001209,
                                            "Kaiser Permanente Georgia" = 327912200,"Kaiser Permanente Hawaii" = 300267574,"Kaiser Permanente Northwest" = 452412599,
                                            "Marshfield Clinic Health System" = 303349821,"Sanford Health" = 657167265, "University of Chicago Medicine" = 809703864,
                                            "National Cancer Institute" = 517700004,"National Cancer Institute" = 13,"Other" = 181769837),
                            
                            stage_new = "Work Flow",
                            stage_new = c("Never Signed-In" = 0,"Signed-in" = 1,  "Consented"=  2, "Profile Done" = 3,"Verification Complete" = 4, "Verified"= 5 ))


recr_count$stage <- factor(recr_count$stage_new,exclude=NULL)
recr_count$stage <- factor(recr_count$stage_new,labels=c("Never Signed-In","Signed-in", "Consented", "Profile Done","Verification Complete", "Verified"))
recr_count$site <- factor(recr_count$d_827220437,exclude=NULL)

recr_count1 <- NULL
 for(stage in unique(recr_count$stage)){
   
     recr_count1  <- dplyr::filter(recr_count, stage == stage) %>% arrange(stage,factor(d_827220437)) %>% mutate(cum.count=cumsum(count),
                                                                                 label.count=cumsum(count)-0.1*count)
     
 }


```

## Tables

```{r, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

pct_tb <- function(x,y){
  table1 <- CrossTable(x,y)
  pct <- as.data.frame(cbind(table1$prop.row,table1$t))
  if(ncol(pct)==2){
    total <- as.numeric(sum(pct[,2]))
    pct[nrow(pct)+1,c(1:2)] <- c(1,total)
    rownames(pct)[nrow(pct)] <- "Total"
    colnames(pct)[1] <- paste0("pct_",colnames(pct)[1])
    colnames(pct)[2] <- paste0("n_",colnames(pct)[2])
    
  }
  else  if(ncol(pct)>2 ){
    total <- as.numeric(sum(pct[,3] + pct[,4]))
    pct[nrow(pct)+1,c(1:4)] <- c(sum(pct[,3])/total,sum(pct[,4])/total,sum(pct[,3]),sum(pct[,4]))
    rownames(pct)[nrow(pct)] <- "Total"
    colnames(pct)[c(1:2)] <- paste0("pct_",colnames(pct[c(1:2)]))
    colnames(pct)[c(3:4)] <- paste0("n_",colnames(pct)[c(3:4)])
  
    pct[,5] <- paste0(format(pct[,3],big.mark=","), " (",round(100*pct[,1],2), " %)")
    pct[,6] <- paste0(format(pct[,4],big.mark=","), " (",round(100*pct[,2],2), " %)") 
    colnames(pct)[5] <- paste0("n_",colnames(pct)[1])
    colnames(pct)[6] <- paste0("n_",colnames(pct)[2])
  }
return(pct)
}
#as Michelle and Nicole agreed, all atyplical data (abnormal ones) by defined would be excluded from the recruitment data in the weekly repor: e.g. the verified from the inactive group, optout with signed in ect.
#table 1 Total Number of Recruits
data <- data[which(data$d_512820379 != 180583933 ),]
data <- data[which (data$d_821247024 != 922622075 | data$d_512820379 !=486306141),] #248
data$site <- droplevels(data$site)
data<-data[order(data$site),]

data$recruit_type <- factor(data$recruit_type,levels=c("Active","Passive"))
data$recruit_type <-droplevels(data$recruit_type)
recruittypetotal <- as.data.frame(tab1(data[which(data$d_827220437>0),]$recruit_type, decimal = 2)[[2]]) 
recruittypetotal$Frequency <- format(recruittypetotal$Frequency,big.mark = ",")
recruittypetotal$`Recruitment Type` <- rownames(recruittypetotal)

#Table2 All Recruits by Site

   table2_recrall <- data[which(data$d_827220437>0),] %>%
     dplyr::select(site, recruit_type) %>% tbl_cross(
     row = site,
     col = recruit_type,
     label = list(recruit_type ~ "Recruitment type",site ~ "Site"),
     percent = "row",
     digits=c(0,2),
     margin_text="Total Recruits")
   
   table2_recrall[["table_body"]]$stat_0 <- sapply(strsplit(table2_recrall[["table_body"]]$stat_0," "),"[",1) 
    
   table2_recrall <- table2_recrall %>%
     #bold_labels() %>%
     #italicize_levels() %>% 
     modify_header() %>%
     modify_caption("Table 2. All Recruits by Site") %>%
     as_kable_extra(escape = FALSE, addtl_fmt = TRUE) 
	 
#table 3 (Table21 in Daily) Verified Participants and Response Ratio

# active respons rate:where %= (N active verified/N active recruits)*100
# passive response rate where %=(N passive verified/N passive recruits)*100
# the total response rate: where %=(N Total Verified/N Total recruits)*100   
  ###the total active recruits: active recruits:
   # active respons rate:where %= (N active verified/N active recruits)*100
   # passive response rate where %=(N passive verified/N active recruits)*100
   # the total response rate: where %=(N Total Verified/N active recruits)*100   

   
###Table 4. Cumulative Status Total
#a. overall verified status by site
   #option1
data$site <- droplevels(data$site)
data <- data[order(data$site),]
  recr_process_step <- NULL
  for (i in 1:length(process)){
    
    tmp<- data[which(data$d_827220437>0),c("token","Connect_ID","site",process[i])]
    tmp <- dplyr::rename(tmp, recr_Process_v1r0 =process[i])
    
   # tmp$recr_Process_v1r0 <- tmp[which(data$d_827220437>0),which(colnames(data) == )] 
    tmp$stage <- i  
    tmp <- tmp[which(tmp$stage ==1 |(tmp$stage >1 & tmp$recr_Process_v1r0==353358909)),] 
    step <- tmp %>% group_by(site,recr_Process_v1r0) %>% dplyr::summarise(count=n())
    step$stage <- i
    recr_process_step <- rbind(step,recr_process_step)
    
  }
  recr_process_step$stage_new <- ifelse(recr_process_step$recr_Process_v1r0 == 104430631, 0, recr_process_step$stage)
  
  recr_step <- dcast(recr_process_step, site ~ stage_new, value.var = "count")
  colnames(recr_step)[c(2:7)] <- paste("step",colnames(recr_step)[c(2:7)],sep="_")
  total <- as.data.frame(t(apply(recr_step[,c(2:7)],2,sum)))
  total$site <- " Total"  
  recr_step <- rbind(recr_step,total)
  
  recr_step$total <- format(recr_step$step_0 +recr_step$step_1,big.mark=",")
 
  recr_step_pct <- recr_step %>% mutate(freq_pct1 = paste0(format(step_1,big.mark=","), "  (", round(100*step_1/(step_1+step_0),2), " %)"),
                                        freq_pct2 = paste0(format(step_2,big.mark=","), "  (", round(100*step_2/step_1,2), " %)"),
                                        freq_pct3 = paste0(format(step_3,big.mark=","), " (", round(100*step_3/step_2,2)," %)"),
                                        freq_pct4 = paste0(format(step_4,big.mark=",")," (", round(100*step_4/step_3,2)," %)"),
                                        freq_pct5 = paste0(format(step_5,big.mark=",")," (", round(100*step_5/step_4,2)," %)"))
  
  colnames(recr_step_pct)[c(1,8:13)]  <-  c("Site","Total Recruites","Signed-In","Consented","Profile Done","Verification Complete","Verified")
## to create the total cumulative table
  cumulative_all <- recr_step_pct[,c(1,8:13)]

## Table 5-6. Cumulative Status for Active/Passive Only
  active <- data[which(data$d_512820379 ==486306141),]
  passive <- data[which(data$d_512820379 == 854703046),]
  
       test <- active
       test <- passive
  ## to apply the for loop to with the tested data for the table.
       tests <- list(active,passive)
       outs<- list()

   for (tb in 1:length(tests)) {
     test=data.frame(tests[tb])
      recr_process_step<-NULL
      for (i in 1:length(process)){
      tmp<- test[which(test$d_827220437>0),c("token","Connect_ID","site",process[i])]
      tmp <- dplyr::rename(tmp, recr_Process_v1r0 =process[i])

      tmp$stage <- i  
      tmp <- tmp[which(tmp$stage ==1 |(tmp$stage >1 & tmp$recr_Process_v1r0==353358909)),] 
      step <- tmp %>% group_by(site,recr_Process_v1r0) %>% dplyr::summarise(count=n())
      step$stage <- i
      recr_process_step <- rbind(step,recr_process_step)
    }
    recr_process_step$stage_new <- ifelse(recr_process_step$recr_Process_v1r0 == 104430631, 0, recr_process_step$stage)
  
    recr_step <- dcast(recr_process_step , site ~ stage_new, value.var = "count")
    n<- ncol(recr_step)
 
    colnames(recr_step)[c(2:n)] <- paste("step",colnames(recr_step)[c(2:n)],sep="_")
    total <- as.data.frame(t(apply(recr_step[,-1],2,sum)))
    total$site <- " Total"  
    recr_step <- rbind(recr_step,total)
    if(n==6){recr_step$step_0 <- 0}
    recr_step$total <- format(recr_step$step_0 + recr_step$step_1,big.mark = ",")
    
    recr_step_pct <- recr_step %>% mutate(freq_pct1 = paste0(step_1," (",round(100*step_1/(step_1+step_0),2)," %)"),
                                          freq_pct2 = paste0(step_2," (",round(100*step_2/step_1,2)," %)"),
                                          freq_pct3 = paste0(step_3," (",round(100*step_3/step_2,2)," %)"),
                                          freq_pct4 = paste0(step_4," (",round(100*step_4/step_3,2)," %)"),
                                          freq_pct5 = paste0(step_5," (",round(100*step_5/step_4,2)," %)"))
    
    colnames(recr_step_pct)[c(1,9:13)]  <-  c("Site","Signed-In","Consented","Profile Done","Verification Complete","Verified")
    ##to create the total cumulative table
 
    outs[[tb]] <- recr_step_pct
   } 
       
       cumulative_active <- as.data.frame(outs[[1]])
	   recr_step_pct[,c(1,8:13)] 
	     cumulative_passive <- as.data.frame(outs[[2]])
	     recr_step_pct[,c(1,8:13)] 

 
   verfied_types <- data %>% dplyr::filter(Rcrt_Verified_v1r0 == 353358909 & d_827220437>0) %>% 
     group_by(site,recruit_type) %>% dplyr::summarize(count=n())
   
   verified <- dcast(verfied_types, site ~ recruit_type, value.var = "count")
   colnames(verified)[1] <- "Site"
  active_recruits <- cumulative_active[,c("Site","total")]
  active_recruits$total <- as.numeric(gsub(",", "", active_recruits$total))
   
    cumu_response.rate <-merge(active_recruits,verified, by="Site",all.x=TRUE)
  
    
    cumu_response.rate$active.response.rate <- ifelse(cumu_response.rate$Site ==" Total",round(100*sum(verified$Active)/cumu_response.rate$total,2), round(100*cumu_response.rate$Active/as.numeric(cumu_response.rate$total),2))
    
    cumu_response.rate$passive.response.rate <- ifelse(cumu_response.rate$Site ==" Total", round(100*sum(verified$Passive)/cumu_response.rate$total,2),
                                                       round(100*cumu_response.rate$Passive/cumu_response.rate$total,2))
    
    cumu_response.rate$Active.Response <- ifelse(cumu_response.rate$Site !=" Total", paste0(format(cumu_response.rate$Active,big.mark=","), " (",cumu_response.rate$active.response.rate, "%)"), paste0(format(sum(verified$Active),big.mark=","), " (",cumu_response.rate$active.response.rate,"%)"))
    
    cumu_response.rate$Passive.Response <- ifelse(cumu_response.rate$Site !=" Total", paste0(format(cumu_response.rate$Passive,big.mark=","), " (",cumu_response.rate$passive.response.rate,"%)"), paste0(format(sum(verified$Passive),big.mark=","), " (",cumu_response.rate$passive.response.rate, "%)"))
    
    cumu_response.rate$Total.Response <- ifelse(cumu_response.rate$Site !=" Total", paste0(format(cumu_response.rate$Passive + cumu_response.rate$Active, big.mark=","), " (",cumu_response.rate$passive.response.rate + cumu_response.rate$active.response.rate,"%)"), paste0(format(sum(verified$Passive+verified$Active),big.mark=","), " (",cumu_response.rate$passive.response.rate + cumu_response.rate$active.response.rate,"%)"))
    cumu_response.rate$total <- format(cumu_response.rate$total, big.mark=",") 
    colnames(cumu_response.rate)[2] <- "Total Active Recruits"
    n <- as.numeric(ncol(cumu_response.rate))
   Table3_response.rate<-  cumu_response.rate[,c(1,(n-2):n,2)]
   colnames(Table3_response.rate) <- gsub(".R"," R",colnames(Table3_response.rate))

##Table 7a/b. Recruits Verification Status with Profile Completion	     
##the Table 7 profile complete
 data$verified <- factor(data$verified,exclude=NULL, levels=c("Not yet verified","Verified","Cannot be verified","Duplicate","Outreach timed out"))
  UP_type_verified<- NULL
  for(site in unique(data$site)){
    
    UP_type_verified  <- filter(data[which(data$d_827220437>0 & data$d_699625233 == 353358909),],d_512820379== 486306141 & site==site ) %>%
      arrange(site,factor(Rcrt_Verified_v1r0)) 
  }
  
  UP_active_verified <- UP_type_verified %>% 
    group_by(verified,site) %>% dplyr::summarise(count=n())
  
  UP_active_verified <- UP_active_verified %>% arrange(verified,site) %>% mutate(cum.count=cumsum(count))
       
  Table7_profilecomplete <- data %>% filter(d_827220437>0 & d_699625233 == 353358909 & d_512820379== 486306141) %>% 
    select(verified,site) %>% tbl_cross(row = site,
    col = verified,
    label =list(verified ~ "Verification Status with Profile Completion",site~"Site") ,
    percent = "row",
    digits=c(0,2),
    margin_text = "Total Active Recruits \n With Profile Completion")
  
  
  Table7_profilecomplete[["table_body"]]$stat_0 <- sapply(strsplit(Table7_profilecomplete[["table_body"]]$stat_0," "),"[",1)
  
  Table7_profilecomplete <- Table7_profilecomplete%>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header(
                stat_1="Not yet \n Verified",
                stat_3="Cannot Be \n Verified",
                stat_5="Outreach \n Timed Out") %>%
  modify_caption("Table 7a. Active Recruits Verification Status With Profile Completion") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
  
    Table7b_pro_pas <- data %>% filter(d_827220437>0 & d_699625233 == 353358909 & d_512820379==854703046) %>% 
          select(verified,site) %>% tbl_cross(   row = site,
    col = verified,
    label =list(verified ~ "Verification Status With Profile Completion",site~"Site"), 
    percent = "row",
    digits=c(0,2),
    margin_text = "Total Passive Recruits With Profile Completion") 
    
    Table7b_pro_pas[["table_body"]]$stat_0 <- sapply(strsplit(Table7b_pro_pas[["table_body"]]$stat_0," "),"[",1)
    Table7b_pro_pas <- Table7b_pro_pas %>%
    #bold_labels() %>%
    #italicize_levels() %>% 
    modify_header(stat_0 = "Total Passive Recruits \n With Profile Completion",
                stat_1="Not yet \n Verified",
                stat_3="Cannot Be \n Verified",
                stat_5="Outreach \n Timed Out") %>%
    modify_caption("Table 7b. Passive Recruits Verification Status With Profile Completion") %>%
      as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

    #Table 8
    Table8_profile <- data %>% filter(d_699625233==353358909) %>%  
      dplyr::select(site, verified) %>% tbl_cross(
        row = site,
        col = verified,
        label = list(verified ~ "Verification Status",site~"Site"),
        percent = "row",
        digits = c(0,2),
        missing = "ifany",
        missing_text = "Unknown",
        margin_text = "Total Submitted User Profile") 
    
    Table8_profile[["table_body"]]$stat_0 <- sapply(strsplit(Table8_profile[["table_body"]]$stat_0," "),"[",1) 
    
 Table8_profile <- Table8_profile%>%
      #bold_labels() %>%
      #italicize_levels() %>% 
      modify_header(stat_0 = "Total Submitted \n User Profile",
                stat_1="Not yet \n Verified",
                stat_3="Cannot Be \n Verified",
                stat_5="Outreach \n Timed Out") %>%
      modify_caption("Table 8. Verification Status among Recruits That Have Submitted User Profile") %>%
      as_kable_extra(escape = FALSE, addtl_fmt = TRUE) 
    #Timing of Pre-consent Opt Out among Active Recruits
                     
##Table 9: Verification Mode of Those Successfully Verified from weekly report (Table 3):
 verified <- data[which(data$d_821247024 ==197316935),]
verified <- data[which(data$d_821247024 ==197316935),] %>% 
  mutate(verified_type = case_when( state_d_444699761	== 426360242 & state_d_953614051 == 734437214 ~ "Automated Verification", #RcrtV_Automated_v1r0
                                   state_d_953614051	== 426360242 & (state_d_188797763 %in% c(104430631,NA)) ~ "Manual Verification",#	RcrtV_Manual_v1r0 without outreach
                                   state_d_953614051	== 426360242 & state_d_188797763 == 353358909 ~ "Manual Verification and Outreach", #	RcrtV_Mannual_v1r0
                        ))

#kw0 <- paste0("Total Verified Recruits",footnote_marker_number(1, double_escape = T,"latex"))

verified$verified_type <- factor(verified$verified_type, levels=c("Automated Verification","Manual Verification","Manual Verification and Outreach"))

table9_verifiedtype <-  data[which(data$d_821247024 == 197316935),] %>%
  dplyr::select(site, verified_type) %>% 
    tbl_cross(row = site,
              col = verified_type,
              label = list(verified_type ~"Verification Mode of Those Successfully Verified",site~"Site"),
              digits=c(0,2),
              percent = "row",
              missing = "ifany",
              missing_text = "Missing",
              margin_text = "Total Verified Participants")

 table9_verifiedtype[["table_body"]]$stat_0 <- sapply(strsplit(table9_verifiedtype[["table_body"]]$stat_0," "),"[",1) 
 table9_verifiedtype <- table9_verifiedtype %>%
  modify_header('stat_3'~"Manual Verification and Outreach") %>%
  modify_caption("Table 9. Verification Mode of Those Successfully Verified") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

#Table 10. Completion of Initial Survey of Verified Participants (Daily Table 15)
  data$basesvcomplt <- factor(data$basesvcomplt, levels=c("All","2 or 3 sections", "BOH only","None"))
  data$site <- droplevels(data$site)
   table10 <- data[which(data$d_821247024 == 197316935),] %>% mutate(site=droplevels(site)) %>% select(site, basesvcomplt) %>% dplyr::arrange(site,basesvcomplt) %>% tbl_cross(
     row = site,
     col = basesvcomplt,
     label = list(basesvcomplt ~ "Baseline Initial Survey Completion",site~"Site"),
     percent = "row",
     digits=c(0,2),
     margin_text="Total Verified Participants") 
   
   table10[["table_body"]]$stat_0 <- sapply(strsplit(table10[["table_body"]]$stat_0," "),"[",1)
    
    table10 <- table10%>%
     #bold_labels() %>%
     #italicize_levels() %>% 
     modify_header(stat_0 = "Total Verified \n Participants",
                   stat_2="2 or 3 Sections") %>%
     modify_caption("Table 10. Completion of Initial Survey by Verified Participants") %>%
     as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
    
#Table 11. SSN of Verified Participants (Daily Table 16)
   data$SSN <- factor(data$SSN,levels=c("Full SSN Given","Partial SSN Given","No SSN Given"),exclude=NULL,order=TRUE)
   table11 <- data[which(data$d_821247024 == 197316935),] %>% select(site, SSN) %>% tbl_cross(
     row = site,
     col = SSN,
     percent = "row",
     label=site~"Site",
     digits=c(0,2),
     margin_text="Total Verified Participants") 
   
   table11[["table_body"]]$stat_0 <- sapply(strsplit(table11[["table_body"]]$stat_0," "),"[",1)
    
   table11 <- table11 %>%
     #bold_labels() %>%
     #italicize_levels() %>% 
     modify_header(stat_0 = "Total Verified \n Participants") %>%
     modify_caption("Table 11. SSN of Verified Participants") %>%
     as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
	
#Table 12 (Daily Table22). Baseline Biospecimen Collected among Verified Participants
    table12_biocol <-  data %>% filter(d_821247024 == 197316935) %>% 
      dplyr::select(site, biocol_type) %>% tbl_cross(
        row = site,
        col = biocol_type,
        label = list(biocol_type ~ "Sample Collections",site="Site"),
        percent = "row",
        digits=c(0,2),
        margin_text="Total Verified Participants")
        
    table12_biocol[["table_body"]]$stat_0 <- sapply(strsplit(table12_biocol[["table_body"]]$stat_0," "),"[",1) 
    
    table12_biocol <- table12_biocol %>%
      #bold_labels() %>%
      #italicize_levels() %>% 
      modify_header(stat_0 = "Total Verified \n Participants") %>%
      modify_caption("Table 12. Baseline Biospecimens Collected among Verified Participants") %>%
      as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
   
 #Table 13.Completed Baseline Survey and Sample among Verified Participants and Response Ratio
   #   d_878865966	as	BioFin_BaseBloodCol_v1r0, /*Baseline Blood Collected*/
   #   d_167958071	as	BioFin_BaseUrineCol_v1r0, /*Baseline Urine collected*/
   #   d_684635302	as	BioFin_BaseMouthCol_v1r0, /*	Baseline MW Collected*/
   
   data$survey_complete <- ifelse(data$basesvcomplt == "All" & data$d_878865966 == 353358909 & data$d_167958071 == 353358909 & data$d_684635302 == 353358909 ,"Yes","No")
   data$survey_complete <- factor(data$survey_complete,levels=c("Yes","No"),order=TRUE)
  table13_surveycomplt <- data %>% filter(d_821247024 == 197316935) %>% 
   dplyr::select(site, survey_complete) %>% tbl_cross(
     row = site,
     col = survey_complete,
     label = list(survey_complete ~ "Completion of Baseline Survey \nand Sample Collections",site~"Site"),
     percent = "row",
     digits=c(0,2),
     margin_text="Total Verified Participants")
  
  table13_surveycomplt[["table_body"]]$stat_0 <- sapply(strsplit(table13_surveycomplt[["table_body"]]$stat_0," "),"[",1) 
    
  table13_surveycomplt <- table13_surveycomplt %>%
    #bold_labels() %>%
    #italicize_levels() %>% 
    modify_header(stat_0 = "Total Verified \n Participants") %>%
    modify_caption("Table 13. Completion of Baseline Survey and All Three Baseline Samples Among Verified Participants") %>%
    as_kable_extra(escape = FALSE, addtl_fmt = TRUE) 


###Tables 14 (Weekly table 24,25:34) Completion of Baseline Activities among Verified Participants of All sites and each site individually,
data$basesvcomplt <- ifelse(data$d_949302066 %in% c(615768760,972455046, NA) ,"None",
    ifelse(data$d_949302066 == 231311385 & data$d_536735468 == 231311385 & data$d_663265240 == 231311385 & data$d_976570371 == 231311385, "All",
       ifelse(data$d_949302066 == 231311385 & data$d_536735468 != 231311385 & data$d_663265240 != 231311385 & data$d_976570371 != 231311385 , "BOH only",
              "2 or 3 Sections")))

#data$survey_complete <- factor(data$basesvcomplt,levels=c("Yes","No"),order=TRUE)
#Michelle's comments on the order of baseMcompletion in the table:the Completed all 4 modules column first then some modules, then no modules. Same for the site specific tables below.
data$baseMcomplt_all <- ifelse(data$basesvcomplt == "All", "Completed all 4 Modules",ifelse(data$basesvcomplt == "None","Did Not Complete Any Modules","Complete Some But Not All 4 Modules"))
data$baseMcomplt_all <- factor(data$baseMcomplt_all,levels=c("Completed all 4 Modules","Complete Some But Not All 4 Modules","Did Not Complete Any Modules"))


data$biospeDonation <- ifelse(data$d_878865966 %in% c(104430631,NA)  & data$d_167958071 %in% c(104430631,NA) & data$d_684635302 %in% c(104430631,NA),"No Sample Donations", ifelse(data$d_878865966 == 353358909 & data$d_167958071 == 353358909 & data$d_684635302 == 353358909,"Completed All 3 Sample Donations", "Completed Some but Not All 3 Sample Donations"))

data$biospeDonation<- factor(data$biospeDonation,levels=c("Completed All 3 Sample Donations", "Completed Some but Not All 3 Sample Donations","No Sample Donations"))

Modbiospe.All <- data %>% filter(d_821247024==197316935 & d_827220437>0) %>% 
  select(baseMcomplt_all,biospeDonation) %>%
  tbl_cross(col = baseMcomplt_all,
            row = biospeDonation,
            label = list(baseMcomplt_all~"Completion of Baseline Surveys",
             biospeDonation ~"Biospecimen Donation" ),
            digits=c(0,2),
            percent = c("cell"),
            missing = "ifany",
            margin_text = "Total Verified Participants",
            missing_text = "(Missing)")  

Modbiospe.All[["table_body"]]$stat_0 <- sapply(strsplit(Modbiospe.All[["table_body"]]$stat_0," "),"[",1)

Modbiospe.All <- Modbiospe.All %>%
  bold_labels() %>%
  #italicize_levels() %>% 
  modify_header() %>%
  modify_caption("Table 14. Completion of Baseline Activities Among Verified Participants for All Sites") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE) 

levels<-levels(droplevels(data[which(data$d_821247024==197316935),]$site))

Modbiospe.site <- list()
for(i in 1:9){
 n<- 14+i
 site  <- data %>% filter(d_821247024==197316935 & site == levels[i]) %>%
    dplyr::select(baseMcomplt_all,biospeDonation) %>%
            tbl_cross(col = baseMcomplt_all,
              row = biospeDonation,
              label = list(baseMcomplt_all ~ "Completion of Baseline Surveys", 
                           biospeDonation ~"Biospecimen Donations"),
              digits=c(0,2),
              percent = "cell",
              missing = "ifany",
              margin_text = "Total Verified Participants",
              missing_text = "(Missing)") 
  
  site[["table_body"]]$stat_0 <- sapply(strsplit(site[["table_body"]]$stat_0," "),"[",1)
  
  site[["table_body"]]$stat_0 <- gsub("NA |(100.00%)", "0",site[["table_body"]]$stat_0)
  
  site[["table_body"]]$stat_1 <- gsub("0 (NA%)", "0 (0 %)",site[["table_body"]]$stat_1)
  site[["table_body"]]$stat_2 <- gsub("0 (NA%)", "0 (0 %)",site[["table_body"]]$stat_2)
  
  site[["table_body"]]$stat_3 <- gsub("0 (NA%)", "0 (0 %)",site[["table_body"]]$stat_3)
 
Modbiospe.site[[i]] <- site %>% 
            bold_labels() %>%
            #modify_header(label ~"Baseline Surveys' Completions") %>%
            modify_caption(paste("Table ", n,". Completion of Baseline Activities Among Verified Participants for ",levels[i],sep="")) %>%
            as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
  #Modbiospe.site[[i]] <- Modbiospe.site
}

#Table 24 Refusal and withdrawals
recruitsites <- as.data.frame(tab1(data[which(data$d_821247024 == 197316935),]$site)[[2]])
recruitsites$site <- ifelse(grepl("Total",rownames(recruitsites)), "Total" , trimws(rownames(recruitsites)))

recruitsites$`Total VerifiedRecruits` <- paste0(recruitsites$Frequency,"(",round(recruitsites$Percent,2), "%)")

dd[grep("657475009",dd$CID),]
#         CID                                                Variable Label          Variable Name
#1: 657475009 Autogenerated date/time for refused baseline specimen surveys HdRef_BlSpecSrvDt_v1r0
act_ls <- colnames(data)[grepl("685002411",colnames(data))]
data$refact <- 0
for (i in 1: length(act_ls)){
  act_c <- ifelse((data[,act_ls[i]]==104430631 | is.na(data[,act_ls[i]])),0,1)
  data$refact <- data$refact + act_c
}
c("d_906417725","d_773707518","d_747006172","d_831041022")

rfact_ls <- c(act_ls,"d_906417725","d_773707518","d_747006172","d_831041022")
data$rfwdact <-0
for (i in 1: length(rfact_ls)){
  rfact_c <- ifelse((data[,rfact_ls[i]]==104430631 | is.na(data[,rfact_ls[i]])),0,1)
  data$rfwdact <- data$rfwdact + rfact_c
}
ref_wd_tb <- data %>% filter(d_230663853 == 353358909 & d_919254129 == 353358909)
ref_wd_tb <- ref_wd_tb[, c("site","d_821247024","d_906417725","d_773707518","d_747006172","d_831041022","refact","rfwdact",act_ls)] 

ref_wd_tb <- ref_wd_tb %>%  mutate(RefAllActiveVerified=ifelse(d_773707518 == 104430631 & d_906417725==353358909  & refact==7, 353358909, 
                                                      ifelse(d_773707518 != 104430631 |d_906417725!=353358909 | refact <7 ,104430631,NA)),
                        RefSomeActiveVerified=ifelse(d_773707518 == 104430631 & d_906417725==353358909 | (refact<7  & refact>0)  , 353358909, 
                                                     ifelse(d_773707518 != 104430631 | (d_906417725 ==353358909 & refact ==7) ,104430631,
                                                     ifelse(d_906417725 ==104430631 & refact ==0 ,104430631, NA))),
                        ref_activity = ifelse(d_906417725==353358909  & refact==7, "Refusal of All Study Activities",
                                          ifelse(d_906417725==104430631  & refact ==0, "None of Study Activities","Refusal of Any Study Activity")),
                        HIPAARevVer = ifelse( d_773707518 == 353358909  & d_747006172 == 104430631 & d_831041022 == 104430631, 353358909,
                                              ifelse( d_773707518 != 353358909  | d_747006172 != 104430631 | d_831041022 != 104430631,104430631, NA)),
                        WdConsentVer = ifelse(d_747006172 == 353358909 & d_831041022 == 104430631, 353358909,
                                              ifelse(d_747006172 != 353358909  | d_831041022 != 104430631,104430631, NA)),
                        DestroyDataVer = ifelse(d_831041022 == 353358909, 353358909, ifelse(d_831041022 != 353358909,104430631, NA)),
                        wd_hipaa_dd = ifelse(d_773707518 == 353358909  & d_747006172 == 353358909 & d_831041022 == 353358909,"Data Destruction", ifelse(d_773707518 == 353358909  & d_747006172 == 353358909 & d_831041022 == 104430631, "Withdraw Consent", ifelse(d_773707518 == 353358909  & d_747006172 == 104430631 & d_831041022 == 104430631,"Revoked HIPAA Authorization",ifelse(d_773707518 == 104430631  & ( d_906417725==353358909 | refact==7),"Refusal of All Study Activities", ifelse(d_773707518 == 104430631  & ( d_906417725==104430631 & refact <=7 & refact>0),"Refusal of Any Study Activity",ifelse(d_906417725==104430631 & refact==0,"None of them",NA)))))))

ref_wd_tb$wd_hipaa_dd <- factor(ref_wd_tb$wd_hipaa_dd, levels=c("Refusal of Any Study Activity","Refusal of All Study Activities","Revoked HIPAA Authorization", "Withdraw Consent", "Data Destruction","None of them"))
ref_wd_tb$ref_activity <- factor(ref_wd_tb$ref_activity,levels=c("Refusal of All Study Activities","Refusal of Any Study Activity","None of Study Activities"))

ref_wd_tb$rewd.cases <- ifelse(ref_wd_tb$refact == 0 & ref_wd_tb$d_906417725==104430631 &  ref_wd_tb$d_773707518==104430631 & ref_wd_tb$d_747006172==104430631 & ref_wd_tb$d_831041022==104430631,104430631,353358909)

##the order should be in this way "Refusal of Any Study Activities Refusal of All Study Activities Revoked HIPAA Authorization Withdrew Consent Data Destruction"

tb_refwd <- ref_wd_tb %>% filter(rewd.cases==353358909) %>%  select(site, wd_hipaa_dd) %>% 
  tbl_cross(col=wd_hipaa_dd,row=site,
                       digits=c(0,2),
            percent = "row",
            label=wd_hipaa_dd ~"Refusal & Withdrawals",
            missing="ifany",
            missing_text="0 (0.00%)",
            margin_text = "Total Consented Recruits") 
  
tb_refwd[["table_body"]]$stat_0 <- sapply(strsplit(tb_refwd[["table_body"]]$stat_0," "),"[",1)

tb_refwd <- tb_refwd %>% 
  modify_header() %>%
  modify_caption("Table 24. Refusals and Withdrawals Among All Consented Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
  
 col_pct <- function(x,y) {paste0(x, " ( ",round(100*x/y,2), "%)")}
refuse.withdrawls <- ref_wd_tb %>% select(site, wd_hipaa_dd) %>% 
  group_by(site, wd_hipaa_dd) %>% dplyr::summarise (count=n())
refuse.withdrawls_w <- dcast(refuse.withdrawls,site~wd_hipaa_dd,v.name="count")
refuse.withdrawls_w$Total <- rowSums(refuse.withdrawls_w[,c(2:5)],na.rm=TRUE)
refuse.withdrawls_w$cases <- rowSums(refuse.withdrawls_w[,c(2:4)],na.rm=TRUE)

Total <- as.data.frame(t(apply(refuse.withdrawls_w[,c(2:7)],2,function(x) sum(x, na.rm=TRUE))))
Total$site <- "Total"
Total$`Refusal of All Study Activities` <- 0
Total$`Revoked HIPAA Authorization` <- 0


refuse.withdrawls_w1 <- refuse.withdrawls_w %>%
  mutate(`Refusal of Any Study Activity` = ifelse(is.na(`Refusal of Any Study Activity`),"0 ( 0.00%)", col_pct(`Refusal of Any Study Activity`,Total)),
         `Withdraw Consent` = ifelse(is.na(`Withdraw Consent`) , "0 ( 0.00%)", col_pct(`Withdraw Consent`,Total)),
          `Data Destruction` = ifelse(is.na(`Data Destruction`),"0 ( 0.00%)", col_pct(`Data Destruction`,Total)),
         cases = ifelse(is.na(cases),"0 ( 0.00%)", col_pct(cases,Total)),
         `Refusal of All Study Activities`  = "0 ( 0.00%)",
         `Revoked HIPAA Authorization` = "0 ( 0.00%)" )
refuse.withdrawls_w1 <- rbind(refuse.withdrawls_w1,Total)

#table25 Reasons for Refusal or Withdrawal Among Those that Requested (Weekly table 23)
refwd_reasons <- c("d_919699172","d_141450621","d_576083042","d_431428747","d_121430614","d_523768810","d_639172801","d_175732191","d_150818546","d_624030581","d_285488731","d_596510649","d_866089092","d_990579614","d_131458944","d_372303208","d_777719027","d_620696506","d_352891568","d_958588520","d_875010152","d_404289911","d_538619788","d_734828170")
refusal1 <- data[which(data$rfwdact >0),c("Connect_ID","token","site","d_827220437","d_153713899","d_613641698","d_715390138",refwd_reasons)]

refusal1$refwdcounts <- 0
ref_reason <- list()
for (i in 1:length(refwd_reasons)){
  refwd.c <- ifelse(refusal1[,refwd_reasons[i]] ==104430631 | is.na(refusal1[,refwd_reasons[i]]), 0, 1)
  refusal1$refwdcounts <- refusal1$refwdcounts + refwd.c
  
  dt <- refusal1[which(refusal1$d_827220437>0 ),c("site",refwd_reasons[i])]
  colnames(dt)[2] <- "refwd_reason"
  dt_c <- dt %>%  dplyr::group_by(site,refwd_reason) %>% dplyr::summarise(count=n()) 

  dt_c_w <- dcast(dt_c,site ~ refwd_reason, value.var = "count")
  colnames(dt_c_w)[which(colnames(dt_c_w)!="site")] <- paste(refwd_reasons[i],colnames(dt_c_w)[which(colnames(dt_c_w)!="site")],sep="_")
  
  ref_reason[[i]] <- dt_c_w
}

#refwd_wd_reasons<- unique(as.data.frame(do.call('rbind',ref_reason[sapply(ref_reason, function(x) dim(x)[2]) >2])))
 list <- ref_reason[sapply(ref_reason, function(x) dim(x)[2]) >2]     
n<-length(list)     

refwd.cases <- filter(refusal1, refwdcounts>0)
refwdcases.site <- as.data.frame(tab1(refwd.cases$site)[[2]])
refwdcases.site$site <- trimws(rownames(refwdcases.site))
refwdcases.site$order <- seq(nrow(refwdcases.site)) 


ref_wd_reasons <- list %>% reduce(full_join,by="site")
#select <- colnames(ref_wd_reasons)[grepl("_353358909|site",colnames(ref_wd_reasons))]
ref_wd_reasons1 <- ref_wd_reasons %>% select(site,ends_with("353358909")) 
ref_wd_reasons1[is.na(ref_wd_reasons1)] <-0
ref_wd_reasons1 <- merge(ref_wd_reasons1,refwdcases.site[,c("site","Frequency","order")], by="site")


col_pct <- function(x,y) {paste0(x, " (",round(100*x/y,2), " %)")}

ref_wd_reasons2 <- ref_wd_reasons1[order(ref_wd_reasons1$order),] %>% mutate(d_919699172_353358909 = col_pct(d_919699172_353358909, Frequency),
                                              d_141450621_353358909 =col_pct(d_141450621_353358909, Frequency),
                                              d_576083042_353358909 =col_pct(d_576083042_353358909,Frequency),
                                              d_431428747_353358909 =col_pct(d_431428747_353358909,Frequency),
                                              d_777719027_353358909 =col_pct(d_777719027_353358909, Frequency),
                                              d_352891568_353358909 = col_pct(d_352891568_353358909, Frequency),
                                              d_958588520_353358909 = col_pct(d_958588520_353358909, Frequency),
                                              d_875010152_353358909 =col_pct(d_875010152_353358909, Frequency),
                                              d_538619788_353358909 =col_pct(d_538619788_353358909,Frequency),
                                              d_734828170_353358909 =col_pct(d_734828170_353358909,Frequency),
                                              site=site)


refwd_reasons.all <- as.data.frame(t(colSums(ref_wd_reasons1[,c(2:12)], na.rm=TRUE )))

refwd_reasons.all$site <- "Total.Reasons"
refwd_reasons.all$order <-10
refwd_reasons.labels <- unique(dd[which(grepl(paste(sapply(strsplit(refwd_reasons,"_"),"[",2),collapse = "|"),dd$CID)),c("CID","Variable Label")])

refwd_reasons.all <- rbind(ref_wd_reasons2,refwd_reasons.all, fill=TRUE)

ref.labels <- dd[grepl(paste(substring(colnames(refwd_reasons.all)[2:10], 3,11),collapse="|"), dd$CID),]$`Variable Label`


ref_wd_reasons_all <- as.data.frame(t(refwd_reasons.all[,c(2:11)]))
colnames(ref_wd_reasons_all) <- refwd_reasons.all$site

ref_wd_reasons_all$CID <- substring(rownames(ref_wd_reasons_all),3,11)
ref_wd_reasons_all1 <- merge(ref_wd_reasons_all, refwd_reasons.labels,by="CID", all.y=TRUE)

ref_wd_reasons_all1[is.na(ref_wd_reasons_all1)] <- replace_na("0 (0%)")
ref_wd_reasons_all1[25,c(2:11) ] <- t(refwd_reasons.all[,12])
ref_wd_reasons_all1$`Variable Label`<- ref_wd_reasons_all1$`Variable Label` %>% tidyr:: replace_na("Total")

colnames(ref_wd_reasons_all1)[12] <- "Refusal&Withdrawal Reasons" 
ref_wd_reasons_all1$Total.Reasons <- sapply(strsplit(ref_wd_reasons_all1$Total.Reasons," "),head,1)
colnames(ref_wd_reasons_all1)[which(colnames(ref_wd_reasons_all1)=="Total.Reasons")] <- "Total Reasons"

###incentive
###Incentive table: Table 26 Baseline Incentive Eligibility for Verified Participants

incentive.CIDs <- sapply(strsplit(as.character(colnames(data)[grepl("d_130371375_d_266600170",colnames(data))]),"d_"),"[", 4)
incentive.vars <- dd[which(grepl(paste(incentive.CIDs,collapse = "|"),dd$CID)),]
incentive.vars$var.names <- paste("d_130371375_d_266600170_d",incentive.vars$CID,sep="_") 

incentive <- data %>% select(Connect_ID,site,d_821247024,d_827220437,incentive.vars$var.names) %>%
    mutate(Incentive_Eligible = case_when(d_130371375_d_266600170_d_731498909 == 353358909 ~ "Incentive Eligible",
                                         d_130371375_d_266600170_d_731498909 == 104430631 ~ "Incentive Not Eligible"),
           Payment_Issued = case_when(d_130371375_d_266600170_d_648936790 == 353358909 ~ "Payment Issued",
                                      d_130371375_d_266600170_d_648936790 == 104430631 ~ "Payment Not Issued"),
           Payment_Refused = case_when(d_130371375_d_266600170_d_648228701 == 353358909 ~ "Payment Refused",
                                      d_130371375_d_266600170_d_648228701 == 104430631 ~ "Payment Not Refused"),
           eligible_time =as.POSIXct(d_130371375_d_266600170_d_787567527),
           issued_time=as.POSIXct(d_130371375_d_266600170_d_297462035),
           declined_time=as.POSIXct(d_130371375_d_266600170_d_438636757)) 
           
incentive$Payment_Issued <- factor(incentive$Payment_Issued, levels=c("Payment Issued","Payment Not Issued"))   
incentive$Payment_Refused <- factor(incentive$Payment_Refused, levels=c("Payment Refused","Payment Not Refused"))

incentive$Tm_issued2eligible <- ifelse(incentive$d_130371375_d_266600170_d_648936790 == 353358909 & incentive$d_130371375_d_266600170_d_731498909==353358909, difftime(incentive$issued_time,incentive$eligible_time,units="day"),NA)

summary(incentive$Tm_issued2eligible)
incentive$Tm_issued2declined <- ifelse(incentive$d_130371375_d_266600170_d_648228701 & incentive$d_130371375_d_266600170_d_731498909==353358909, difftime(incentive$declined_time,incentive$eligible_time,units="day"),NA)

  incentive.eligible <- incentive[which(incentive$d_821247024==197316935),] %>%  select(site,Incentive_Eligible)%>% 
    tbl_cross(col=Incentive_Eligible,
              row=site,
             digits=c(0,2),
            percent = "row",
            label =site ~"Site",
            missing="ifany",
            missing_text="0 (0.00%)",
            margin_text = "Total Verified Participants")


incentive.eligible[["table_body"]]$stat_0 <- sapply(strsplit(incentive.eligible[["table_body"]]$stat_0," "),"[",1)
incentive.eligible <- incentive.eligible %>%
            modify_caption("Table 26. Baseline Incentive Eligibility for Verified Participants")%>% 
  modify_header(stat_0 ="Total Verified\nParticipants") %>%
  modify_spanning_header(update = everything() ~ NA) %>% 
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

Eligible <- incentive %>% filter(Incentive_Eligible=="Incentive Eligible") %>% 
  mutate(Chicago = ifelse(d_827220437 == 809703864,"University of Chicago Medicine", "NORC"),
         incentive=case_when(Payment_Issued == "Payment Issued" & Payment_Refused == "Payment Not Refused" ~ "Incentive Issued",
                             Payment_Issued == "Payment Issued" & Payment_Refused == "Payment Refused" ~ "Incentive Refused",
                             Payment_Issued == "Payment Not Issued" & Payment_Refused == "Payment Refused" ~ "Incentive Refused",
                             Payment_Issued == "Payment Not Issued" & Payment_Refused == "Payment Not Refused" ~ "Incentive Not Issued or Refused"))  %>% mutate(incentive = factor(incentive, levels=c("Incentive Issued","Incentive Refused","Incentive Not Issued or Refused")))%>% select(Chicago,incentive) %>% 
  tbl_cross(col=incentive,
            row =Chicago,
            digits=c(0,2),
            percent = "row",
            label = list(incentive ~"Incentive Status",Chicago ~"Incentive Issued by"),
            missing="ifany",
            missing_text="0 (0.00%)",
            margin_text = "Total Incentive Eligible") 
  
Eligible[["table_body"]]$stat_0 <- sapply(strsplit(Eligible[["table_body"]]$stat_0," "),"[",1)

Eligible <- Eligible %>%
  modify_caption("Table 27. Baseline Incentive Status for Incentive Eligible Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

incentive$Payment_Issued <- factor(incentive$Payment_Issued, levels=c("Payment Issued","Payment Not Issued"))   
incentive$Payment_Refused <- factor(incentive$Payment_Refused, levels=c("Payment Refused","Payment Not Refused"))

incentive$Tm_issued2eligible <- ifelse(incentive$d_130371375_d_266600170_d_648936790 == 353358909 & incentive$d_130371375_d_266600170_d_731498909==353358909, difftime(incentive$issued_time,incentive$eligible_time,units="day"),NA)

incentive$Tm_issued2declined <- ifelse(incentive$d_130371375_d_266600170_d_648228701 & incentive$d_130371375_d_266600170_d_731498909==353358909, difftime(incentive$declined_time,incentive$eligible_time,units="day"),NA)


table28_Tm_IncentIssued <- incentive[complete.cases(incentive[,c("d_130371375_d_266600170_d_787567527","d_130371375_d_266600170_d_297462035")]),] %>% dplyr::filter(d_130371375_d_266600170_d_731498909 == 353358909 & d_130371375_d_266600170_d_648936790 == 353358909) %>% mutate(time=Tm_issued2eligible) %>% group_by(site) %>% dplyr::summarize('Incentives Issued'=n(),
                   min = min(time),
                   q1 = quantile(time, 0.25),
                   median = median(time),
                   mean = mean(time),sd=sd(time),
                   q3 = quantile(time, 0.75),
                   max = max(time))

table28_Tm_IncentIssued.all <- incentive[complete.cases(incentive[,c("d_130371375_d_266600170_d_787567527","d_130371375_d_266600170_d_297462035")]),] %>% dplyr::filter(d_130371375_d_266600170_d_731498909 == 353358909 & d_130371375_d_266600170_d_648936790 == 353358909) %>% mutate(time=Tm_issued2eligible) %>%  dplyr::summarize('Incentives Issued'=n(),
                   min = min(time),
                   q1 = quantile(time, 0.25),
                   median = median(time),
                   mean = mean(time),sd=sd(time),
                   q3 = quantile(time, 0.75),
                   max = max(time))
table28_Tm_IncentIssued.all$site <- "Total"

table28_Tm_IncentIssued <- rbind(table28_Tm_IncentIssued,table28_Tm_IncentIssued.all)

##Table29 (weekly table 5 Previous Cancer d_452166062 title should be updated to Previous Cancer Reported in User Profile among participants submitted profile
#dd[grepl("699625233",dd$CID),]
#         CID         Variable Label         Variable Name
#1: 699625233 User Profile submitted RcrtUP_Submitted_v1r0
# table(data$d_699625233,data$d_452166062)
#            104430631 353358909
#  104430631         0         0
#  353358909      5171        46
col_pct <- function(x,y) {paste0(x, " (",round(100*x/y,2), " %)")}

dt_profile <- data %>% filter(d_699625233==353358909) 
dt_profile <- dt_profile[order(dt_profile$site),] 

cancer.tab <- xtabs(~site+d_452166062+verified,data=dt_profile)
#summary(cancer.tab$Freq)

dt_profile$verified <- factor(dt_profile$verified, levels = c("Cannot be verified","Duplicate","Not yet verified","Verified"))
dt_profile$site<-droplevels(dt_profile$site)
cancer.tab <- xtabs(~site+d_452166062+verified,data=dt_profile)
 cancer.history <- as.data.frame(cancer.tab) 
 
cancer.hx.verif <- reshape(cancer.history[which(cancer.history$d_452166062==353358909),],idvar=c("site","d_452166062"),timevar="verified",direction="wide")
cancer.hx.verif$cancer.total <- apply(cancer.hx.verif[,c(3:6)],1,sum)
total.UP <- cancer.history  %>% group_by(site ) %>% dplyr::summarize(total=sum(Freq))
cancer.hx.verif <- merge(cancer.hx.verif,total.UP,by="site")


cancer.hx.verif[10,c(3:8)] <- apply(cancer.hx.verif[,c(3:8)],2,sum)

cancer.veri.up <- cancer.hx.verif[,c(1,3:8)] 
cancer.veri.up[,c(2:6)] <- apply(cancer.hx.verif[,(3:7)],2,function(x) paste0(x, " (",round(100*x/cancer.hx.verif$total,2), " %)"))
cancer.veri.up <- cancer.veri.up%>% arrange(site)
cancer.veri.up$site <- ifelse(is.na((as.character(cancer.veri.up$site))), "Total Recruits UP Submitted",as.character(cancer.veri.up$site) )

names(cancer.veri.up)[2:5] <- gsub("Freq.","",colnames(cancer.veri.up[2:5]))

##Create a table with Previous Cancer, Cancer Year, Cancer Type, and Cancer Comments on an individual level plus their verification status requested from Nicole and Michelle Please put in a separate report run weekly, call it 'Previous Cancer History' and put it in the _CCC restricted Box folder so Amelia can review on a regular basis.

ca.hist <- dd[grepl("Cancer",dd$`Variable Label`),]
ca.hist
#          CID                Variable Label           Variable Name
# 1: 206879104 Connect website on Cancer.gov   RcrtES_Aware_v1r0_Web
# 2: 266952173                   Cancer Type  RcrtUP_CancerType_v1r0
# 3: 452166062               Previous Cancer      RcrtUP_Cancer_v1r0
# 4: 494982282               Cancer Comments RcrtUP_CancerComts_v1r0
# 5: 525972260            Yes/No Cancer Flag RCAOper_CancerFlag_v1r0
# 6: 547895941           Cancer Status Match RcrtV_CStatusMatch_v1r0
# 7: 650597106                   Cancer Year    RcrtUP_CancerYr_v1r0

ca.var.hist <- colnames(data)[grepl("266952173|452166062|494982282|650597106|547895941",colnames(data))]
ca_hist <- data %>% filter(d_699625233==353358909 & d_452166062 == 353358909 ) %>% select(token,Connect_ID,d_821247024, d_512820379, site, age,sex, race,d_699625233,d_452166062,all_of(ca.var.hist)) %>%mutate(`Verification status`= case_when(d_821247024 == 875007964 ~ "Not yet verified",
                                             d_821247024 == 197316935  ~ "Verified",
                                             d_821247024 ==  219863910 ~ "Cannot be verified",
                                             d_821247024 ==  922622075 ~ "Duplicate",
                                             d_821247024 ==  160161595 ~ "Outreach timed out"),
           `Recruitment type` =case_when(d_512820379 == 486306141 ~ "Active",
                                                d_512820379 == 854703046 ~ "Passive"),
           `User Profile submitted` = case_when(d_699625233 ==353358909 ~ "Yes",
                                                d_699625233 ==104430631 ~ "No"),
           `Previous Cancer` = case_when(d_452166062 ==353358909 ~ "Yes",
                                         d_452166062 ==104430631 ~ "No"),
            RcrtV_CStatusMatch_v1r0 = case_when(state_d_547895941== 539025306 ~ "Criterium not met",
                                               state_d_547895941== 427405444 ~ "Criterium met")) %>% 
  dplyr::rename(`Cancer Year` = d_650597106, `Cancer Type`=d_266952173, `Cancer Comments`= d_494982282)

#Table 30 (weekly table 15.) Sign-In Mechanism Used for First Log On
data$logon <- ifelse(data$d_995036844 == "password", "Email", ifelse(data$d_995036844 == "phone", "Phone",NA))
data$logon <- factor(data$logon,levels=c("Email","Phone"))   

signin_methods1 <- data %>% dplyr::filter(d_230663853==353358909 & d_919254129== 353358909 ) %>% mutate(Site = droplevels(site)) %>%
  select(Site,logon) %>% tbl_cross(
    col = logon,
    row = Site,
    label = list(logon ~"Account Sign-In Mechanism",Site~"Site"),
    percent = "row",
    digits=c(0,2),
    missing = "ifany",
    margin_text = "Total Recruits who Have Signed-In and Consented",
    missing_text = "(Missing)")  

signin_methods1[["table_body"]]$stat_0 <- sapply(strsplit(signin_methods1[["table_body"]]$stat_0," "),"[",1) 

signin_methods1 <- signin_methods1 %>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header(
                stat_0="Total Recruits who Have \nSigned-In and Consented") %>%
  modify_caption("Table 30. Sign-In Mechanism for First Log on") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE) 

#Table 16. How Recruit Heard About Study d_230663853
#/*HOW RECRUIT HEARD ABOUT STUDY*/
#*Creating 0/1 variables for how recruit heard about study;d_142654897

recruitsites <- as.data.frame(tab1(data[which(data$d_827220437>0),]$site)[[2]])
recruitsites$site <- trimws(rownames(recruitsites))

recruitsites <- recruitsites[which(recruitsites$site !="NA"),]
awareness <- colnames(data)[grepl("142654897",colnames(data))] 


aware <- data[which(data$d_230663853==353358909 & data$d_827220437>0),c("Connect_ID","token","d_821247024","site","state_d_158291096",awareness)] 

signinsites <- as.data.frame(tab1(aware$site)[[2]])
signinsites$site <- trimws(rownames(signinsites))


empty_columns <- colSums(is.na(aware) |aware == "") == nrow(aware)
colnames(aware[empty_columns]) 

aware$awarecounts <- 0
for (i in 1:length(awareness)){
  aware.c <- ifelse(aware[,awareness[i]] ==104430631 | is.na(aware[,awareness[i]]), 0, 1)
  aware$awarecounts <- aware$awarecounts + aware.c
}

aware$d_142654897_d_0 <- ifelse(aware$awarecounts==1, 353358909, 104430631 ) #no response sent

CID3 <- sapply(strsplit(as.character(awareness),"d_"),"[",3)
 grab <- y %>% filter(grepl(paste(CID3,collapse = "|"),y$conceptId.3)) %>% select(conceptId.3, Variable.Label)
#grab <- dd %>% filter(grepl(paste(CID3,collapse = "|"),dd$CID)) %>% select(CID, `Variable Label`)

aware_id <- list()
for (i in 1:length(awareness)){
  tmp <- eval(parse(text=paste("pct_tb(aware$site,aware$",awareness[i],")",sep="")))
  #eval(parse(text=paste("tmp <- optout1 %>% group_by(",optout_reason1[1],",site) %>% dplyr::summarise(count=n())",sep="")))
  
  colnames(tmp) <- paste(awareness[i],colnames(tmp))
  tmp$site <- rownames(tmp)
  total <- tmp[10,which(grepl("n_353358909",colnames(tmp)))]
  tmp$col_pct = ifelse(tmp$site!="Total",paste0(tmp[,which(grepl("n_353358909",colnames(tmp)))]," ( ", round(100*tmp[,which(grepl("n_353358909",colnames(tmp)))]/total,2), "%)"),format(total,big.mark=","))
  names(tmp)[as.numeric(ncol(tmp))] <- paste(awareness[i],"col_npct")
  aware_id[[i]] <- as.data.frame(tmp)
}

aware.n <- pct_tb(aware$site,aware$d_142654897_d_0)
total <- aware.n$n_353358909[10]
aware.n$site <- rownames(aware.n)
aware.n$col_npct<- ifelse(aware.n$site!="Total", paste0(aware.n$n_353358909," ( ", round(100*aware.n$n_353358909/total,2)," %)"),format(total,big.mark=","))
colnames(aware.n) <- paste("d_142654897_d_0",colnames(aware.n))
awares <-  aware_id %>% reduce(full_join, by='site') 
awares$order <- rownames(awares)
awares1 <-merge(awares,aware.n,by.x='site',by.y='row.names')

awares1 <- merge(awares1,signinsites,by.x="site",by.y="site", all.y=TRUE) #variables=121
awares2 <- awares1[order(as.numeric(awares1$order)),which(grepl("col_npct",colnames(awares1))| colnames(awares1) %in% c("site","Frequency"))] #row percent of each reason

awares0 <- awares1[order(as.numeric(awares1$order)),which(grepl("n_3533589090",colnames(awares1)) | colnames(awares1) %in% c("site","Frequency"))]
awares1 <- awares1[order(as.numeric(awares1$order)),which(grepl("n_pct_353358909",colnames(awares1)) | colnames(awares1) %in% c("site","Frequency"))] #column percent within each site

awares1_transpose <- as.data.frame(t(awares1[,c(2:22)]))
colnames(awares1_transpose) <- awares1$site

awares2_transpose <- as.data.frame(t(awares2[,c(2:22)]))
colnames(awares2_transpose) <- awares2$site


awares1_transpose$CID <- ifelse(grepl("n_pct_353358909",rownames(awares1_transpose)), trimws(gsub("n_pct_353358909|d_142654897_d_","", rownames(awares1_transpose))), NA)
#awares1_transpose$awares_ids <- ifelse(grepl("n_pct_353358909",rownames(awares1_transpose)), gsub(" n_pct_353358909|d_142654897_d_","", rownames(awares1_transpose)), "Total")

##column percent within each site
Table31_awaresreasons <- merge(dd[,c("CID","Variable Label")],awares1_transpose,by.x="CID",by.y="CID",all.y=TRUE)

Table31_awaresreasons$Awareness <- ifelse(is.na(Table31_awaresreasons$CID),"Total SignedIn",ifelse(Table31_awaresreasons$CID == 0, "No Response Sent",Table31_awaresreasons$`Variable Label`))
Table31_awaresreasons <- Table31_awaresreasons[order(Table31_awaresreasons$CID),]

###row percent of each reason
awares2_transpose$CID <- ifelse(grepl("col_npct",rownames(awares2_transpose)), trimws(gsub("col_npct|d_142654897_d_","", rownames(awares2_transpose))), NA)

#awares2_transpose$awares_ids <- ifelse(grepl("n_pct_353358909",rownames(awares2_transpose)), gsub(" n_pct_353358909|d_142654897_d_","", rownames(awares2_transpose)), "Total")

Table31b_awaresreasons <- merge(dd[,c("CID","Variable Label")],awares2_transpose,by.x="CID",by.y="CID",all.y=TRUE)
Table31b_awaresreasons$Awareness <- ifelse(is.na(Table31b_awaresreasons$CID),"Total Recruits",ifelse(Table31b_awaresreasons$CID == 0, "No Response Sent",Table31b_awaresreasons$`Variable Label`))
Table31b_awaresreasons <- Table31b_awaresreasons[order(Table31b_awaresreasons$CID),]


data$active_camptype <- factor(data$active_camptype, levels=c("Aging out of study","Demographic Group", "Geographic group","Non-screening appointment", "None of these apply", "Random","Screening appointment", "Post-screening appointment", "Technology adapters",  "Low-income/health professional shortage areas", "Other", "NA/Unknown"))


#Table 32(Weekly table 8). Total Number of Active Recruits in Campaign
data$active_camptype <- droplevels(data$active_camptype)
data$active_camptype <- factor(data$active_camptype, levels=c("Aging out of study","Demographic Group", "Geographic group","Non-screening appointment", "Random","Screening appointment", "Other", "None of these apply"))
table32_Totalactivecamp <-  data %>% filter(d_512820379 == 486306141 & d_827220437 >0) %>% 
  mutate(active_camptype = droplevels(active_camptype)) %>% 
  select(site, active_camptype) %>% tbl_cross( row=site,
    col = active_camptype,
    label=list(active_camptype~"Campaign Type of Active Recruits", site~"Site"),
    percent = "row",
    digits=c(0,2),
    missing = "no",
    margin_text="Total Active Recruits") 

table32_Totalactivecamp[["table_body"]]$stat_0 <- sapply(strsplit(table32_Totalactivecamp[["table_body"]]$stat_0," "),"[",1) 

    
table32_Totalactivecamp <- table32_Totalactivecamp %>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header( 
    'stat_1' = 'Aging out of Study',
    'stat_2' = 'Demographic Group',
    'stat_3' = 'Geographic Group',
    'stat_4' = 'Non-screening Appointment',
    'stat_5' = 'Random',  
    'stat_6' = 'Screening Appointment',
    'stat_7' = 'Other',
    'stat_8' = 'None of These Apply') %>%
  modify_caption("Table 32. Total Number of Active Recruits in Campaign") %>%
  modify_footnote(all_stat_cols() ~ "Frequency (%) of Total Active Recruits") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

table32_Totalactivecamp

#Table 33 (Weekly Table 9). Number ratio of the success campaign verified among recruits
 ##for successul active campaign recrruits as the active verified by each campaign type 
#data$active_camptype <- factor(data$active_camptype,levels=c("Random","Screening appointment","Non-screening appointment","Demographic Group","Aging out of study","Geographic group","Post-screening appointment","Technology adapters","Low-income/health professional shortage areas","Other","None of these apply","NA/Unknown"))

#data$active_camptype <- droplevels(data$active_camptype)

campaign.site <- NULL
type0 <- levels(droplevels(data[which(data$d_827220437>0 & data$d_512820379 == 486306141),]$active_camptype))
for(site in unique(data[which(data$d_827220437>0),]$site)){
  
  subs <- data[which(data$site == site & data$d_512820379 == 486306141 & data$d_827220437>0 ),]
  Total <- as.numeric(nrow(subs)) ##active recruits per site
  
  subs$active_camptype <- droplevels(subs$active_camptype)
  campaign <- CrossTable(subs$Rcrt_Verified_v1r0,subs$active_camptype) 
  
  tb_cr <- as.data.frame(cbind(campaign$t,campaign$prop.col))
  n.col <- as.numeric(ncol(tb_cr)) 
  
  if(ncol(tb_cr)==2){colnames(tb_cr)[2] <- paste(colnames(tb_cr)[2],"perc",sep="_")
    tb_cr[,2]<- unlist(lapply(tb_cr[,2],function(x) paste0(round(100*x,2), " %")))}
  else if(ncol(tb_cr)>2){colnames(tb_cr)[(1+n.col/2):n.col] <- paste(colnames(tb_cr),"perc",sep="_")
    tb_cr[,c((1+n.col/2):n.col)]<- lapply(tb_cr[,c((1+n.col/2):n.col)],function(x) paste0(round(100*x,2), " %"))}
  
  missing <- type0[which(type0 %nin% levels(subs$active_camptype))]
  for (i in 1:length(missing)){
    tb_cr[,(n.col+2*i-1)] <- 0
    tb_cr[,(n.col+2*i)] <- "0.00 %"
    colnames(tb_cr)[(n.col+2*i-1):(n.col+2*i) ] <- c(missing[i], paste0(missing[i],"_perc"))
  }
  tb_cr$Site <- droplevels(unique(subs$site))
  verified.tb <-as.data.frame(tb_cr[which(rownames(tb_cr)==353358909),])
  verified.tb$Total <- Total
  campaign.site <- rbind(campaign.site,verified.tb)
  
}
  total.veri_pct <- pct_tb(data[which(data$d_512820379==486306141),]$active_camptype,     data[which(data$d_512820379==486306141),]$Rcrt_Verified_v1r0)
       act.veri.camp <- as.data.frame(t(c(total.veri_pct$n_353358909[1:8],paste0(round(100*total.veri_pct$pct_353358909[1:8],2)," %"))))
       colnames(act.veri.camp)[1:8] <- rownames(total.veri_pct)[1:8]
       colnames(act.veri.camp)[9:16] <- paste0(rownames(total.veri_pct)[1:8],"_perc")
       act.veri.camp$Site <- "Total Active Recruits"
       act.veri.camp$Total <- sum(total.veri_pct$n_104430631,total.veri_pct$n_353358909)/2
       campaign.combo <- rbind(campaign.site,act.veri.camp)

new_order <- sort(colnames(campaign.combo))
campaign.combo <- campaign.combo[,new_order]
campaign.combo$order <- seq(rownames(campaign.combo))
colnames(campaign.combo)[18] <- "Total Active Recruits"



#Mar.10, as Michelle reminded "those recruits with both Opt_out flag=Yes and consent=Yes should be excluded from the opt-out tables Table 6. and Table 7
#Table 34 and 35 (equally weekly table 6 and 7): total number of opt-outs by site

#Table 8. Pre-Consent Opt-Out Reasons Among Those that Opted Out  #d_706283025
#among RcrtSI_OptOut_v1r0 (158291096)= 353358909 AND RcrtSI_RecruitType_v1r0 = 486306141
optout_reasons <- colnames(data)[grepl("706283025",colnames(data))]  #35
optout_reasons <- optout_reasons[-16] #to remove "d_706283025_d_415693436" character outputs #34
optout_reasons <- optout_reasons[!grepl("415693436",optout_reasons)]


optout <- data[which(data$d_512820379==486306141 & data$state_d_158291096==353358909 & data$d_919254129 %in% c(104430631,NA)),c("Connect_ID","token","d_821247024","site","state_d_158291096",optout_reasons)] #4374 variable=41
empty_columns <- colSums(is.na(optout) |optout == "") == nrow(optout)

optout1 <- optout[!empty_columns] #32 columns #34 columns(02/21/2023)
#optout1$site <- droplevels(optout1$site)
optout1 <- optout1[order(optout1$site),]

optout1_sites <- data %>% filter(d_512820379==486306141 & d_827220437>0 & data$d_919254129 %in% c(104430631,NA)) %>% select(site, state_d_158291096)

optout1.sites <- pct_tb(optout1_sites$site, optout1_sites$state_d_158291096)
total <- sum(optout1.sites[,3]+ optout1.sites[,4])/2
optout1.sites$"Total.Active" <- format(optout1.sites[,3]+optout1.sites[,4],big.mark=",")
optout1.sites$prop_tb_353358909 <- round(100*optout1.sites[,4]/total,2)

optout1.sites <- optout1.sites %>%  mutate(site = trimws(rownames(optout1.sites)),
         order=seq(rownames(optout1.sites)))

optout1.sites[,c(9,4,8,7)]
#site = gsub("\\.","\\ \\", gsub("X\\..","", rownames(optout1_sites))) 
#optout_reason1 <- colnames(optout1.sites)[c(6:17,19:32)]
optout_reason1 <- colnames(optout1)[c(5:38)]
#optout_reason1 <- colnames(optout1)[c(6:17,19:32)]
opt_id <- list()
for (i in 1:length(optout_reason1)){
  tmp <- eval(parse(text=paste("pct_tb(optout1$site,optout1$",optout_reason1[i],")",sep="")))
  colnames(tmp) <- paste(optout_reason1[i],colnames(tmp))
  tmp$site <- rownames(tmp)
  opt_id[[i]] <- as.data.frame(tmp)
}

optouts_all <-  opt_id %>% purrr::reduce(full_join, by='site') 

optouts1_all <- merge(optouts_all,optout1.sites[,c("site","n_353358909","order")],by.x="site",by.y="site", all.y=TRUE)

optouts1_all <- optouts1_all[order(optouts1_all$order),]
optouts1_all <- optouts1_all[,which(grepl("n_pct_353358909",colnames(optouts1_all)) | colnames(optouts1_all) %in% c("site","n_353358909"))]
optouts1_all[is.na(optouts1_all)] = "0 (0.00%)"
#unique(opt_long1[,c("optout_types","Variable.Label")])

optouts1_transpose <- as.data.frame(t(optouts1_all[,c(2:as.numeric(ncol(optouts1_all)))]))
colnames(optouts1_transpose) <- optouts1_all$site

optouts1_transpose$CID <- ifelse(grepl("state_d_706283025_d_",rownames(optouts1_transpose)), gsub(" n_pct_353358909|state_d_706283025_d_","", rownames(optouts1_transpose)), "Total")
# optouts1_transpose$optout_ids <- ifelse(grepl("n_pct_353358909",rownames(optouts1_transpose)), gsub(" n_pct_353358909|state_d_706283025_d_","", rownames(optouts1_transpose)), "Total")
#optouts1_transpose$CID <- as.integer(optouts1_transpose$CID)
grab <- y %>% filter(grepl(paste(optouts1_transpose$CID,collapse = "|"),y$conceptId.3)) %>% 
  select(conceptId.3,`Variable.Label`) %>% dplyr::rename(CID=conceptId.3)


Table36_optreasons <- merge(grab,optouts1_transpose,by.x="CID",by.y="CID",all.y=TRUE)
colnames(Table36_optreasons)[c(2,12)] <- c("Opt-Out Reasons","Total Opt-Outs")

Table36_optreasons$`Total Opt-Outs` <- sapply(strsplit(Table36_optreasons$`Total Opt-Outs`, " "), "[[",1)

Table36_optreasons[34,2] <- "Total Opt-Outs"
#optout_reason1 <- colnames(optout1.sites)[c(6:17,19:32)]

##to remove the "Signed-In and Consent submittd" (unusual one, mistaken ones for QC)
 data$CSSigned <- factor(data$CSSigned, levels=c("Never Signed-In","Signed-In, no Consent"))
    Table35_precst_act1 <- data %>% dplyr::filter(d_512820379==486306141& state_d_158291096 == 353358909 & d_827220437>0) %>% 
      dplyr:: select(site, CSSigned) %>% tbl_cross(
        row = site,
        col = CSSigned,
        label = list(CSSigned ~ "Timing of Opt-Out",site~"Site"),
        percent = "row",
        digits = c(0,2),
        missing = "no",
        missing_text = "0 (0 %)",
        margin_text = "Total Pre-consent Opt-Outs") 
 
  
    Table35_precst_act1[["table_body"]]$stat_0 <- sapply(strsplit(Table35_precst_act1[["table_body"]]$stat_0," "),"[",1) 

    
 Table35_precst_act1 <- Table35_precst_act1 %>%
      #bold_labels() %>%
      #italicize_levels() %>% 
      modify_header(stat_0="Total Pre-consent \nOpt-Outs",
                    stat_1 = "Never \n Signed-In",
                    stat_2 = "Signed-In,\n No Consent") %>%
      modify_caption("Table 35.  Timing of Pre-Consent Opt-Outs Among Active Recruits") %>%
      as_kable_extra(escape = FALSE, addtl_fmt = TRUE) 

 Table35_precst_act1 <- gsub("NA","0", Table35_precst_act1 )  
 
#Table 4. Current Status in Workflow Total
 data$recrt_steps_v1r0 <-factor(data$recrt_steps_v1r0,levels=c("Never Signed-In","Signed-in, No Consent","Consented, No Profile", "Profile, Verification Incomplete","Verification Complete"))

    work_flow_a <- data  %>% filter(d_827220437>0) %>% select(site, recrt_steps_v1r0)  %>% arrange(site,recrt_steps_v1r0) %>% 
      mutate(site=droplevels(site)) %>% tbl_cross(
       row = site,
       col = recrt_steps_v1r0,
       percent = "column",
       missing="no",
       missing_text = "0 (0.00 %)",
       digits=c(0,2),
       label= list(recrt_steps_v1r0 ~ "Work Flow",site~"Site"),
       margin_text="Total Recruits") 
    

    work_flow_a[["table_body"]]$stat_0 <- sapply(strsplit(work_flow_a[["table_body"]]$stat_0," "),"[",1)
   
    work_flow_a <- work_flow_a%>%
      #bold_labels() %>%
      #italicize_levels() %>% 
      modify_header() %>%
      modify_caption("Table 37. Current Status in Workflow All Recruits") %>%
      as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
  
   work_flow_a  <- gsub("NA","0", work_flow_a )  
   
    work_flow_act <- data[which(data$d_512820379 == 486306141),] %>% mutate(site=droplevels(site)) %>% 
      dplyr::arrange(site,recrt_steps_v1r0) %>% select(site, recrt_steps_v1r0) %>% tbl_cross(
      row = site,
      col = recrt_steps_v1r0,
      label = list(recrt_steps_v1r0~ "Work Flow",site~"Site"),
      percent = "column",
      digits=c(0,2),
      margin_text = "Total Active Rescruits",
      missing="no",
      missing_text = "0 ( 0%)") 
    
    work_flow_act[["table_body"]]$stat_0 <- sapply(strsplit(work_flow_act[["table_body"]]$stat_0," "),"[",1)
    work_flow_act <- work_flow_act%>%
      #bold_labels() %>%
      #italicize_levels() %>% 
      modify_header() %>%
      modify_caption("Table 38. Current Status in Workflow Active Recruits Only") %>%
      as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
    work_flow_act  <- gsub("NA","0", work_flow_act )  
    
    work_flow_pass <- data[which(data$d_512820379 == 854703046 & data$d_827220437>0),] %>% 
      dplyr::arrange(site,recrt_steps_v1r0) %>% select(site, recrt_steps_v1r0) %>% tbl_cross(
      row = site,
      col = recrt_steps_v1r0,
      label = list(recrt_steps_v1r0  ~ "Work Flow", site~"Site"),
      percent = "column",
      digits=c(0,2),
      margin_text="Total Passive Recruits",
      missing="ifany",
      missing_text = "0 (0%)") 
    
    work_flow_pass[["table_body"]]$stat_0 <- sapply(strsplit(work_flow_pass[["table_body"]]$stat_0," "),"[",1)
    work_flow_pass[["table_body"]]$stat_1 <- gsub("NA", "0", work_flow_pass[["table_body"]]$stat_1)
    work_flow_pass <- work_flow_pass %>%
      #bold_labels() %>%
      #italicize_levels() %>% 
      modify_header() %>%
      modify_caption("Table 39. Current Status in Workflow Passive Recruits Only") %>%
      as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
    
   work_flow_pass  <- gsub("NA","0", work_flow_pass )  
   
#Table 10. Time from Active Recruitment to Sign In
#TIME TO COMPLETION OF ENROLLMENT FOR CCC WEEKLY REPORT (ALL SITES) TmFrmActRecToSignIn2 = RcrtSI_SignTime_v1r0 (335767902) - RcrtSI_TypeTime_v1r0 (471593703)
recruit.times <- c("d_335767902","d_471593703","d_454445267","d_430551721","d_914594314")
recruit_timing <- data[,c("token","Connect_ID","d_827220437","d_821247024","d_230663853","d_512820379","d_699625233","d_919254129","site","recruit_type",recruit.times)]
                          
recruit_timing$recru_time <- ymd_hms(recruit_timing$d_471593703) #entering recruits start time
recruit_timing$signin_time <- ymd_hms(recruit_timing$d_335767902) #sign-in time (step2)
recruit_timing$consent_time <- ymd_hms(recruit_timing$d_454445267) #submit consent form (step3)
recruit_timing$profile_time <- ymd_hms(recruit_timing$d_430551721)  #submit profile (step4)
recruit_timing$verified_time <- ymd_hms(recruit_timing$d_914594314) #final verified (step5)

recruit_timing$tm_recr_signin <- difftime(recruit_timing$signin_time,recruit_timing$recru_time,units="days")
recruit_timing$tm_signin_cst <- difftime(recruit_timing$consent_time,recruit_timing$signin_time,units="mins")
recruit_timing$tm_consent_prof <- difftime(recruit_timing$profile_time,recruit_timing$consent_time,units="mins")
recruit_timing$tm_prof_verif <- difftime(recruit_timing$verified_time,recruit_timing$profile_time,units="days")

Act_signin <-  recruit_timing %>% 
  filter(d_512820379 == 486306141 & d_827220437 >0 & d_230663853==353358909)  %>% dplyr::select(tm_recr_signin,site) %>%
  group_by(site) %>% tally()
Act_signin$order <- rownames(Act_signin)
##Table 12 time from recruitment to Sign in
table40_Tm_recr_sign1 <- recruit_timing %>% filter(d_512820379 == 486306141 & d_827220437 >0 & d_230663853==353358909 & tm_recr_signin>= 0 ) %>% 
  mutate(time = as.numeric(tm_recr_signin),
         site = droplevels(site)) %>% # Summary by group using dplyr
  group_by(site) %>% 
  dplyr::summarize(`Number Signed In`=n(),
           tibble(min = min(time),
            q1 = quantile(time, 0.25),
            median = median(time),
            mean = mean(time),sd=sd(time),
            q3 = quantile(time, 0.75),
            max = max(time)))

table40_Tm_recr_sign.total <- recruit_timing %>% filter(d_512820379 == 486306141 & d_827220437 >0 & d_230663853==353358909 & tm_recr_signin>= 0 ) %>% 
  mutate(time = as.numeric(tm_recr_signin),
         site = droplevels(site)) %>% 
  dplyr::summarize(`Number Signed In`=n(),
            min = min(time),
            q1 = quantile(time, 0.25),
            median = median(time),
            mean = mean(time),sd=sd(time),
            q3 = quantile(time, 0.75),
            max = max(time))

table40_Tm_recr_sign.total$site <- "Total"
table40_Tm_recr_sign <- rbind(table40_Tm_recr_sign1,table40_Tm_recr_sign.total)
colnames(table40_Tm_recr_sign)[2] <- "Total Active Sign-In"
table40_Tm_recr_sign$`Recruitment Type` <- "Active"
table40_Tm_recr_sign <- table40_Tm_recr_sign %>% dplyr::rename(Site=site)

length(recruit_timing[which(recruit_timing$tm_recr_signin < 0 & recruit_timing$d_512820379 == 486306141  & recruit_timing$d_230663853==353358909),c("Connect_ID","token","d_821247024","d_230663853","d_512820379","d_335767902","d_471593703","tm_recr_signin")])

#Table 13. Time from Sign In to Consent
library(hms)
signin_cst_tm <- recruit_timing %>% filter (d_827220437 >0 & 
                                                    d_230663853==353358909 & d_919254129== 353358909)
signin_cst_type <- as.data.frame(CrossTable(signin_cst_tm$d_512820379,signin_cst_tm$site)$t)

table41_Tm_signin_cst <- recruit_timing %>% filter( d_827220437 >0 & 
                                                    d_230663853==353358909 & d_919254129== 353358909 & tm_signin_cst>=0 ) %>% 
  mutate(time = as.numeric(tm_signin_cst),
         site = droplevels(site)) %>% # Summary by group using dplyr, to make the time units as hours
  group_by(d_512820379) %>% 
  dplyr::summarize(`Number Consent`=n(),
                   min = min(time),
                   q1 = quantile(time, 0.25),
                   median = median(time),
                   mean = mean(time),sd=sd(time),
                   q3 = quantile(time, 0.75),
                   max = max(time))

table41_Tm_signin_cst$site <- "Total"
table41_Tm_signin_cst$recruitment_type <- ifelse(table41_Tm_signin_cst$d_512820379 == 486306141, "Active", ifelse(table41_Tm_signin_cst$d_512820379 ==854703046,"Passive", "Not Active"))

table41_Tm_signin_cst_errors <- recruit_timing%>% filter (d_827220437 >0 & 
                                                    d_230663853==353358909 & d_919254129== 353358909 & tm_signin_cst<0 )


table41_Tm_signin_cst.act <- recruit_timing %>% filter(d_512820379 == 486306141 & d_827220437 >0 & 
                                                    d_230663853==353358909 & d_919254129== 353358909 & tm_signin_cst>=0  ) %>% 
  mutate(time = as.numeric((tm_signin_cst)),
         site = droplevels(site)) %>% # Summary by group using dplyr, to make the time units as hours
  group_by(site) %>% 
  dplyr::summarize(`Number Consent`=n(),
                   min = min(time),
                   q1 = quantile(time, 0.25),
                   median = median(time),
                   mean = mean(time),sd=sd(time),
                   q3 = quantile(time, 0.75),
                   max = max(time))


table41_Tm_signin_cst.act <- rbind(table41_Tm_signin_cst.act,table41_Tm_signin_cst[which(table41_Tm_signin_cst$recruitment_type=="Active"),c(2:10)])
table41_Tm_signin_cst.act$order <- rownames(table41_Tm_signin_cst.act)

table41_Tm_signin_cst.act1 <- merge(signin_cst_type[which(signin_cst_type$x==486306141),], table41_Tm_signin_cst.act, by.x="y",by.y="site",all.y=TRUE)

table41_Tm_signin_cst.act1$recruitment_type <- "Active"
table41_Tm_signin_cst.act1 <- table41_Tm_signin_cst.act1[order(table41_Tm_signin_cst.act1$order),c(1,13,4:11)] ##remove the actual n of signin to consent
colnames(table41_Tm_signin_cst.act1)[1:3] <- c("Site","Recruitment Type","Number Consent")
table41_Tm_signin_cst.act1 <- table41_Tm_signin_cst.act1[order(as.numeric(rownames(table41_Tm_signin_cst.act1))),]


table41_Tm_signin_cst.pas <- recruit_timing %>% 
  filter(d_512820379 == 854703046 & d_827220437 >0 & d_230663853==353358909 & d_919254129== 353358909 & tm_signin_cst >=0
         ) %>% 
  mutate(time = as.numeric(tm_signin_cst),
         site = droplevels(site)) %>% # Summary by group using dplyr, to make the time units as hours
  group_by(site) %>% 
  dplyr::summarize(`Number Consent`=n(),
                   min = min(time),
                   q1 = quantile(time, 0.25),
                   median = median(time),
                   mean = mean(time),sd=sd(time),
                   q3 = quantile(time, 0.75),
                   max = max(time))
                   
table41_Tm_signin_cst.pas <- rbind(table41_Tm_signin_cst.pas,table41_Tm_signin_cst[which(table41_Tm_signin_cst$recruitment_type=="Passive"),c(2:10)])
table41_Tm_signin_cst.pas$order <- as.numeric(rownames(table41_Tm_signin_cst.pas))

table41_Tm_signin_cst.pas <- merge(signin_cst_type[which(signin_cst_type$x==854703046),], table41_Tm_signin_cst.pas, by.x="y",by.y="site", all.y=TRUE)

table41_Tm_signin_cst.pas$recruitment_type <- "Passive"
table41_Tm_signin_cst.pas$Freq <- ifelse(is.na(table41_Tm_signin_cst.pas$Freq), sum(signin_cst_type[which(signin_cst_type$x==854703046),]$Freq),table41_Tm_signin_cst.pas$Freq )
table41_Tm_signin_cst.pas1 <- table41_Tm_signin_cst.pas[order(as.numeric(table41_Tm_signin_cst.pas$order)),c(1,13,3:11)]
colnames(table41_Tm_signin_cst.pas1)[1:3] <- c("Site","Recruitment Type","Total Consent")

length(recruit_timing[which(is.na(recruit_timing$tm_signin_cst) & recruit_timing$d_512820379 == 854703046  & recruit_timing$d_230663853==353358909 & recruit_timing$d_919254129== 353358909),c("Connect_ID","token","d_821247024","d_230663853","d_512820379","d_335767902","d_454445267","tm_signin_cst")])

#Table 12. Time from Consented to UP Submitted
length(recruit_timing[which(recruit_timing$tm_consent_prof < 0 & recruit_timing$d_230663853==353358909  & recruit_timing$d_919254129==353358909 & recruit_timing$d_699625233== 353358909),c("Connect_ID","token","d_821247024","d_230663853","d_512820379","d_454445267","d_430551721","tm_consent_prof")])

cst_prof <-  recruit_timing %>% 
  filter(d_827220437 >0 & d_230663853==353358909 & d_919254129== 353358909 & d_699625233 == 353358909)  %>% dplyr::select(d_512820379,site) %>%  group_by(d_512820379,site) %>% tally()

table42_Tm_consent_prof <- recruit_timing %>% filter( d_827220437 >0 & d_230663853==353358909 &
                                         d_919254129== 353358909 & d_699625233 == 353358909 & !is.na(tm_consent_prof) ) %>% 
  mutate(time = as.numeric(tm_consent_prof),
         site = droplevels(site)) %>% # Summary by group using dplyr, to make the time units as hours
  group_by(d_512820379) %>% 
  dplyr::summarize(Number.User.Profile.Submitted=n(),
                   min = min(time),
                   q1 = quantile(time, 0.25),
                   median = median(time),
                   mean = mean(time),sd=sd(time),
                   q3 = quantile(time, 0.75),
                   max = max(time))


table42_Tm_consent_prof$site <- "Total"
table42_Tm_consent_prof$recruitment_type <- ifelse(table42_Tm_consent_prof$d_512820379==486306141, "Active", ifelse(table42_Tm_consent_prof$d_512820379 ==854703046,"Passive", "Not Active"))

table42_Tm_consent_prof.act <- recruit_timing %>% filter(d_512820379 == 486306141 & d_827220437 >0 & d_230663853==353358909 &
                                         d_919254129== 353358909 & d_699625233 == 353358909 & !is.na(tm_consent_prof) ) %>% 
  mutate(time = as.numeric(tm_consent_prof),
         site = droplevels(site)) %>% # Summary by group using dplyr, to make the time units as hours
  group_by(site) %>% 
  dplyr::summarize(Number.User.Profile.Submitted=n(),
                   min = min(time),
                   q1 = quantile(time, 0.25),
                   median = median(time),
                   mean = mean(time),sd=sd(time),
                   q3 = quantile(time, 0.75),
                   max = max(time)
                   )
table42_Tm_consent_prof.act <- rbind(table42_Tm_consent_prof.act,table42_Tm_consent_prof[which(table42_Tm_consent_prof$recruitment_type=="Active"),c(2:10)])
table42_Tm_consent_prof.act$order <- rownames(table42_Tm_consent_prof.act)

table42_Tm_consent_prof.act1 <- merge(cst_prof[which(cst_prof$d_512820379 == 486306141),],table42_Tm_consent_prof.act,by.x="site",by.y="site", all.y=TRUE)


table42_Tm_consent_prof.act1$d_512820379  <- "Active" 
table42_Tm_consent_prof.act1<- table42_Tm_consent_prof.act1 %>% arrange(as.numeric(order))
colnames(table42_Tm_consent_prof.act1)[2] <- "Recruitment Type"
colnames(table42_Tm_consent_prof.act1)[4] <- "Number UP to Submit"
table42_Tm_consent_prof.act1 <- table42_Tm_consent_prof.act1 %>% dplyr::rename(Site=site)

table42_Tm_consent_prof.pas <- recruit_timing %>% filter(d_512820379 == 854703046 & d_827220437 >0 & d_230663853==353358909 &
                                   d_919254129== 353358909 & d_699625233 == 353358909 & !is.na(tm_consent_prof ) ) %>% 
  mutate(time = as.numeric(tm_consent_prof),
         site = droplevels(site)) %>% # Summary by group using dplyr, to make the time units as hours
  group_by(site) %>% 
  dplyr::summarize(Number.User.Profile.Submitted=n(),
                   min = min(time),
                   q1 = quantile(time, 0.25),
                   median = median(time),
                   mean = mean(time),sd=sd(time),
                   q3 = quantile(time, 0.75),
                   max = max(time))

table42_Tm_consent_prof.pas <- rbind(table42_Tm_consent_prof.pas,table42_Tm_consent_prof[which(table42_Tm_consent_prof$recruitment_type=="Passive"),c(2:10)])
table42_Tm_consent_prof.pas$order <- rownames(table42_Tm_consent_prof.pas)
table42_Tm_consent_prof.pas <- merge(cst_prof[which(cst_prof$d_512820379 == 854703046),],table42_Tm_consent_prof.pas,by.x="site",by.y="site", all.y=TRUE)

table42_Tm_consent_prof.pas$d_512820379 <- "Passive"
table42_Tm_consent_prof.pas<- table42_Tm_consent_prof.pas %>% arrange(as.numeric(order) )
colnames(table42_Tm_consent_prof.pas)[2] <- "Recruitment Type"
colnames(table42_Tm_consent_prof.pas)[4] <- "Number UP to Submit"
table42_Tm_consent_prof.pas <- table42_Tm_consent_prof.pas %>% dplyr::rename(Site=site)

#Table 13. Time from UP Submitted to Verification Complete
length(recruit_timing[which(recruit_timing$tm_prof_verif < 0 & recruit_timing$d_230663853==353358909  & recruit_timing$d_919254129==353358909 & recruit_timing$d_699625233== 353358909 & recruit_timing$d_821247024 != 875007964),c("Connect_ID","token","d_821247024","d_230663853","d_512820379","d_914594314","d_430551721","tm_prof_verif")])

prof_verif <- recruit_timing %>% filter(d_827220437 >0 & d_230663853==353358909 & d_919254129== 353358909 & d_699625233 == 353358909 & d_821247024 != 875007964 ) %>% dplyr::rename(Site=site) %>% group_by(d_512820379,Site) %>% tally()

table43_Tm_prof_verif <- recruit_timing %>% filter( d_827220437 >0 & d_230663853==353358909 & d_919254129== 353358909 & d_699625233 == 353358909 & d_821247024 != 875007964 & tm_prof_verif>0) %>% 
  mutate(time = as.numeric(tm_prof_verif),
         Site = droplevels(site)) %>% # Summary by group using dplyr, to make the time units as hours
  group_by(d_512820379 ) %>% 
  dplyr::summarize('Number to Verification Completion' = n(),
                   min = min(time),
                   q1 = quantile(time, 0.25),
                   median = median(time),
                   mean = mean(time),sd=sd(time),
                   q3 = quantile(time, 0.75),
                   max = max(time))
table43_Tm_prof_verif$Site <- "Total"
table43_Tm_prof_verif$recruitment_type <- ifelse(table43_Tm_prof_verif$d_512820379==486306141, "Active", ifelse(table43_Tm_prof_verif$d_512820379 ==854703046,"Passive", "Not Active"))


table43_Tm_prof_verif.act <- recruit_timing %>% filter(d_512820379 == 486306141 & d_827220437 >0 & d_230663853==353358909 & d_919254129== 353358909 & d_699625233 == 353358909 & d_821247024 != 875007964 & tm_prof_verif>0 ) %>% 
  mutate(time = as.numeric(tm_prof_verif),
         Site = droplevels(site)) %>% # Summary by group using dplyr, to make the time units as hours
  group_by(Site) %>% 
  dplyr::summarize('Number to Verification Completion' = n(),
                   min = min(time),
                   q1 = quantile(time, 0.25),
                   median = median(time),
                   mean = mean(time),sd=sd(time),
                   q3 = quantile(time, 0.75),
                   max = max(time))

 
table43_Tm_prof_verif.act <- rbind(table43_Tm_prof_verif.act,table43_Tm_prof_verif[which(table43_Tm_prof_verif$recruitment_type=="Active"),c(2:10)])   
table43_Tm_prof_verif.act$`Recruitment Type` <- "Active"
#colnames(table13_Tm_prof_verif.act)[2] <- "Total Active UPs to Verification"
colnames(table43_Tm_prof_verif.act)[2] <- "Total UP Submitted"


table43_Tm_prof_verif.pas <- recruit_timing %>% 
  filter(d_512820379 == 854703046 & d_827220437 >0 & d_230663853==353358909 & d_919254129== 353358909 & d_699625233 == 353358909 & d_821247024 != 875007964 &  tm_prof_verif >=0 ) %>%   mutate(time = as.numeric(tm_prof_verif),
         Site = droplevels(site)) %>% # Summary by group using dplyr, to make the time units as hours
  group_by(Site) %>% 
  dplyr::summarize('Number to Verification Completion' = n(),
                   min = min(time),
                   q1 = quantile(time, 0.25),
                   median = median(time),
                   mean = mean(time),sd=sd(time),
                   q3 = quantile(time, 0.75),
                   max = max(time))

table43_Tm_prof_verif.pas <- rbind(table43_Tm_prof_verif.pas,table43_Tm_prof_verif[which(table43_Tm_prof_verif$recruitment_type=="Passive"),c(2:10)]) 
table43_Tm_prof_verif.pas$order <- rownames(table43_Tm_prof_verif.pas)
table43_Tm_prof_verif.pas <- merge(prof_verif[which(prof_verif$d_512820379 == 854703046),],table43_Tm_prof_verif.pas,by.x="Site",by.y="Site", all.y=TRUE)

table43_Tm_prof_verif.pas$d_512820379 <- ifelse(table43_Tm_prof_verif.pas$Site=="Total","Passive",gsub("854703046","Passive",table43_Tm_prof_verif.pas$d_512820379))
table43_Tm_prof_verif.pas$n <- ifelse(table43_Tm_prof_verif.pas$Site=="Total", sum(prof_verif[which(prof_verif$d_512820379 == 854703046),]$n), table43_Tm_prof_verif.pas$n)
table43_Tm_prof_verif.pas<- table43_Tm_prof_verif.pas %>% arrange(as.numeric(order) )
colnames(table43_Tm_prof_verif.pas)[2] <- "Recruitment Type"
#colnames(table13_Tm_prof_verif.pas)[4] <- "Total Passive UPs to Verification"
colnames(table43_Tm_prof_verif.pas)[4] <- "Total UP submitted"

#Table 14. Total Enrollment Time
# Summary by group using dplyr, to make the time units as hours
enroll_verif <- recruit_timing %>% filter(d_827220437 >0 & d_230663853==353358909 &
         d_919254129== 353358909 & d_699625233 ==353358909 & d_821247024 != 875007964) %>% group_by(d_512820379,site) %>% tally()

table44_Tm_enroll_verif <- recruit_timing[complete.cases(recruit_timing[,c("verified_time","recru_time")]),] %>% 
  filter( d_827220437 >0 & d_230663853==353358909 &
         d_919254129== 353358909 & d_699625233 ==353358909 & d_821247024 != 875007964 & as.numeric(difftime(verified_time,recru_time,units="days")) >=0) %>% 
  mutate(time = as.numeric(difftime(verified_time,recru_time,units="days")),
         site = droplevels(site)) %>% 
  group_by(d_512820379) %>% 
  dplyr::summarize('Number Enrollment'=n(),
                   min = min(time),
                   q1 = quantile(time, 0.25),
                   median = median(time),
                   mean = mean(time),sd=sd(time),
                   q3 = quantile(time, 0.75),
                   max = max(time))
table44_Tm_enroll_verif$site <- "Total"
table44_Tm_enroll_verif$recruitment_type <- ifelse(table44_Tm_enroll_verif$d_512820379==486306141, "Active", ifelse(table44_Tm_enroll_verif$d_512820379 ==854703046,"Passive", "Not Active"))


table44_Tm_enroll_verif.act <- recruit_timing[complete.cases(recruit_timing[,c("verified_time","recru_time")]),] %>% 
  filter(d_512820379 == 486306141 & d_827220437 >0 & d_230663853==353358909 &
         d_919254129== 353358909 & d_699625233 ==353358909 & d_821247024 != 875007964 & as.numeric(difftime(verified_time,recru_time,units="days")) >=0) %>% 
  mutate(time = as.numeric(difftime(verified_time,recru_time,units="days")),
         site = droplevels(site)) %>% 
  group_by(site) %>% 
  dplyr::summarize('Number Enrollment'=n(),
                   min = min(time),
                   q1 = quantile(time, 0.25),
                   median = median(time),
                   mean = mean(time),sd=sd(time),
                   q3 = quantile(time, 0.75),
                   max = max(time))

table44_Tm_enroll_verif.act$recruitment_type <- "Active"
table44_Tm_enroll_verif.act <- rbind(table44_Tm_enroll_verif.act,table44_Tm_enroll_verif[which(table44_Tm_enroll_verif$recruitment_type=="Active"),c(2:11)]) 

         
colnames(table44_Tm_enroll_verif.act)[1:2] <- c("Site","Total Verification Complete")

#passive from sign in time to verification time
table44_signin_verif.pas <- recruit_timing[complete.cases(recruit_timing[,c("verified_time","signin_time")]),] %>% 
  filter(d_512820379 == 854703046 & d_827220437 >0 & d_230663853==353358909 &
         d_919254129== 353358909 & d_699625233 ==353358909 & d_821247024 != 875007964 ) %>% 
         mutate(site = droplevels(site)) %>% group_by(site) %>%
  dplyr::summarize('Total Verification Complete'=n())


table44_Tm_signin_verif.pas <- recruit_timing[complete.cases(recruit_timing[,c("verified_time","signin_time")]),] %>% 
  filter(d_512820379 == 854703046 & d_827220437 >0 & d_230663853==353358909 &
         d_919254129== 353358909 & d_699625233 ==353358909 & d_821247024 != 875007964 & as.numeric(difftime(verified_time,signin_time,units="days")) >=0 ) %>% 
  mutate(time = as.numeric(difftime(verified_time,signin_time,units="days")),
         site = droplevels(site)) %>% 
  dplyr::summarize('Number Verification Complete'=n(),
                   min = min(time),
                   q1 = quantile(time, 0.25),
                   median = median(time),
                   mean = mean(time),sd=sd(time),
                   q3 = quantile(time, 0.75),
                   max = max(time))
table44_Tm_signin_verif.pas$site <- "Total"

table44_Tm_enroll_verif.pas <- recruit_timing[complete.cases(recruit_timing[,c("verified_time","signin_time")]),] %>% 
  filter(d_512820379 == 854703046 & d_827220437 >0 & d_230663853==353358909 &
         d_919254129== 353358909 & d_699625233 ==353358909 & d_821247024 != 875007964 & as.numeric(difftime(verified_time,signin_time,units="days")) >=0 ) %>% 
  mutate(time = as.numeric(difftime(verified_time,signin_time,units="days")),
         site = droplevels(site)) %>% 
  group_by(site) %>% 
  dplyr::summarize('Number Verification Complete'=n(),
                   min = min(time),
                   q1 = quantile(time, 0.25),
                   median = median(time),
                   mean = mean(time),sd=sd(time),
                   q3 = quantile(time, 0.75),
                   max = max(time))

table44_Tm_enroll_verif.pas <- rbind(table44_Tm_enroll_verif.pas,table44_Tm_signin_verif.pas) 
table44_Tm_enroll_verif.pas$order <- as.numeric(rownames(table44_Tm_enroll_verif.pas))
table44_Tm_enroll_verif.pas <- merge(table44_signin_verif.pas,table44_Tm_enroll_verif.pas,by.x="site",by.y="site", all.y=TRUE)

table44_Tm_enroll_verif.pas$`Recruitment Type` <- "Passive"
table44_Tm_enroll_verif.pas <- table44_Tm_enroll_verif.pas %>% arrange(order) 
table44_Tm_enroll_verif.pas$`Total Verification Complete` <- ifelse(table44_Tm_enroll_verif.pas$site =="Total", sum(table44_signin_verif.pas$`Total Verification Complete`),table44_Tm_enroll_verif.pas$`Total Verification Complete` )
table44_Tm_enroll_verif.pas <- table44_Tm_enroll_verif.pas %>% dplyr::rename(Site=site)
#colnames(table14_Tm_enroll_verif.act)[2] <- "Recruitment Type"

#Daily Table 11. Age of Verified Participants
    table45_age <- data[which(data$d_821247024 == 197316935),] %>% mutate(site=droplevels(site)) %>%
               select(site, age) %>% tbl_cross(
                      row = site,
                    col = age,
                    label = list(age~"Age",site ~ "Site"),
                  percent = "row",
                  digits=c(0,2),
                  margin_text="Total Verified Participants") 
    
    table45_age[["table_body"]]$stat_0 <- sapply(strsplit(table45_age[["table_body"]]$stat_0," "),"[",1) 
    
    table45_age <- table45_age%>%
           #bold_labels() %>%
           #italicize_levels() %>% 
           modify_header(stat_0 = "Total Verified \n Participants") %>%
           modify_caption("Table 45. Age of Verified Participants") %>%
           #modify_footnote(all_stat_cols() ~"Note: Based on de-identified data sent by sites") %>%
            as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
			
#Daily Tabel 12. Race of Verified Participants
    data$race <- factor(data$race, levels=c("White","Other","Unknown"))
    table46_race <- data[which(data$d_821247024 == 197316935),] %>% select(site, race) %>% 
     mutate(site=droplevels(site))  %>% tbl_cross(
      row = site,
      col = race,
      label = list(race~"Race",site ~ "Site"),
      percent = "row",
      digits=c(0,2),
      margin_text="Total Verified Participants") 
    
    table46_race[["table_body"]]$stat_0 <- sapply(strsplit(table46_race[["table_body"]]$stat_0," "),"[",1) 
    
    table46_race <- table46_race %>%
      #bold_labels() %>%
      #italicize_levels() %>% 
      modify_header(stat_0 = "Total Verified \n Participants") %>%
      modify_caption("Table 46. Race of Verified Participants") %>%
      #modify_footnote(all_stat_cols() ~"Note: Based on de-identified data sent by sites") %>%
      as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

			
#Daily Table 13. Sex of Verified Participants
  data$sex <-factor(data$sex,levels=c("Female","Male", "Intersex or Other","Unknown"))
    
   table47 <- data[which(data$d_821247024 == 197316935),] %>% mutate(site=droplevels(site)) %>% select(site, sex) %>% dplyr::arrange(site,sex) %>%
     tbl_cross(
      row = site,
      col = sex,
      label = list(sex~"Sex",site ~ "Site"),
      percent = "row",
      digits=c(0,2),
      margin_text="Total Verified Participants") 
   
   
   table47[["table_body"]]$stat_0 <- sapply(strsplit(table47[["table_body"]]$stat_0," "),"[",1)  
   table47 <- table47 %>%
      #bold_labels() %>%
      #italicize_levels() %>% 
      modify_header(stat_0 = "Total Verified \n Participants") %>%
      modify_caption("Table 47. Sex of Verified Participants") %>%
      #modify_footnote(all_stat_cols() ~"Note: Based on de-identified data sent by sites") %>%
      as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
    

#Table 48. Daily Table 15 Age of All Records
   table48_ageall <- data[which(data$d_827220437>0),] %>% select(site, age) %>% tbl_cross(
     row = site,
     col = age,
     label = list(age~ "Age",site ~ "Site"),
     percent = "row",
     digits=c(0,2),
     margin_text="Total Recruits")
   
   table48_ageall[["table_body"]]$stat_0 <- sapply(strsplit(table48_ageall[["table_body"]]$stat_0," "),"[",1)
    
   table48_ageall <- table48_ageall%>%
     #bold_labels() %>%
     #italicize_levels() %>% 
     modify_header() %>%
     modify_caption("Table 48. Age of All Active and Passive Recruits") %>%
     as_kable_extra(escape = FALSE, addtl_fmt = TRUE) 
   
#Daily Table 17. Race of All Records
   table49_raceall <- data[which(data$d_827220437>0),] %>% select(site, race) %>% tbl_cross(
     row = site,
     col = race,
     label = list(race~"Race",site ~ "Site"),
     percent = "row",
     digits=c(0,2),
     margin_text="Total Recruits") 
   
   table49_raceall[["table_body"]]$stat_0 <- sapply(strsplit(table49_raceall[["table_body"]]$stat_0," "),"[",1) 
    
   table49_raceall <- table49_raceall %>%
     #bold_labels() %>%
     #italicize_levels() %>% 
     modify_header() %>%
     modify_caption("Table 49. Race of All Active and Passive Recruits") %>%
     as_kable_extra(escape = FALSE, addtl_fmt = TRUE)   
    
#Table 50 (daily Table 18.) Sex of All Records
   table50_sexall <- data[which(data$d_827220437>0),] %>% select(site, sex) %>% 
     dplyr::arrange(site,sex) %>% tbl_cross(
     row = site,
     col = sex,
     label = list(sex~"Sex",site ~ "Site"),
     percent = "row",
     digits=c(0,2),
     margin_text="Total Recruits")
   
   table50_sexall[["table_body"]]$stat_0 <- sapply(strsplit(table50_sexall[["table_body"]]$stat_0," "),"[",1) 
    
   table50_sexall <- table50_sexall%>%
     #bold_labels() %>%
     #italicize_levels() %>% 
     modify_header() %>%
     modify_caption("Table 50. Sex of All Active and Passive Recruits") %>%
     as_kable_extra(escape = FALSE, addtl_fmt = TRUE)   

```


```{r,eval=TRUE,echo=FALSE,include=FALSE,error=FALSE,message=FALSE,results='asis'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
knitr::opts_chunk$set(fig.pos = "H", out.extra = "")
#code for the plots
modules <- c("d_100767870","d_949302066","d_536735468","d_663265240","d_976570371","d_517311251","d_832139544","d_264644252","d_770257102")
bio.col <- c("d_684635302","d_878865966","d_167958071","d_173836415_d_266600170_d_915179629","d_173836415_d_266600170_d_718172863",
              "d_173836415_d_266600170_d_592099155","d_173836415_d_266600170_d_561681068","d_173836415_d_266600170_d_847159717",
              "d_173836415_d_266600170_d_448660695","d_173836415_d_266600170_d_139245758","d_173836415_d_266600170_d_982213346")
###clinical collection time:
clc.bldtm <- c("d_173836415_d_266600170_d_769615780","d_173836415_d_266600170_d_822274939","d_173836415_d_266600170_d_398645039","d_173836415_d_266600170_d_982213346","d_173836415_d_266600170_d_740582332")
clc.urinetm <- c("d_173836415_d_266600170_d_139245758","d_173836415_d_266600170_d_224596428","d_173836415_d_266600170_d_541311218","d_173836415_d_266600170_d_939818935","d_173836415_d_266600170_d_740582332")

ref.wd <- c("d_773707518","d_747006172","d_831041022","d_664453818","d_269050420","d_659990606")

var.list <- c("token","Connect_ID","d_821247024","d_914594314","d_512820379","state_d_158291096","d_471593703","d_827220437","site",
              "d_130371375_d_266600170_d_787567527","d_130371375_d_266600170_d_731498909",bio.col,modules,ref.wd)

veri_resp <- data[which(data$d_512820379 != 486306141 | data$d_821247024 != 922622075 ),var.list] %>%
  mutate(recruit_year= year(ymd_hms(d_471593703)),
          recruit_month = month(ymd_hms(d_471593703)),
          verified_year= year(ymd_hms(d_914594314)),
          verified_month = month(ymd_hms(d_914594314)),
         elgible.time = ymd_hms(d_130371375_d_266600170_d_787567527))

veri_resp$verified_time <- ymd_hms(veri_resp$d_914594314)
veri_resp$recru_time <- ymd_hms(veri_resp$d_471593703)
veri_resp$recrstart.date <- as_date(min(veri_resp$recru_time,na.rm=TRUE))
veri_resp$verified.week <- ceiling(as.numeric(difftime(as_date(veri_resp$verified_time),as_date(veri_resp$recrstart.date),units="days"))/7)
veri_resp$verified.week.date <- (veri_resp$recrstart.date) + dweeks(veri_resp$verified.week)

library(scales)
#figure 1 
veri_resp$verified_time <- ymd_hms(veri_resp$d_914594314)
 veri_resp$recru_time <- ymd_hms(ifelse(veri_resp$d_471593703 =="NA",veri_resp$d_914594314, veri_resp$d_471593703))
 veri_resp$recrstart.date <- as_date(min(as.POSIXct(veri_resp$recru_time),na.rm=TRUE))
recrstart.date <- as_date(min(as.POSIXct(veri_resp$recru_time),na.rm=TRUE))

 veri_resp$verified.week <- ceiling(as.numeric(difftime(as_date(veri_resp$verified_time),as_date(veri_resp$recrstart.date),units="days"))/7)
 veri_resp$verified.week.date <-  veri_resp$recrstart.date + dweeks(veri_resp$verified.week)
 
 veri_resp$recruit.week <- ceiling(as.numeric(difftime(as_date(veri_resp$recru_time), as_date(veri_resp$recrstart.date),units="days"))/7)
 veri_resp$recruit.week.date <- veri_resp$recrstart.date + dweeks(veri_resp$recruit.week)
 ###to create the time censoring variables by week;
  recruit.wk.active <- veri_resp[which(veri_resp$d_512820379==486306141),] %>% 
   group_by(recruit.week,recruit.week.date) %>%
   dplyr::summarize(active_recruits=n())
 
 verified.wk.active <- veri_resp[which(veri_resp$d_821247024 == 197316935 & veri_resp$d_512820379==486306141),] %>% 
   group_by(verified.week,verified.week.date) %>%
   dplyr::summarize(active_verifieds=n())
 
 verified.wk.total <- veri_resp[which(veri_resp$d_821247024 == 197316935),] %>% 
   group_by(verified.week,verified.week.date) %>%
   dplyr::summarize(total_verifieds=n())
 
 verified.wk.all <- merge(verified.wk.active,verified.wk.total, by.x=c("verified.week","verified.week.date"), by.y = c("verified.week", "verified.week.date"), all.y=TRUE)
 verified.wk.all$verified.week.date[is.na(verified.wk.all$verified.week.date)]<- recrstart.date + verified.wk.all$verified.week*7
 recrui_wk_verified <- merge(recruit.wk.active,verified.wk.all, by.x=c("recruit.week","recruit.week.date"),by.y=c("verified.week","verified.week.date"),all.x=TRUE,all.y=TRUE)
 recrui_wk_verified[is.na(recrui_wk_verified)] <- 0
 
 recrui_wk_verified <- recrui_wk_verified %>% arrange(recruit.week,recruit.week.date)
 
 recrui_wk_verified$passive_verified <- recrui_wk_verified$total_verified-recrui_wk_verified$active_verifieds #new passive recruitment
 recrui_wk_verified$total_recruits <- recrui_wk_verified$active_recruits + recrui_wk_verified$passive_verified ##the total recruits till that week
# passive recruits are the passive verified
 
  recrui_wk_verified$total_recruits.cum <- cumsum(recrui_wk_verified$active_recruits + recrui_wk_verified$passive_verified) ##the total recruits till that week
 recrui_wk_verified$active_verifieds.cum <- cumsum(recrui_wk_verified$active_verifieds)
 
 recrui_wk_verified$total_verified.cum <- cumsum(recrui_wk_verified$total_verifieds)
 recrui_wk_verified$active_recruits.cum <- cumsum(recrui_wk_verified$active_recruits)
 
 #new response rate:
 recrui_wk_verified$new.active.response.rate <- ifelse(recrui_wk_verified$active_recruits >0, 100*(recrui_wk_verified$active_verifieds/recrui_wk_verified$active_recruits), 0)
 
 recrui_wk_verified$new.passive.response.rate <- ifelse(recrui_wk_verified$active_recruits!=0, 100*(recrui_wk_verified$passive_verified/recrui_wk_verified$active_recruits),NA)
 recrui_wk_verified$new.total.response.rate <- ifelse(recrui_wk_verified$active_recruits>0, 100*(recrui_wk_verified$total_verifieds/recrui_wk_verified$active_recruits), 0)
 
 #cumalative rate
 recrui_wk_verified$cum.active.response.rate <- 100*(cumsum(recrui_wk_verified$active_verifieds)/cumsum(recrui_wk_verified$active_recruits))
 recrui_wk_verified$cum.passive.response.rate <- 100*(cumsum(recrui_wk_verified$passive_verified)/cumsum(recrui_wk_verified$active_recruits))
 recrui_wk_verified$cum.total.response.rate <- 100*(cumsum(recrui_wk_verified$total_verifieds)/cumsum(recrui_wk_verified$active_recruits))

 
 recrui_verified_22 <- recrui_wk_verified[which(recrui_wk_verified$recruit.week>23),]
 max_y <- max(recrui_wk_verified$total_verified.cum)
 breaks <- seq(1000,1000*round(max_y/1000,0),1000)
#figure 1
response_rate.plot <- ggplot(recrui_wk_verified,aes(x=as.Date(recruit.week.date))) + 
     geom_area(aes(y=total_verified.cum),fill="lightblue") +  #the geom_line also can be applied#
     
     #geom_text(aes(as.Date("2021-09-17"),455, label="highest cumulative response rate=112.5%"),size = 3,color="blue")+
     geom_line(aes(y=cum.total.response.rate*500), color="red") +
     #geom_text(aes(y=cumulative.response.rate*4),color="red") +
     scale_y_continuous(name="# Verified",   breaks=breaks, sec.axis = sec_axis( ~ . /500 , name = "Cumulative Response Rate (%)")) +
     coord_cartesian(ylim =c(0,max_y)) +
     scale_x_date(limit=c(as.Date("2022-01-01", origin = lubridate::origin),as.Date(currentDate, origin = lubridate::origin)),name="Date of Recruitment",date_labels = "%m/%d/%Y", date_breaks = "2 weeks")  +
     ggtitle("Number Overall Verified & Response Rate Over Time")+
     theme( axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
            axis.title.y = element_text(size = 14, face = "bold",color="black"),
            axis.title.y.right = element_text(size=14,face="bold",color="red"),
            # Remove panel border
            panel.border = element_blank(),  
            # Remove panel grid lines
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            # Remove panel background
            panel.background = element_blank(),
            # Add axis line
            axis.line = element_line(colour = "grey") 
            
     ) 

#Figure 2. Number Verified Over Time
#verified by site over time:
veri_allsites  <- NULL

for(site in unique(veri_resp[which(veri_resp$d_827220437>0),]$site)){
  
  subs_verif <- veri_resp[which(veri_resp$site == site & veri_resp$d_827220437>0 ),]%>% 
    group_by(verified.week,recrstart.date) %>%
    dplyr::summarize(new_verified=n())
  subs_verif$Total.verified <- cumsum(subs_verif$new_verified)
  subs_verif$site <- site
  veri_allsites <- rbind(veri_allsites,subs_verif)
} 
colnames(veri_allsites)
veri_allsites$verified.week.date <- (veri_allsites$recrstart.date) + dweeks(veri_allsites$verified.week)

Fig2_verified_time <- ggplot(veri_allsites,aes(y=Total.verified, x=as.Date(verified.week.date, origin = lubridate::origin),color=site)) + geom_line() +    geom_point()+
  scale_y_continuous(name="# Verified", limits=c(0,1700)) +
  scale_x_date(name="Date of Verification",date_labels = "%y-%m-%d", date_breaks = "2 weeks")  +
  ggtitle("Number Verified Over Time")+
  theme( axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
         axis.title.y = element_text(size = 14, face = "bold",color="black"),
         plot.title = element_text(face="bold", size=18),
         # Remove panel border
         panel.border = element_blank(),  
         # Remove panel grid lines
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         # Remove panel background
         panel.background = element_blank(),
         # Add axis line
         axis.line = element_line(colour = "grey") ,
         ##put the legend in the plot
         legend.position = c(.2, .6),
         legend.margin = margin(1, 1, 1, 1)
  ) 

 #Figure 3
##March 25, as Mia comments: to 
# UChicago’s goal should be reduced to 2500.
# Please remove the response rate from this figure in this report (I will request it in the “Stakeholder Report” to be worked on together soon so save the code somewhere else.)
# Add a different color/ texture in the same bar for each site to show the number blood samples collected.
 recruit.site <- veri_resp[which(veri_resp$d_821247024 == 197316935 & veri_resp$d_827220437 >0),] %>% 
   group_by(d_827220437) %>%
   dplyr::summarize(Verified=n())
 
 blood.site <- filter(data,d_878865966==353358909 & d_821247024 == 197316935 &d_827220437 >0) %>% 
   group_by(d_827220437) %>%
   dplyr::summarize(`Blood Collection`=n())
 
 recruit.site <- merge(recruit.site,blood.site, by="d_827220437")
 
 # recruit_site <- data[which(data$d_512820379==486306141 & data$d_827220437 >0),] %>% 
 #   group_by(d_827220437) %>%
 #   dplyr::summarize(recruit_site=n())
 # response.site <- merge(recruit.site,recruit_site, by="d_827220437")
 # response.site$response.rate <- 100*response.site$verified_site/response.site$recruit_site
 
 recruit.site <- recruit.site %>% mutate( Expected = case_when(d_827220437 == '125001209' ~ 1900, #KPCO#
                                                              d_827220437 == '327912200'  ~ 1300,#KPGA#
                                                              d_827220437 == '300267574'  ~ 790, #KPHI #
                                                              d_827220437 == '452412599'  ~ 1900, #KPNW#
                                                              d_827220437 == '303349821'  ~ 760, #Marshfield#
                                                              d_827220437 == '531629870'  ~ 2247, #HP#
                                                              d_827220437 == '548392715'  ~ 1600, #HFHS#
                                                              d_827220437 == '657167265'  ~ 1015, #SH#
                                                              d_827220437 == '809703864'  ~ 2500, #UoCh#
                                                              d_827220437 == '517700004' | d_827220437 == '181769837' ~ 0),
                                          Site = case_when(d_827220437 == 125001209 ~ "KPCO",
                                                           d_827220437 == 327912200  ~ "KPGA",
                                                           d_827220437 == 300267574  ~ "KPHI" ,
                                                           d_827220437 == 452412599  ~ "KPNW",
                                                           d_827220437 == 303349821  ~ "Marshfield",
                                                           d_827220437 == 531629870  ~ "HP",
                                                           d_827220437 == 548392715  ~ "HFHS",
                                                           d_827220437 == 657167265  ~ "SH",
                                                           d_827220437 == 809703864  ~ "UoCh",
                                                           d_827220437 == 517700004 | d_827220437 == 181769837 ~ "NIH"))
 
 # recrui.rate<-merge(recruit.site,response.site,by=c("d_827220437","verified_site"))
 # colnames(recrui.rate)[which(colnames(recrui.rate)=="verified_site")] <- "Verified"
 # recrui.rate$Verified <- as.numeric(recrui.rate$Verified)
 
 # verifed_expected <- melt(recrui.rate[,c("d_827220437","Expected","Verified","Site","response.rate")],
 # # ID variables - all the variables to keep but not split apart on
 # id.vars=c("Site","d_827220437","response.rate"),
 # # The source columns
 # measure.vars=c("Expected","Verified"),
 # # Name of the destination column that will identify the original
 # # column that the measurement came from
 # variable.name="Expected_verified.type",
 # value.name="Expected_Verified_n")
 recruit.site$Expected <- as.integer(recruit.site$Expected)
 verifed_expected <- melt(recruit.site[,c("d_827220437","Expected","Verified","Site","Blood Collection")],
                          id.vars=c("Site","d_827220437"), measure.vars=c("Expected","Verified","Blood Collection"),variable.name="Expected_verified.type",
value.name="Expected_Verified_n")
 verifed_expected$Expected_verified.type <- factor(verifed_expected$Expected_verified.type, levels=c("Expected","Verified","Blood Collection"))

verifed_expected$Site <- factor(verifed_expected$Site,levels = c("HFHS","HP","KPCO","KPGA","KPHI","KPNW","Marshfield","SH","UoCh"))

verified_expect_bld.plot <- ggplot(verifed_expected,aes(x=Site)) +
  geom_bar(aes(y=Expected_Verified_n,color=Expected_verified.type,fill=Expected_verified.type),position="identity", stat="identity",alpha=0.25)+ 
  geom_text(aes(y=Expected_Verified_n,label=Expected_Verified_n),size = 4,color="black",vjust = -0.1, position = position_dodge(width=2))+
  #geom_point(aes(y=Completion.rate*80),size=1.5, color=rateColor) +  
  #geom_text(aes(y=Completion.rate*80,label=round(Completion.rate,2)),size=3,color="red",hjust= 0.5,vjust=0.8,position = position_dodge(width=1)) +
  scale_fill_manual(values = c("white", "blue", "red")) +
  scale_y_continuous(name="Individuals, N", breaks=c(100,500,1000,1500,2000,2500,3000,3500,4000,4500,5000) )+
  #,sec.axis = sec_axis( ~ . /80, 
  #                     name = "Completion Rate of Baseline Modules&Biospecimen Collections, %",breaks=c(2,4,6,8,10)))+
  labs( title=str_wrap(paste("Total Expected recruits vs Actual Verified Recruitments vs. \nNumbers of Blood Collections till",currentDate, sep=" "),  60),
        x = "Recruitment Sites")+
  #annotation_custom(l, xmin = 7.5, xmax = 9.5, ymin = -150, ymax = -200) +
  #coord_cartesian(clip = "off") +
  theme( axis.title.x = element_text( size = 14, face = "bold"),
         axis.title.y = element_text(size = 14, face = "bold"),
         #axis.title.y.right = element_text(size=10,face="bold"),
         title = element_text(size=9,face="bold"),
         # Remove panel border
         panel.border = element_blank(),  
         # Remove panel grid lines
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         # Remove panel background
         panel.background = element_blank(),
         # Add axis line
         axis.line = element_line(colour = "grey"),
         # Remove the legend
         legend.position =c(0.7, 0.9),
         plot.margin = unit(c(1, 1, 3, 1), "lines")
  )  
 
#  rateColor <- "orange" 
# verified_expect.plot <- ggplot(verifed_expected,aes(x=Site))+
#    geom_bar(aes(y=Expected_Verified_n,color=Expected_verified.type,fill=Expected_verified.type),position="identity", stat="identity",alpha=0.5)+ 
#    geom_text(aes(y=Expected_Verified_n,label=Expected_Verified_n),size = 3,color="black",hjust=-0.4, vjust = -0.45 ,position = position_dodge(width=1))+
#    geom_point(aes(y=response.rate*90),size=2, color=rateColor)+  scale_fill_manual(values = c("white", "navy")) +
#    geom_text(aes(y=response.rate*90,label=round(response.rate,1)),size=3,color="red",hjust= 0.6,vjust= -0.8,position = position_dodge(width=1)) +
#    scale_y_continuous(name="Individuals, N", breaks=c(500,1000,1500,2000,2500,3000,3500,4000,4500,5000,5500,6000,6500,7000),
#                       sec.axis = sec_axis( ~ . /80 , 
#                                            name = "Response Rate, %",breaks=c(2,4,6,8,10,20,40, 60)))+
#    labs( title=str_wrap("Initial Period Recruitment Expectations vs. Number Verified Individuals and Cumulative Response Rate", 60),
#          x = "Recruitment Sites")+
#    #annotation_custom(l, xmin = 7.5, xmax = 9.5, ymin = -150, ymax = -200) +
#    #coord_cartesian(clip = "off") +
#    theme( axis.title.x = element_text( size = 14, face = "bold"),
#           axis.title.y = element_text(size = 14, face = "bold"),
#           axis.title.y.right = element_text(size=14,face="bold"),
#           title = element_text(size=9,face="bold"),
#           # Remove panel border
#           panel.border = element_blank(),  
#           # Remove panel grid lines
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           # Remove panel background
#           panel.background = element_blank(),
#           # Add axis line
#           axis.line = element_line(colour = "grey"),
#           # Remove the legend
#           legend.position = c(0.2, 0.8),
#           plot.margin = unit(c(1, 1, 3, 1), "lines")
#    )

 #Figure of cumulative verified participants with cumulative complete participants overlaid and time of verification on the x-axis OVERALL and BY SITE
  veri_resp$elgible.time <- ymd_hms(veri_resp$d_130371375_d_266600170_d_787567527) 
  veri_resp$eligible.week <- ifelse(!is.na( veri_resp$d_130371375_d_266600170_d_787567527) & veri_resp$d_821247024==197316935,ceiling(as.numeric(difftime(as_date(veri_resp$elgible.time),as_date(veri_resp$recrstart.date),units="days"))/7),NA)
 veri_resp$verified.week.date <-  veri_resp$recrstart.date + dweeks(veri_resp$verified.week)
 
 eligible.wk.total <- veri_resp[which(veri_resp$d_821247024 == 197316935 & veri_resp$d_130371375_d_266600170_d_731498909 ==353358909 ),] %>% 
   group_by(eligible.week) %>%
   dplyr::summarize(total_eligible=n())
 
 veri_wk_eligble <- merge(verified.wk.total, eligible.wk.total,by.x="verified.week",by.y="eligible.week", all.x=TRUE,all.y=TRUE)
 veri_wk_eligble[is.na(veri_wk_eligble)] <- 0
 veri_wk_eligble <- veri_wk_eligble %>% arrange(verified.week)%>% 
   mutate(total_verified.cum=cumsum(total_verifieds),
          total_eligible.cum=cumsum(total_eligible))

max0 <- max(veri_wk_eligble$total_verified.cum)

fig4<- ggplot(veri_wk_eligble,aes(x=as.Date(verified.week.date, origin = lubridate::origin))) + 
     geom_area(aes(y=total_eligible.cum),fill="lightblue") +  
     geom_line(aes(y=total_verified.cum), color="red") +
     scale_y_continuous(name="# Verified Participants",  breaks=breaks, 
                        sec.axis = sec_axis( ~ . , name = "Cumulative Payment Eligible Participants")) +
     coord_cartesian(ylim =c(45,max0)) +
     scale_x_date(limit=c(as.Date("2022-01-01", origin = lubridate::origin),currentDate),name="Date of Recruitment",date_labels = "%m/%d/%Y", date_breaks = "1 month")  +
     ggtitle("Number Verified Participants & Payment-Eligible Participants \n Over Time of All Sites")+
     theme( axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 12, face = "bold") ,
            axis.title.y = element_text(size = 12, face = "bold",color="black"),
            axis.title.y.right = element_text(size=12,face="bold",color="lightblue"),
            plot.title=element_text(lineheight=3, face="bold", color="black", size=12),
            # Remove panel border
            panel.border = element_blank(),  
            # Remove panel grid lines
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            # Remove panel background
            panel.background = element_blank(),
            # Add axis line
            axis.line = element_line(colour = "grey") 
            
     )
 #"total_verifieds","total_eligible", 
 # dt.fig4 <- melt(veri_wk_eligble,irection='long', 
 #       idvars=c("verified.week","verified.week.date"),
 # 
 #        measure.vars=c( "total_verified.cum","total_eligible.cum"), 
 #        value.names=c( 'veri.cumsum'),
 #        variable.name=c("type"),
 #        )

eligible.wk.total.site <- veri_resp[which(veri_resp$d_821247024 == 197316935 & veri_resp$d_130371375_d_266600170_d_731498909 ==353358909 ),] %>% 
   group_by(eligible.week,site) %>%
   dplyr::summarize(total_eligible=n())

verified.wk.total.site <- veri_resp[which(veri_resp$d_821247024 == 197316935),] %>% 
   group_by(site,verified.week,verified.week.date) %>%
   dplyr::summarize(total_verifieds=n())


  
 veri_wk_eligble.site <- merge(verified.wk.total.site, eligible.wk.total.site,by.x=c("verified.week","site"),by=c("eligible.week","site"), all.x=TRUE,all.y=TRUE)
veri_wk_eligble.site$verified.week.date[is.na(veri_wk_eligble.site$verified.week.date)] <- recrstart.date + verified.wk.all$verified.week*7
 
 veri_wk_eligble.site$total_verifieds[is.na(veri_wk_eligble.site$total_verifieds)] <- 0
veri_wk_eligble.site$total_eligible[is.na(veri_wk_eligble.site$total_eligible)] <- 0

 
 #veri_wk_eligble.site$verified.week.date[is.na(veri_wk_eligble.site$verified.week.date)] <- 0
 veri_wk_eligble.site <- veri_wk_eligble.site %>% arrange(site,verified.week)%>% 
   group_by(site)%>%
   mutate(total_verified.cum=cumsum(total_verifieds),
          total_eligible.cum=cumsum(total_eligible))
 


 veri_wk_eligble$site <- "All.Sites"
 tapply(veri_wk_eligble.site$total_verified.cum,veri_wk_eligble.site$site,function(x) summary(x))
Fig4 <- list()
for (i in 1:9){
  site <- levels(veri_wk_eligble.site$site)[i]
  sub <- veri_wk_eligble.site[which(veri_wk_eligble.site$site==site),]
  max <- max(sub$total_verified.cum)
 figure <- ggplot(sub,aes(x=as.Date(verified.week.date, origin = lubridate::origin))) + 
     geom_area(aes(y=total_eligible.cum),fill="lightblue") +  
     geom_line(aes(y=total_verified.cum), color="red")+ 
    scale_y_continuous(name="# Verified Participants",  
                        sec.axis = sec_axis( ~ . , name = "Cumulative Payment Eligible Participants")) +
     coord_cartesian(ylim =c(5,max)) +
     scale_x_date(limit=c(as.Date("2022-01-01", origin = lubridate::origin),currentDate),name="Date of Recruitment",date_labels = "%m/%d/%Y", date_breaks = "1 month")  +
     ggtitle(paste0("Number Verified Participants & Payment Eligible Participants \n" ,
                     "Over Time ",site))+
     theme( panel.background = element_blank(),
            legend.title = element_text(size=7),
        axis.line = element_line(linewidth =0.2),
        axis.text.x = element_text(angle=30,hjust = 1.0,size = 8, face = "bold"), 
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        axis.title.y.right = element_text(size=14,face="bold",color="lightblue"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold"),                
        legend.position = c(0.2,0.5)
     )
 print(figure)
 Fig4[[i]] <-figure
}

  p1 <- Fig4[[1]]
  p2 <- Fig4[[2]]
  p3 <- Fig4[[3]]
  p4 <- Fig4[[4]]
  p5 <- Fig4[[5]]
  p6 <- Fig4[[6]]
  p7 <- Fig4[[7]]
  p8 <- Fig4[[8]]
  p9 <- Fig4[[9]]

```



```{r, eval=TRUE,echo=FALSE}
options(knitr.table.format = "latex")
options(kableExtra.auto_format = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

knitr::kable(recruittypetotal[,c(4,1:3)],format.args = list(big.mark = ","), caption = 'Table 1.  Total Number of Active and Passive recruits', row.names=FALSE, align=c("l", "c", "c", "c")) %>% kable_styling(latex_options = "HOLD_position") %>% add_indent(c(1:3)) %>% footnote(general = 'Not Active records are excluded from this report',general_title = "Note: ", footnote_as_chunk = T)

table2_recrall

knitr::kable(Table3_response.rate, caption='Table 3. Verified Participants and Response Ratio based on Number of Active Recruits', row.names=FALSE, align=c("l","c", "c", "c")) %>% add_indent(c(1:9))
```
## Plots
```{r,eval=TRUE,echo = FALSE,fig.cap='Figure 1'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
response_rate.plot
```

```{r, eval=TRUE,echo=FALSE,fig.cap='Figure 2'}

knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
Fig2_verified_time
```

```{r, eval=TRUE,echo=FALSE,fig.cap='Figure 3'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
verified_expect_bld.plot

```


```{r, eval=TRUE,echo=FALSE}
options(knitr.table.format = "latex")
options(kableExtra.auto_format = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

colnames(cumulative_all)[2] <- "Total Recruits"
knitr::kable(cumulative_all[,c(1,3:7,2)], caption = 'Table 4. Cumulative Status All Recruits', row.names=FALSE, align=c("l", "c", "c", "c","c", "c","c"),format.args = list(big.mark = ",")) %>% kable_styling(latex_options = c("HOLD_position","scale_down")) %>% add_indent(c(1:9))

colnames(cumulative_active)[8] <- "Total Active Recruits"
knitr::kable(cumulative_active[,c(1,9:13,8)], caption = 'Table 5. Cumulative Status for Active Recruits Only', row.names=FALSE, align=c("l", "c", "c", "c", "c","c","c")) %>% kable_styling(latex_options = c("HOLD_position", "scale_down")) %>% add_indent(c(1:9))

colnames(cumulative_passive)[8] <- "Total Passive Recruits"
knitr::kable(cumulative_passive[,c(1,9:13,8)], caption = 'Table 6. Cumulative Status for Passive Recruits Only',  row.names=FALSE, align=c("l","c","c","c","c","c","c")) %>% kable_styling(latex_options = "scale_down") %>% add_indent(c(1:9))

Table7_profilecomplete %>% kable_styling(latex_options = "scale_down")%>% footnote(general = 'The Active duplicates are excluded from Active Recruits',general_title = "Note: ", footnote_as_chunk = T)
Table7b_pro_pas %>% kable_styling(latex_options = "scale_down")

Table8_profile  %>% kable_styling(latex_options = "scale_down")

table9_verifiedtype %>% kable_styling(font_size = 9) %>% kable_styling(latex_options = "scale_down") %>%  footnote(general="KP sites not yet sending data for Manual Verification and Outreach category.",general_title = "Note:",footnote_as_chunk = T) %>% landscape() 

table10 %>% kable_styling(latex_options = "scale_down")

table11 %>% kable_styling(latex_options = "scale_down")

table12_biocol %>% kable_styling(latex_options = "scale_down") %>% landscape()

table13_surveycomplt

```

```{r,echo=FALSE,error=FALSE,message=FALSE,results='asis'}
###Tables on baseline activity: biospecimen donation, Survey modules
Modbiospe.All%>% kable_styling(latex_options = c("scale_down")) %>% landscape()%>%footnote(general="Mouthwash collection is not yet available at KP sites",general_title = "Note:",footnote_as_chunk = T)

for (i in 1:5){print(Modbiospe.site[[i]]  %>% kable_styling(latex_options = c("scale_down")) %>%  landscape())}
                     
for (i in 6:9){print(Modbiospe.site[[i]]  %>% kable_styling(latex_options = c("scale_down")) %>%  landscape()  %>% footnote(general="Mouthwash collection is not yet available at KP sites",general_title = "Note:",footnote_as_chunk = T))}

refuse.withdrawls_w2 <- refuse.withdrawls_w1[,c(1,2,8,9,3,4,6)]
colnames(refuse.withdrawls_w2) = c("Site","Refusal of Any Study Activity", "Refusal of All Study Activities","Revoked HIPAA  Authorization", "Withdraw Consent", "Data Destruction", "Total Consented Participants")

refuse.withdrawls_w2 %>% 
  knitr::kable("latex",caption='Table 24. Refusals and Withdrawals Among All Consented Participants', row.names=FALSE, col.names = linebreak(names(refuse.withdrawls_w2), align = "l"), align=c("l","l","l","l","l","l","l"), booktabs = TRUE, linesep = "") %>% kable_styling(latex_options = c("scale_down"),full_width = F) %>% add_indent(c(1:9)) %>% footnote(general='% of the Total Consented Participants by Site',  general_title = "Note:",footnote_as_chunk = T)
 
 knitr::kable(ref_wd_reasons_all1[,c(12,2:11)],caption='Table 25. Reasons for Refusal or Withdrawal Among Those That Requested',caption.short = "Reasons for Refusal/Withdrawl.", row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c","c")) %>% kable_styling(latex_options = c("scale_down"))%>% add_indent(c(1:24)) %>%landscape() %>% footnote(general = c('Total counts of refusal and withdrawal reasons are not equal to the total numbers of refusal and withdrawal cases','Frequency %  is the counts  of refusal and withdrawal cases with Refusal and withdrawal reason out of the total numbers of refusal and withdrawal cases by site'),  general_title = "Note:",footnote_as_chunk = T)
```

```{r,echo=FALSE,error=FALSE,message=FALSE}
###Tables on Incentive part by UoC and NORC and biospecimen donations
#Till now no incentive payments have been issued to the eligible participants in UoC site

 incentive.eligible %>% kable_styling(font_size=9,latex_options = "scale_down")  
#%>% footnote(general="University of Chicago Medicine has not sent incentive data yet to CCC",general_title = "Note: ",footnote_as_chunk = T)

 Eligible %>% kable_styling(latex_options = "scale_down") %>%  footnote(general="University of Chicago Medicine has not sent incentive data yet to CCC",footnote_as_chunk = T)
 
 colnames(table28_Tm_IncentIssued)[1] = "Site"
 knitr::kable(table28_Tm_IncentIssued, caption ='Table 28. Time From Incentive Eligible to Incentive Issued by NORC in Days', row.names=FALSE, digits=2, booktabs=T, linesep = "", align=c("l", "c", "c","c", "c", "c", "c", "c", "c"))  %>% kable_styling(latex_options = "scale_down")%>% landscape() %>% add_indent(c(1:8)) %>% footnote(general='For all sites except Chicago',footnote_as_chunk = T)
```
 
```{r, eval=TRUE,echo=FALSE,fig.cap='Figure 4'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
fig4
```


```{r, eval=TRUE,echo=FALSE,fig.cap='Figure 4.1'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
#HP
 print(Fig4[[1]])

```

```{r, eval=TRUE,echo=FALSE,fig.cap='Figure 4.2'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
  print(Fig4[[2]])
#HFHS
```

```{r, eval=TRUE,echo=FALSE,fig.cap='Figure 4.3'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
  print(Fig4[[3]])
#MFH
```

```{r, eval=TRUE,echo=FALSE,fig.cap='Figure 4.4'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
 print(Fig4[[4]])
#SF
```

```{r,eval=TRUE,echo=FALSE,fig.cap='Figure 4.5'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
#UOC
 print(Fig4[[5]])
```

```{r, eval=TRUE,echo=FALSE,fig.cap='Figure 4.6'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
#KPCO
print(Fig4[[6]])
```

```{r, eval=TRUE,echo=FALSE,fig.cap='Figure 4.7'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
#KPGA
print(Fig4[[7]])
```

```{r, eval=TRUE,echo=FALSE,fig.cap='Figure 4.8'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
#KPHI
print(Fig4[[8]])
```

```{r, eval=TRUE,echo=FALSE,fig.cap='Figure 4.9'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
 #KPNW
 print(Fig4[[9]])
```

```{r, eval=TRUE,echo=FALSE}
options(knitr.table.format = "latex")
options(kableExtra.auto_format = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

knitr::kable(cancer.veri.up[,c(1,6,2,3,5,7)],caption = 'Table 29. Previous Cancer Reported in User Profile by Verification Status', row.names=FALSE,format.args = list(big.mark = ","), align=c("l","c","c","c","c","c"),booktabs = T, linesep = "",
col.names = c("Site","Total Previous Cancer","Verified","Cannot be Verified","Duplicate","Total Recruits That Submitted UP"))%>%  add_header_above(header = c(" " = 2, "Previous Cancer by Verification Status" = 3, " "=1)) %>% add_indent(c(1:9))%>%landscape()%>% footnote(general='Frequency (%) of Total Recruits That Submitted UP',general_title = "Note:", footnote_as_chunk = T)

signin_methods1 %>%  kable_styling(latex_options = "scale_down")%>%landscape()

knitr::kable(Table31b_awaresreasons[,c(13,3:12),],caption = 'Table 31. How Recruits Heard About Study', row.names=FALSE, align=c("l", "c", "c","c", "c", "c", "c", "c", "c", "c","c","c")) %>% kable_styling(latex_options = "scale_down") %>% add_indent(c(1:21))%>% landscape() %>% footnote(general=c("Recruits may select more than one option.","Percentage is of each item in awareness among recruits within each site"),general_title="Note:",footnote_as_chunk = T)
 
table32_Totalactivecamp %>% kable_styling(latex_options = "scale_down")%>% landscape()

colnames(campaign.combo)[2:17] <- sapply(strsplit(colnames(campaign.combo)[2:17],"_"),tail,1)
knitr::kable(as.data.frame(campaign.combo[ ,c(17,1:8,13:16,11,12,9:10,18)]),caption = 'Table 33. Success Rate by Campaign Type for Active Recruits',row.names=FALSE, booktabs = T, linesep = "", format.args = list(big.mark = ","), align = c("l", "c", "c","c", "c", "c", "c", "c", "c", "c", "c","c", "c", "c", "c", "c", "c","c"), col.names=c("Site","Verified","Response Rate","Verified","Response Rate","Verified","Response Rate","Verified","Response Rate","Verified","Response Rate","Verified","Response Rate","Verified","Response Rate","Verified","Response Rate","Total Active Recruits")) %>% kable_styling(latex_options = "scale_down") %>% add_indent(c(1:9)) %>% add_header_above(c(" " = 1, "Aging out of Study" = 2, "Demographic Group" = 2, "Geographic Group"=2, "Non-Screening Appointment" =2, "Random" = 2, "Screening Appointment" = 2, "Other" = 2,"None of These Apply" = 2, " "=1)) %>% landscape() %>% footnote(general='Frequency (%) of Total Active Recruits of each Campaign Type by Site',general_title = "Note:", footnote_as_chunk = T)

knitr::kable(optout1.sites[,c(9,4,8,7)],caption = 'Table 34. Total Number of Pre-Consent Opt-Outs by Site',col.names=c("Site","Total Opt-Outs", "Percent %", "Total Active Recruits"), format.args = list(big.mark = ","), row.names=FALSE, align=c("l","c","c","c")) %>% add_indent(c(1:9)) %>% footnote(general=c('Frequency (%) of Overall Active Recruits of Connect.','KP not yet sending Opt-Out data'),general_title = "Note:", footnote_as_chunk = T)

Table35_precst_act1 

knitr::kable(Table36_optreasons[,c(2:12),],caption = 'Table 36. Pre-Consent Opt-Out Reasons Among Those That Opted Out', row.names=FALSE, align=c("l", "c", "c","c", "c", "c", "c", "c", "c", "c","c","c"))%>%  kable_styling(latex_options = "scale_down") %>% add_indent(c(1:33)) %>% landscape() %>% footnote(general=c('UChicago and KP sites are not currently sending data on opt-outs.','Frequency (%) of Total Opt-Outs by Site'),general_title = "Note:", footnote_as_chunk = T)

work_flow_a  %>% kable_styling(latex_options = "scale_down")

work_flow_act  %>% kable_styling(latex_options = "scale_down") 

work_flow_pass  %>% kable_styling(latex_options = "scale_down")

colnames(table40_Tm_recr_sign)[3:9] <- c("Min","Q1","Median","Mean","SD","Q3","Max")
knitr::kable(table40_Tm_recr_sign[,c(1,10,2:9)],digits=2,caption = 'Table 40. Time From Active Recruitment to Sign-In in Days', col.names=linebreak(c("Site","Recruitment \nType","Total Active \nSign-In", "Min","Q1","Median","Mean","SD","Q3","Max")),row.names=FALSE, format.args = list(big.mark = ","), linesep = "", booktabs = T,align=c("l", "c", "c","c", "c", "c", "c", "c", "c"),escape=F) %>% kable_styling(latex_options = "scale_down",font_size=12) %>% add_indent(c(1:9)) %>% footnote(general="Excludes those with sign in time later than consent time (data being corrected).",general_title="Note:",footnote_as_chunk = T)
#Total Active Sign-In after excluding participants whose sign-in time was before active recruitment time (data being corrected)--previous footnote (Mar 29,2023)


colnames(table41_Tm_signin_cst.act1)[4:10] <- c("Min","Q1","Median","Mean","SD","Q3","Max")
knitr::kable(table41_Tm_signin_cst.act1,digits=2,format.args = list(big.mark = ","),caption = 'Table 41a. Time From Sign-In to Consent in Minutes Among Active Recruits',booktabs=T, linesep = "", col.names=linebreak(c("Site","Recruitment \n Type","Number \nConsent", "Min","Q1","Median","Mean","SD","Q3","Max")),row.names=FALSE, align=c("l", "c", "c","c", "c", "c", "c", "c", "c"),escape=F) %>% kable_styling(latex_options = "scale_down",font_size=12) %>% add_indent(c(1:9)) %>% footnote(general="Excludes those with sign in time later than consent time (data being corrected).",general_title="Note:",footnote_as_chunk = T)

#colnames(table11_Tm_signin_cst.pas)[4:10,] <- c("Min","Q1","Median","Mean","SD","Q3","Max")
knitr::kable(table41_Tm_signin_cst.pas1[,c(1,2,4:11)],digits=2,format.args = list(big.mark = ","),caption = 'Table 41b. Time From Sign-In to Consent in Minutes Among Passive Recruits',col.names=linebreak(c("Site","Recruitment \n Type","Number \nConsent", "Min","Q1","Median","Mean","SD","Q3","Max")), booktabs=T, linesep = "", row.names=FALSE, align=c("l", "c", "c","c", "c", "c", "c", "c", "c"),escape=F) %>% kable_styling(latex_options = "scale_down",font_size=12) %>% add_indent(c(1:9)) %>% footnote(general="Excludes those with sign in time later than consent time (data being corrected).",general_title="Note:",footnote_as_chunk = T)

colnames(table42_Tm_consent_prof.act1)[5:11] <- c("Min","Q1","Median","Mean","SD","Q3","Max")
knitr::kable(table42_Tm_consent_prof.act1[,c(1,2,4:11)],digits=2,caption = 'Table 42a. Time From Consent to User Profile Submitted in Minutes Among Active Recruits', format.args = list(big.mark = ","), col.names=linebreak(c("Site","Recruitment \n Type","Number UP \nto Submit", "Min","Q1","Median","Mean","SD","Q3","Max")), row.names=FALSE, booktabs = T, linesep = "", align=c("l", "c", "c","c", "c", "c", "c", "c", "c"),escape=F) %>% kable_styling(latex_options = "scale_down",font_size=12) %>% add_indent(c(1:9))
 
colnames(table42_Tm_consent_prof.pas)[5:11] <- c("Min","Q1","Median","Mean","SD","Q3","Max")
knitr::kable(table42_Tm_consent_prof.pas[,c(1,2,4:11)],digits=2,caption = 'Table 42b. Time From Consent to User Profile Submitted in Minutes Among Passive Recruits', format.args = list(big.mark = ","), col.names=linebreak(c("Site","Recruitment \n Type","Number UP \nto Submit", "Min","Q1","Median","Mean","SD","Q3","Max")), row.names=FALSE, booktabs = T, linesep = "", align=c("l", "c", "c","c", "c", "c", "c", "c", "c"),escape=F)  %>% kable_styling(latex_options = "scale_down",font_size=14) %>% add_indent(c(1:9))

colnames(table43_Tm_prof_verif.act)[3:9] <- c("Min","Q1","Median","Mean","SD","Q3","Max")
table43_Tm_prof_verif.act <- table43_Tm_prof_verif.act[,c(1,10,2:9)] 

knitr::kable(table43_Tm_prof_verif.act, digits=2,caption = 'Table 43a. Time From User Profile Submitted to Verification Complete in Days Among Active Recruits', row.names=FALSE, col.names=linebreak(c("Site","Recruitment \n Type","Total UP \nSubmitted", "Min","Q1","Median","Mean","SD","Q3","Max")), format.args = list(big.mark = ","), booktabs = T, linesep = "", align=c("l", "c", "c","c", "c", "c", "c", "c", "c"),escape=F)  %>% kable_styling(latex_options = "scale_down",full_width = F,font_size=12) %>% add_indent(c(1:9))  %>%    column_spec(4,width = "1cm") %>%
  column_spec(5,width = "1cm") %>%
    column_spec(6,width = "1cm") %>%
  column_spec(7,width = "1cm") %>% 
     column_spec(8,width = "1cm") %>%
  column_spec(9,width = "1cm") 
# %>%
#   footnote(general=c("Total UP Submitted are the total number of Active Recruits after UP submission to Verification", 
#            "excluding participants whose UP submitted time was after their verification time"),general_title = "Note:",footnote_as_chunk = T,threeparttable = T) 

colnames(table43_Tm_prof_verif.pas)[5:11] <- c("Min","Q1","Median","Mean","SD","Q3","Max")
knitr::kable(table43_Tm_prof_verif.pas[,c(1,2,4:11)],digits=2,caption = 'Table 43b. Time From User Profile Submitted to Verification Complete in Days among Passive Recruits',format.args = list(big.mark = ","),col.names=linebreak(c("Site","Recruitment \n Type","Total UP \nSubmitted", "Min","Q1","Median","Mean","SD","Q3","Max")), row.names=FALSE, booktabs = T, linesep = "", align=c("l", "c", "c","c", "c", "c", "c", "c", "c","c"),escape=F) %>% kable_styling(latex_options = "scale_down",font_size=12) %>% add_indent(c(1:9)) 
# %>% 
#   footnote(general ="Total UP Submitted are the total number of Passive Recruits after UP submission to Verification",general_title = "Note:",footnote_as_chunk = T)

colnames(table44_Tm_enroll_verif.act)[3:10] <- c("Min","Q1","Median","Mean","SD","Q3","Max","Recruitment Type")
knitr::kable(table44_Tm_enroll_verif.act[,c(1,10,2:9)],digits=2,format.args = list(big.mark = ","),caption = 'Table 44a. Total Enrollment Time in Days Among Active Recruits', col.names=linebreak(c("Site","Recruitment \n Type","Total Verification \nComplete", "Min","Q1","Median","Mean","SD","Q3","Max")), row.names=FALSE, booktabs = T, linesep = "", align=c("l", "c", "c","c", "c", "c", "c", "c", "c","c"),escape=F) %>% kable_styling(latex_options = "scale_down",full_width = F,font_size=14) %>% add_indent(c(1:9)) %>% 
   column_spec(4,width = "1cm") %>%
  column_spec(5,width = "1cm") %>%
    column_spec(6,width = "1cm") %>%
  column_spec(7,width = "1cm") %>% 
     column_spec(8,width = "1cm") %>%
  column_spec(9,width = "1cm")%>%
  footnote(general=c("Total Enrollment Time is from time became an active recruit to time verification process was completed."),general_title="Note:",footnote_as_chunk = T,threeparttable = T)

colnames(table44_Tm_enroll_verif.pas)[4:10] <- c("Min","Q1","Median","Mean","SD","Q3","Max")
knitr::kable(table44_Tm_enroll_verif.pas[,c(1,12,2,4:10)],digits=2,format.args = list(big.mark = ","),caption = 'Table 44b. Total Enrollment Time From Sign-In to Verification in Days Among Passive Recruits', col.names=linebreak(c("Site","Recruitment \n Type","Total Verification \nComplete", "Min","Q1","Median","Mean","SD","Q3","Max")), row.names=FALSE, booktabs = T, linesep = "", align=c("l", "c", "c","c","c", "c", "c", "c", "c", "c"),escape=F) %>% kable_styling(latex_options = "scale_down",font_size=12) %>% add_indent(c(1:9)) 

table45_age %>% kable_styling(latex_options = "scale_down") %>% footnote(general = 'Based on de-identified data sent by sites',general_title = "Note:",footnote_as_chunk = T)

table46_race %>% footnote(general = 'Based on de-identified data sent by sites',general_title = "Note:",footnote_as_chunk = T)

table47%>% kable_styling(font_size=8) %>% footnote(general = 'Based on de-identified data sent by sites',general_title = "Note:",footnote_as_chunk = T)

table48_ageall  %>% kable_styling(latex_options = "scale_down")%>% footnote(general = 'Based on de-identified data sent by sites',general_title = "Note:",footnote_as_chunk = T)

table49_raceall%>% footnote(general = 'Based on de-identified data sent by sites',general_title = "Note:",footnote_as_chunk = T)

table50_sexall %>% kable_styling(latex_options = "scale_down")%>% footnote(general = 'Based on de-identified data sent by sites',general_title = "Note:",footnote_as_chunk = T)

```

```{r,echo=FALSE,include=FALSE}
##to get the refusal and withdrawl data
 currentDate <- Sys.Date()
# ##to create a data of the particpants with previous cancer history among those user profile complete
 # write.csv(ca_hist[,c("token","Connect_ID","site", "age","sex", "race","Verification status","Recruitment type","User Profile submitted","Previous Cancer","Cancer Year","RcrtV_CStatusMatch_v1r0")], paste("~/Documents/Connect_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/prod_previous_cancer_cases_profile_complete_",currentDate,".csv",sep=""), row.names = F,na="")
# # 

refwd_type1 <- c("d_685002411_d_217367618","d_685002411_d_994064239","d_685002411_d_194410742","d_685002411_d_949501163","d_685002411_d_277479354","d_685002411_d_867203506","d_685002411_d_352996056","d_726389747","d_906417725","d_773707518","d_831041022","d_987563196","d_747006172")
refwd_date <- c("d_657475009","d_982105411","d_390198398","d_808663245","d_262357957","d_974100830","d_711256590","d_161366008","d_614264509","d_664453818","d_269050420","d_672401635","d_659990606")

  refwd_reasons <- c("d_919699172","d_141450621","d_576083042","d_431428747","d_121430614","d_523768810","d_639172801","d_175732191","d_150818546","d_624030581","d_285488731","d_596510649","d_866089092","d_990579614","d_131458944","d_372303208","d_777719027","d_620696506","d_352891568","d_958588520","d_875010152","d_404289911","d_538619788","d_734828170")

  refwd.main1 <- c("d_297147359_d_297147359","d_719222792_d_719222792","d_603278289_d_603278289","d_175506524_d_175506524","d_299274441_d_299274441","d_524352591_d_524352591","d_726389747","d_123868967","d_153713899","d_715390138")
  refwd_date1 <- c("d_657475009","d_982105411","d_390198398","d_808663245","d_262357957","d_711256590","d_161366008","d_614264509","d_664453818","d_269050420","d_659990606","d_613641698","d_119449326","d_113579866")

  rewd <- data[,c("token","Connect_ID", "site", "verified","d_827220437","recrt_steps_v1r0","d_821247024", refwd.main1,refwd_type1,refwd_date1,refwd_reasons)] 
#
#on Jan. 12, these variables are not shown in the prod.participants table: d_297147359_d_366295286,d_299274441_d_457532784,d_672401635,d_764403541,d_603278289_d_821930940,d_524352591_d_902332801,d_175506524_d_905787778,d_719222792_d_993855378,d_974100830,d_175506524_d_175506524,
 act_ls <- colnames(rewd)[grepl("685002411",colnames(rewd))]
rfact_ls <- c(act_ls,"d_906417725","d_773707518","d_747006172","d_831041022")
rewd$rfwdact <-0
for (i in 1: length(rfact_ls)){
  rfact_c <- ifelse((rewd[,rfact_ls[i]]==104430631 | is.na(rewd[,rfact_ls[i]])),0,1)
  rewd$rfwdact <- rewd$rfwdact + rfact_c
}

rewd$refwd_yes <- ifelse(rewd$rfwdact >0,353358909,104430631 ) #59


rewd$refwd.cases=0
refwd_cases <- list()
 
for (i in 1:13){

  case <- rewd[,c("token","Connect_ID","d_827220437",refwd_type1[i])]
  colnames(case) <-c("token","Connect_ID","d_827220437","refwd_yes")
  case$refwd_type <- refwd_type1[i]
  #case$refw_date_name <- refwd_date[i]
  refwd_cases[[i]] <- as.data.frame(case[which(case$refwd_yes == 353358909),])
  case <- ifelse(is.na(rewd[,refwd_type1[i]]), 0, ifelse(rewd[,refwd_type1[i]]== 353358909,1,0))
  rewd$refwd.cases=case+rewd$refwd.cases
}
refwd_cases1 <-  refwd_cases[sapply(refwd_cases , function(x) dim(x)[1]) >0]
refwd_yes <- do.call('rbind',refwd_cases1)
length(unique(refwd_yes$token)) #60
table(refwd_yes$refwd_type)
# # 
 #refwd.cases <- merge(rewd[which(rewd$refwd.cases>0),c(1:25, 27:67)], refwd_175506524,by="token")
 refwd.cases <- rewd[which(rewd$refwd.cases>0),]
 refwd.cases$date.max <- apply(refwd.cases[,refwd_date1 ],1, max, na.rm=T)
 refwd.cases$date.max <- as_date(ymd_hms(refwd.cases$date.max))
 refwd.cases$case.dates <- do.call(paste,c(refwd.cases[refwd_date1],sep=","))

 refwd.cases$case.dates <- gsub("NA,|,NA","",refwd.cases$case.dates )

refwd.cases1 <- refwd.cases
refwd.cases1[refwd.cases==104430631] <- NA
 refwd.cases1[,(colnames(refwd.cases1) %in% refwd_type1)] <- lapply(refwd.cases[,(colnames(refwd.cases) %in% refwd_type1)],function(x) replace(x,x==104430631,NA))
 
tmp <- refwd.cases1
refwd_all <- c(refwd_type1,refwd.main1)
for (i in 1:length(refwd_all)){
  x <- "d_297147359_d_297147359"
  x <- refwd_all[i]
  CID <- sapply(strsplit(paste0(x),"_"),tail,1)
  varname <- dd$`Variable Name`[grepl(CID,dd$CID)]
  type.labels <- dd$`Variable Label`[grepl(CID,dd$CID)]
  check <- as.data.frame(tmp[,grepl(x, colnames(tmp))])
  check$checkout <- ifelse(check[,1]== 353358909 , type.labels,
                           ifelse(check[,1] ==648459216, "The participant (via the CSC directly or via a Connect site staff)",
                                ifelse(check[,1] ==  658808644, "The Connect Principal Investigator (or designate)",
                                    ifelse(check[,1] ==  745366882, "The Chair of the Connect IRB-of-record (NIH IRB)",
                                        ifelse(check[,1] ==786757575, "Site PI listed on the site-specific consent form",
                                            ifelse(check[,1]  ==847056701, "Chair of the Site IRB",
                                                ifelse(check[,1] ==807835037, "Other", NA)))))))

  tmp<- cbind(tmp,check[,"checkout"])
  colnames(tmp)[ncol(tmp)]<- varname
}

####
unique(y[grepl("658808644|745366882|786757575|847056701|807835037",y$conceptId.4),c("conceptId.4","Current.Format.Value")])
#      conceptId.4                                Current.Format.Value
# 436    807835037                                       55=Other |__|
# 663    658808644 1=The Connect Principal Investigator (or designate)
# 664    745366882  2=The Chair of the Connect IRB-of-record (NIH IRB)
# 665    786757575  3=Site PI listed on the site-specific consent form
# 666    847056701                             4=Chair of the Site IRB
# 946    807835037                                     55 = Other |__|
# 2535   807835037                                    55 =  Other |__|
for (i in 1:length(refwd_reasons)){
    x <- refwd_reasons[i]
  CID <- sapply(strsplit(paste0(x),"_"),tail,1)
  varname <- dd$`Variable Name`[grepl(CID,dd$CID)]
  type.labels <- dd$`Variable Label`[grepl(CID,dd$CID)]
  check <- as.data.frame(tmp[,grepl(x, colnames(tmp))])
  check$reasons <- ifelse(check[,1]== 353358909, type.labels,NA)
  #tmp<- cbind(tmp,check[,"checkout"])
  tmp$reasons <-   paste(tmp$reasons,check$reasons,sep=",")
}

tmp$reasons <- gsub(",NA,|NA,","",tmp$reasons)
tmp$reasons <- gsub(",I","I",tmp$reasons)

for (i in 1:length(refwd_date1)){
  x <- refwd_date1[i]
  CID <- sapply(strsplit(paste0(x),"_"),tail,1)
  varname <- dd$`Variable Name`[grepl(CID,dd$CID)]
  colnames(tmp)[which(colnames(tmp)==x)] <- varname

}

refwd.cases.notes <- tmp[,which(grepl("v1r0", colnames(tmp)) | colnames(tmp) %in% c("Connect_ID","token","site","verified","reasons","date.max","case.dates","recrt_steps_v1r0"))]

 currentDate <- Sys.Date()




# write.csv(refwd.cases.notes[,which(!grepl("Date",colnames(refwd.cases.notes)))],paste("~/Documents/Connect_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/prod_refusal_withdrawl_cases_",currentDate,".csv",sep=""),row.names = F,na="")
#levels=c("HealthPartners", "Henry Ford Health System","Marshfield Clinic Health System", "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado", "Kaiser Permanente   Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest")

#folder <- c(141622949146,141623034772,141623623841,141622125003,141623855895,142482879711,142480938244,142481904303,142481813411)
 
#  for (i in 1:length(levels(refwd.cases.notes$site))) {
    # id=folder[i]
    # box_setwd(dir_id = id)
    # box_write(object =refwd.cases.notes[which(refwd.cases.notes$site == levels(refwd.cases.notes$site)[i]), which(!grepl("Date",colnames(refwd.cases.notes)))],file_name=paste("RefusalWithdrawl_cases_",site,currentDate,".csv",sep=""),row.names = F,na="") #to save the box folders

   # write.csv(refwd.cases.notes[which(refwd.cases.notes$site == levels(refwd.cases.notes$site)[i]),which(!grepl("Date",colnames(refwd.cases.notes)))],paste("~/Documents/Connect_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/RefusalWithdrawl_cases_",site,currentDate,".csv",sep=""),row.names = F,na="")
#  }
 
 if (write_to_box){
   box_auth(client_id = "627lww8un9twnoa8f9rjvldf7kb56q1m",
            client_secret = "gSKdYKLd65aQpZGrq9x4QVUNnn5C8qqm")
   box_setwd(dir_id = 141543243283) #/CONNECT_DCEG ONLY/Connect Reports_DCEG ONLY/Refusal and Withdrawal Reports_DCEG
   box_write(object = refwd.cases.notes[,which(!grepl("Date",colnames(refwd.cases.notes)))], 
             file_name = paste("RefusalWithdrawl_cases_",currentDate,".csv",sep=""),
             row.names = F, na="")
   
   box_setwd(dir_id=141622949146)
   box_write(object = refwd.cases.notes[which(refwd.cases.notes$site == "HealthPartners"), which(!grepl("Date",colnames(refwd.cases.notes)))],
             file_name=paste("RefusalWithdrawl_cases_HealthPartner_",currentDate,".csv",sep=""),row.names = F,na="")
   
   box_setwd(dir_id=141623034772)
   box_write(object = refwd.cases.notes[which(refwd.cases.notes$site == "Henry Ford Health System"), which(!grepl("Date",colnames(refwd.cases.notes)))],
             file_name=paste("RefusalWithdrawl_cases_Henry_Ford_ Health_System_",currentDate,".csv",sep=""),row.names = F,na="")
   
   box_setwd(dir_id=141623623841)
   box_write(object = refwd.cases.notes[which(refwd.cases.notes$site == "Marshfield Clinic Health System"), which(!grepl("Date",colnames(refwd.cases.notes)))],
             file_name=paste("RefusalWithdrawl_cases_Marshfield_ Clinic_Health_System_",currentDate,".csv",sep=""),row.names = F,na="")
   
   box_setwd(dir_id=141622125003)
   box_write(object = refwd.cases.notes[which(refwd.cases.notes$site == "Sanford Health"), which(!grepl("Date",colnames(refwd.cases.notes)))],
             file_name=paste("RefusalWithdrawl_cases_Sanford_ Health_",currentDate,".csv",sep=""),row.names = F,na="")
   
   box_setwd(dir_id=141623855895)
   box_write(object = refwd.cases.notes[which(refwd.cases.notes$site == "University of Chicago Medicine"), which(!grepl("Date",colnames(refwd.cases.notes)))],
             file_name=paste("RefusalWithdrawl_cases_University_of_ Chicago_Medicine_",currentDate,".csv",sep=""),row.names = F,na="")
   
   box_setwd(dir_id=,142482879711)
   box_write(object = refwd.cases.notes[which(refwd.cases.notes$site == "Kaiser Permanente Colorado"), which(!grepl("Date",colnames(refwd.cases.notes)))],
             file_name=paste("RefusalWithdrawl_cases_Kaiser_ Permanente_Colorado_",currentDate,".csv",sep=""),row.names = F,na="")
   
   box_setwd(dir_id=,142480938244)
   box_write(object = refwd.cases.notes[which(refwd.cases.notes$site == "Kaiser Permanente Georgia"), which(!grepl("Date",colnames(refwd.cases.notes)))],
             file_name=paste("RefusalWithdrawl_cases_HealthPartner_",currentDate,".csv",sep=""),row.names = F,na="")
   
   box_setwd(dir_id=142481904303)
   box_write(object = refwd.cases.notes[which(refwd.cases.notes$site == "Kaiser Permanente Hawaii"), which(!grepl("Date",colnames(refwd.cases.notes)))],
             file_name=paste("RefusalWithdrawl_cases_Kaiser _Permanente_Hawai_",currentDate,".csv",sep=""),row.names = F,na="")
   
   box_setwd(dir_id=142481813411)
   box_write(object = refwd.cases.notes[which(refwd.cases.notes$site == "Kaiser Permanente Northwest"), which(!grepl("Date",colnames(refwd.cases.notes)))],
             file_name=paste("RefusalWithdrawl_cases_Kaiser_ Permanente_Northwest_", currentDate, ".csv",sep=""),row.names = F,na="")
 }


# ##This is a list of people who have completed their baseline surveys (all 4 modules) and have not yet given any biospecimens. updated by Michelle "We don’t need these reports to be run on a regular basis. Please keep the code as we may come back to it in the future." on March 27, 2023 via Team

# ##HP: https://nih.app.box.com/folder/141622949146
# SH: https://nih.app.box.com/folder/141622125003
# Marshfield: https://nih.app.box.com/folder/141623623841
# KPCO: https://nih.app.box.com/folder/142482879711
# KPGA: https://nih.app.box.com/folder/142480938244
# KPHI: https://nih.app.box.com/folder/142481904303
# KPNW: https://nih.app.box.com/folder/142481813411
# HFHS: https://nih.app.box.com/folder/141623034772
# UC: https://nih.app.box.com/folder/141623855895
#to save into the folders in Box
 veri_surM_bios <- data %>% filter(d_821247024==197316935) %>% select(Connect_ID, token,d_821247024,d_827220437,d_949302066,d_536735468,d_663265240,d_976570371,d_878865966,d_167958071,d_684635302) %>%
   mutate(basesurv.cmplt =case_when(d_949302066 == 231311385 & d_536735468 == 231311385 & d_663265240 == 231311385 & d_976570371 == 231311385 ~ 1,
                                    d_949302066 != 231311385 | d_536735468 != 231311385 | d_663265240 != 231311385 | d_976570371 != 231311385 ~ 0),
          biospe.cmplt = case_when(d_878865966 == 353358909 & d_167958071 == 353358909 & d_684635302 == 353358909 ~ 1,
                                   d_878865966 != 353358909 | d_167958071 != 353358909 | d_684635302 != 353358909 ~ 0),
          AllModules = case_when(d_949302066 == 231311385 & d_536735468 == 231311385 & d_663265240 == 231311385 & d_976570371 == 231311385 ~ "Completed all 4 modules",
                                    d_949302066 != 231311385 | d_536735468 != 231311385 | d_663265240 != 231311385 | d_976570371 != 231311385 ~ "Did not complete all 4 modules"),
         NoSamples = case_when(d_878865966 == 104430631 & d_167958071 == 104430631 & d_684635302 == 104430631 ~ "Has not given any biospecimens",
                               d_878865966 != 104430631 | d_167958071 != 104430631 | d_684635302 != 104430631 ~ "Has given biospecimens"),
          Site = case_when(d_827220437 == 125001209 ~ "KPCO",
                           d_827220437 == 327912200  ~ "KPGA",
                           d_827220437 == 300267574  ~ "KPHI" ,
                           d_827220437 == 452412599  ~ "KPNW",
                           d_827220437 == 303349821  ~ "Marshfield",
                           d_827220437 == 531629870  ~ "HP",
                           d_827220437 == 548392715  ~ "HFHS",
                           d_827220437 == 657167265  ~ "SH",
                           d_827220437 == 809703864  ~ "UoCh",
                           d_827220437 == 517700004 | d_827220437 == 181769837 ~ "NIH"))

 ###biospecimen outreach data
 biospe_outreach <- veri_surM_bios %>% filter(biospe.cmplt==0 & basesurv.cmplt==1) %>%
  mutate(AllModules = case_when(d_949302066 == 231311385 & d_536735468 == 231311385 & d_663265240 == 231311385 & d_976570371 == 231311385 ~ "Completed all 4 modules",
                                    d_949302066 != 231311385 | d_536735468 != 231311385 | d_663265240 != 231311385 | d_976570371 != 231311385 ~ "Did not complete all 4 modules"),
         NoSamples = case_when(d_878865966 == 104430631 & d_167958071 == 104430631 & d_684635302 == 104430631 ~ "Has given biospecimens",
                               d_878865966 != 104430631 | d_167958071 != 104430631 | d_684635302 != 104430631 ~ "Has not given any biospecimens") ) %>% select(Site,Connect_ID,AllModules,NoSamples)

 # for (site in unique(veri_surM_bios$Site)) {
 #     biospe_outreach <- veri_surM_bios %>% filter(NoSamples=="Has not given any biospecimens" & Site==site) %>% dplyr::select(Site,Connect_ID,AllModules,NoSamples)
 # 
 # write.csv(biospe_outreach,paste("~/Documents/Connect_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/Biospecimen_Outreach_", site, "_",currentDate,".csv",sep=""),row.names = F,na="")
 # }
# HP: https://nih.app.box.com/folder/181137100949
# SH: https://nih.app.box.com/folder/181135654302
# Marshfield: https://nih.app.box.com/folder/180317179457
# KPCO: folder not created yet since they have not requested this report yet, but you can create a folder here if/when they do https://nih.app.box.com/folder/142480515611
# KPGA: folder not created yet since they have not requested this report yet, but you can create a folder here if/when they do https://nih.app.box.com/folder/142482311776
# KPHI: folder not created yet since they have not requested this report yet, but you can create a folder here if/when they do https://nih.app.box.com/folder/142482837728
# KPNW: folder not created yet since they have not requested this report yet, but you can create a folder here if/when they do https://nih.app.box.com/folder/142482134697
# HFHS: https://nih.app.box.com/folder/180318540046
# UC: folder not created yet since they have not requested this report yet, but you can create a folder here if/when they do https://nih.app.box.com/folder/141623373381
 
# box_setwd(dir_id=181137100949)
# biospe_outreach_HP <- veri_surM_bios %>% filter(NoSamples=="Has not given any biospecimens" & Site=="HealthPartners") %>% dplyr::select(Site,Connect_ID,AllModules,NoSamples)
# box_write(object = biospe_outreach_HP,file_name=paste("Biospecimen_Outreach_HealthPartner_",currentDate,".csv",sep=""),row.names = F,na="")
# 
# box_setwd(dir_id=180318540046)
# biospe_outreach_HFHS <- veri_surM_bios %>% filter(NoSamples=="Has not given any biospecimens" & Site=="Henry Ford Health System") %>% dplyr::select(Site,Connect_ID,AllModules,NoSamples)
# box_write(object = biospe_outreach_HFHS,file_name=paste("Biospecimen_Outreach__Henry_Ford_ Health_System_",currentDate,".csv",sep=""),row.names = F,na="")
# 
# box_setwd(dir_id=180317179457)
# box_write(object = veri_surM_bios[which(veri_surM_bios$NoSamples=="Has not given any biospecimens" & veri_surM_bios$Site == "Marshfield Clinic Health System"),c("Site","Connect_ID","AllModules","NoSamples")],file_name=paste("Biospecimen_Outreach_Marshfield_ Clinic_Health_System_",currentDate,".csv",sep=""),row.names = F,na="")
# 
# box_setwd(dir_id=181135654302)
# box_write(object = veri_surM_bios[which(veri_surM_bios$NoSamples=="Has not given any biospecimens" & veri_surM_bios$Site == "Sanford Health"), c("Site","Connect_ID","AllModules","NoSamples")], file_name=paste("Biospecimen_Outreach_Sanford_ Health_",currentDate,".csv",sep=""),row.names = F,na="")
# 
# box_setwd(dir_id=141623373381)
# box_write(object = veri_surM_bios[which(veri_surM_bios$NoSamples=="Has not given any biospecimens" & veri_surM_bios$Site == "University of Chicago Medicine"),c("Site","Connect_ID","AllModules","NoSamples")], file_name=paste("Biospecimen_Outreach__University_of_ Chicago_Medicine_",currentDate,".csv",sep=""), row.names = F,na="")

# box_setwd(dir_id=,142482879711)
# box_write(object = veri_surM_bios[which(veri_surM_bios$NoSamples=="Has not given any biospecimens" & veri_surM_bios$Site == "Kaiser Permanente Colorado"),c("Site","Connect_ID","AllModules","NoSamples")], file_name=paste("Biospecimen_Outreach__Kaiser_ Permanente_Colorado_",currentDate,".csv",sep=""),row.names = F,na="")
# 
# box_setwd(dir_id=,142480938244)
# box_write(object = veri_surM_bios[which(veri_surM_bios$NoSamples=="Has not given any biospecimens" & veri_surM_bios$Site == "Kaiser Permanente Georgia"), c("Site","Connect_ID","AllModules","NoSamples")], file_name=paste("Biospecimen_Outreach_Kaiser Permanente Georgia_",currentDate,".csv",sep=""),row.names = F,na="")
# 
# box_setwd(dir_id=142481904303)
# box_write(object = refwd.cases.notes[which(refwd.cases.notes$site == "Kaiser Permanente Hawaii"), which(!grepl("Date",colnames(refwd.cases.notes)))],file_name=paste("Biospecimen_Outreach_Kaiser _Permanente_Hawai_",currentDate,".csv",sep=""),row.names = F,na="")
# 
# box_setwd(dir_id=142481813411)
# box_write(object = refwd.cases.notes[which(refwd.cases.notes$site == "Kaiser Permanente Northwest"), which(!grepl("Date",colnames(refwd.cases.notes)))], file_name=paste("Biospecimen_Outreach_Kaiser_ Permanente_Northwest_", currentDate, ".csv",sep=""),row.names = F,na="")

 

```


```{r eval=TRUE,echo=FALSE}
options(knitr.table.format = "latex")
options(kableExtra.auto_format = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
currentDate <- Sys.Date()
###to generate the date for each activity
# # # ##incentive data
  incentive <- data %>% dplyr::filter(d_130371375_d_266600170_d_731498909==353358909 & d_827220437==809703864) %>% dplyr::select(token,site,d_130371375_d_266600170_d_731498909,d_130371375_d_266600170_d_222373868,d_130371375_d_266600170_d_787567527)

   incentive <- incentive %>% mutate(Eligible.for.Payment=case_when(d_130371375_d_266600170_d_731498909 ==353358909~"YES"),
           NORC.Payment.Eligibility=case_when(d_130371375_d_266600170_d_222373868 ==353358909 ~"YES",
                                      d_130371375_d_266600170_d_222373868 ==104430631 ~"NO"),
           Time.Payment.Eligible.for.Round = ymd_hms(d_130371375_d_266600170_d_787567527))

   incentive_nonchi <- data %>% dplyr::filter(d_130371375_d_266600170_d_731498909==353358909 & d_827220437!=809703864) %>% dplyr::select(token,site,d_130371375_d_266600170_d_731498909,d_130371375_d_266600170_d_222373868,d_130371375_d_266600170_d_787567527)

   incentive_nonchi <- incentive_nonchi %>% mutate(Eligible.for.Payment=case_when(d_130371375_d_266600170_d_731498909 ==353358909~"YES"),
           NORC.Payment.Eligibility=case_when(d_130371375_d_266600170_d_222373868 ==353358909 ~"YES",
                                      d_130371375_d_266600170_d_222373868 ==104430631 ~"NO"),
           Time.Payment.Eligible.for.Round = ymd_hms(d_130371375_d_266600170_d_787567527))

if (write_to_box) {
     box_auth(client_id = "627lww8un9twnoa8f9rjvldf7kb56q1m",
              client_secret = "gSKdYKLd65aQpZGrq9x4QVUNnn5C8qqm")
     
     box_setwd(dir_id = 167284102961)
     
     box_write(object = incentive[,c("token","site","NORC.Payment.Eligibility","Eligible.for.Payment","Time.Payment.Eligible.for.Round")], 
               file_name =paste("Incentives_Weekly_Report_NORC",currentDate,".csv",sep=""))
     
     box_write(object = incentive_nonchi[,c("token","site","NORC.Payment.Eligibility","Eligible.for.Payment","Time.Payment.Eligible.for.Round")], 
               file_name =paste("Incentives_Weekly_Report_OTHERSITES_",currentDate,".csv",sep=""))
}
```


```{r,echo=FALSE,include=FALSE}
###here I have combined the weekly log tables in this Consolidated weekly report because they are working on the same recruitment data
modules <- c("d_100767870","d_949302066","d_536735468","d_663265240","d_976570371","d_517311251","d_832139544","d_264644252","d_770257102")
##for biospecimen 
# recrver1$BioFin_BaseMWCol_v1r0  <-factor(recrver1$d_684635302,exclude=NULL)
# recrver1$BioFin_BaseBloodCol_v1r0 <- factor(recrver1$d_878865966,exclude=NULL)
# recrver1$BioFin_BaseUrineCol_v1r0 <- factor(recrver1$d_167958071,exclude=NULL)
# recrver1$SrvBLM_ResSrvCompl_v1r0 <-factor(recrver1$d_265193023,exclude=NULL)
# recrver1$BL_BioSpm_MWSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_915179629,levels=c("Clinical","Research","Home"))
# recrver1$BL_BioSpm_UrineSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_718172863, levels=c("Clinical","Research","Home"))
# recrver1$BL_BioSpm_BloodSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_592099155,levels=c("Clinical","Research","Home"))

###For research collections you can the baseline BioFin_ variables for blood, urine, mouthwash. 
##research collection time:
# 170 d_173836415_d_266600170_d_561681068                                 Date/time Research Blood Collected
# d_173836415_d_266600170_d_847159717                                 Date/time Research Urine Collected
#d_173836415_d_266600170_d_448660695                                      Date/time Mouthwash Collected
###For clinical samples you can use the 'any clinical sample' variable that includes blood or urine.
#d_173836415_d_266600170_d_139245758                                 Date/time Clinical Urine Collected
# d_173836415_d_266600170_d_982213346                                 Date/time Clinical Blood Collected
#on the clinical biospecimen collection that not every participants had their blood or urine collection time as d_173836415_d_266600170_d_982213346 Date/time Clinical Blood Collected (BioClin_ClinBloodTime_v1r0), but all of participants with clinical blood collections should have their blood receiving time as d_173836415_d_266600170_d_398645039 (BioClin_DBBloodRRLDt_v1r0), same as the clinical urine collections, confirmed with Michelle "that sounds right. The clinical collection times BioClin_ClinBloodTime_v1r0 and BioClin_ClinUrineTime_v1r0 will come a few days later." Therefore, when the collection times of clinical collection are not prompt updated (available), the receiving time can be altenative for those clinical collection without collection times.

bio.col <- c("d_684635302","d_878865966", "d_167958071", "d_173836415_d_266600170_d_915179629", "d_173836415_d_266600170_d_718172863", "d_173836415_d_266600170_d_592099155", "d_173836415_d_266600170_d_561681068", "d_173836415_d_266600170_d_847159717", "d_173836415_d_266600170_d_448660695", "d_173836415_d_266600170_d_139245758", "d_173836415_d_266600170_d_541311218", "d_173836415_d_266600170_d_224596428", "d_173836415_d_266600170_d_740582332", "d_173836415_d_266600170_d_982213346", "d_173836415_d_266600170_d_398645039", "d_173836415_d_266600170_d_822274939")

###clinical collection time:
clc.bldtm <- c("d_173836415_d_266600170_d_769615780","d_173836415_d_266600170_d_822274939","d_173836415_d_266600170_d_398645039","d_173836415_d_266600170_d_982213346","d_173836415_d_266600170_d_740582332")
clc.urinetm <- c("d_173836415_d_266600170_d_139245758","d_173836415_d_266600170_d_224596428","d_173836415_d_266600170_d_541311218","d_173836415_d_266600170_d_939818935","d_173836415_d_266600170_d_740582332")

##the final biospecimen collection time
data$biocol_tm
##incentive eligible
##time eligible:d_130371375_d_266600170_d_787567527 Time Payment Eligible for Round

###refusal and withdrawal:revocation, withdrawal, data destruction
#  659990606 Date withdrew consent                                                                 HdWd_WdConsentDt_v1r0 
# d_664453818 as HdRef_DateHIPAArevoked_v1r0, /* Autoset when HdWd_HIPAA revoked_v1r0 selected*/
# d_269050420 as HdRef_DateDatadestroy_v1r0, /* Autoset when  HdWd_Destroydata_v1r0 selected*/
# d_613641698 as HdWd_DateHIPAArevsign_v1r0, /* Autoset when HdWd_HIPAArevocationsigned_v1r0 selected*/
# d_906417725 as HdWd_Activepart_v1r0, /* Refusing all future activities*/
#   d_831041022 as HdWd_Destroydata_v1r0, /* Destroy data*/
#   d_773707518 as HdWd_HIPAArevoked_v1r0, /* Revoke HIPAA*/
#   d_269050420 as HdRef_DateDatadestroy_v1r0, /* Autoset when  HdWd_Destroydata_v1r0 selected*/
# 2 747006172 Withdraw consent                                              HdWd_WdConsent_v1r0   
# 3 773707518 Revoke HIPAA                                                  HdWd_HIPAArevoked_v1r0
# 4 831041022 Wants data destroyed                                          HdWd_Destroydata_v1r0 
# 5 906417725 Refusing all future activities                                HdWd_Activepart_v1r0  
ref.wd <- c("d_773707518","d_747006172","d_831041022","d_664453818","d_269050420","d_659990606")

var.list <- c("token","Connect_ID","d_821247024","d_914594314","d_512820379","state_d_158291096","d_471593703","d_827220437",
              "d_130371375_d_266600170_d_787567527","d_130371375_d_266600170_d_731498909",bio.col,modules,ref.wd)
requery <- paste(var.list,collapse=",")

veri_resp <- data[which(data$d_512820379 != 486306141 | data$d_821247024 != 922622075 ),var.list] %>%
  mutate(recru_time = ymd_hms(d_471593703),
         verified_time = ymd_hms(d_914594314),
         elgible.time = ymd_hms(d_130371375_d_266600170_d_787567527))
veri_resp$recrstart.date <-  as_date(min(ymd_hms(veri_resp$d_471593703),na.rm=TRUE))


veri_resp <- apply_labels(veri_resp,d_827220437 = "Site",#RcrtES_Site_v1r0
                          d_827220437 = c("HealthPartners"= 531629870, "Henry Ford Health System"=548392715, 
                                          "Kaiser Permanente Colorado" = 125001209, "Kaiser Permanente Georgia" = 327912200,
                                          "Kaiser Permanente Hawaii" = 300267574,"Kaiser Permanente Northwest" = 452412599, 
                                          "Marshfield Clinic Health System" = 303349821,"Sanford Health" = 657167265, 
                                          "University of Chicago Medicine" = 809703864, "National Cancer Institute" = 517700004,
                                          "National Cancer Institute" = 13,"Other" = 181769837))
veri_resp$site <- factor(veri_resp$d_827220437,
                         levels=c("HealthPartners", "Henry Ford Health System","Marshfield Clinic Health System",
                                  "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado",
                                  "Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest",
                                  "National Cancer Institute","Other"))
veri_resp$site <- droplevels(veri_resp$site)
# veri_resp$recru_time <- ymd_hms(veri_resp$d_471593703)
# veri_resp$verified_time <- ymd_hms(veri_resp$d_914594314)
# veri_resp$recrstart.date <- as_date(min(ymd_hms(veri_resp$d_471593703),na.rm=TRUE))
recrstart.date <- as_date(min(ymd_hms(veri_resp$recru_time),na.rm=TRUE))
wday(unique(veri_resp$recrstart.date), week_start = 1)
#[1] 5
as_date(recrstart.date-days(5))
#[1] "2021-07-18" #Sunday the censoring starting day
wday(as_date(recrstart.date-days(5)),week_start=1)
#[1] 1 #Sunday
veri_resp$recruit.week <- ceiling(as.numeric(difftime(as_date(veri_resp$recru_time), as_date(veri_resp$recrstart.date-days(5)),units="days"))/7) #to lock at Monday as the start of week
veri_resp$recruit.week.date <- veri_resp$recrstart.date + days(2) + dweeks(veri_resp$recruit.week-1) #to present the date of the starting date in the following week
summary(as_date(veri_resp$recruit.week.date))
# Min.      1st Qu.       Median         Mean      3rd Qu.         Max. 
# "2021-07-25" "2022-08-14" "2022-11-06" "2022-10-25" "2023-01-15" "2023-03-26" 
veri_resp$verified.week <- ceiling(as.numeric(difftime(as_date(ymd_hms(veri_resp$d_914594314)),as_date(veri_resp$recrstart.date-days(5)),units="days"))/7)
veri_resp$verified.week.date <- (veri_resp$recrstart.date) + days(2)+ dweeks(veri_resp$verified.week-1)

min(as_date(ymd_hms(veri_resp$verified_time)),na.rm=TRUE)
# [1] "2021-07-27"
unique(as_date(min(veri_resp$verified.week.date,na.rm=TRUE)))
#[1] "2021-08-01"
unique(as_date(max(veri_resp$verified.week.date,na.rm=TRUE)))
#[1] "2023-03-26"
wday(as_date(recrstart.date-days(5)),week_start=1)
#7 Sunday
###to create the time censoring variables by week;
#verified  over time:

recruit.wk.active <- veri_resp[which(veri_resp$d_512820379==486306141),] %>% 
  group_by(recruit.week,recruit.week.date) %>%
  dplyr::summarize(active_recruits=n(),
                   recruitdate_max=max(recru_time,rm.na=T))

verified.wk.active <- veri_resp[which(veri_resp$d_821247024 == 197316935 & veri_resp$d_512820379==486306141),] %>% 
  group_by(verified.week,verified.week.date) %>%
  dplyr::summarize(active_verifieds=n(),
                   verified_activetime.max=max(verified_time,rm.na=T))

verified.wk.total <- veri_resp[which(veri_resp$d_821247024 == 197316935),] %>% 
  group_by(verified.week,verified.week.date) %>%
  dplyr::summarize(total_verifieds=n(),
                   verified_time.max=max(verified_time,rm.na=T))

verified.wk.all <- merge(verified.wk.active,verified.wk.total, by.x = c("verified.week","verified.week.date"),by.y=c("verified.week","verified.week.date"),all.y=TRUE,all.x=TRUE)
verified.wk.all$verified.week.date[is.na(verified.wk.all$verified.week.date)]<- recrstart.date + days(3)+ dweeks(verified.wk.all$verified.week-1)
recrui_wk_verified <- merge(recruit.wk.active,verified.wk.all, by.x=c("recruit.week","recruit.week.date"),by.y=c("verified.week","verified.week.date"),all.x=TRUE,all.y=TRUE)
recrui_wk_verified <- recrui_wk_verified %>% 
  mutate_at(c("active_recruits","active_verifieds","total_verifieds"),~replace_na(., 0))

#recrui_wk_verified <- recrui_wk_verified %>% mutate(week.date=as_date(do.call(pmax, c(select(.,ends_with('max')),na.rm=TRUE))))

recrui_wk_verified <- recrui_wk_verified %>% arrange(recruit.week,recruit.week.date)

# passive recruits are the passive verified
recrui_wk_verified$passive_verifieds <- recrui_wk_verified$total_verifieds-recrui_wk_verified$active_verifieds #new passive recruitment
recrui_wk_verified$active_recruits.cum <- cumsum(recrui_wk_verified$active_recruits)
recrui_wk_verified$passive_verifieds.cum <- cumsum(recrui_wk_verified$passive_verifieds)
recrui_wk_verified$active_verifieds.cum <- cumsum(recrui_wk_verified$active_verifieds)

recrui_wk_verified$total_recruits <- recrui_wk_verified$active_recruits + recrui_wk_verified$passive_verifieds ##the total recruits till that week

recrui_wk_verified$total_recruits.cum <- cumsum(recrui_wk_verified$active_recruits + recrui_wk_verified$passive_verifieds) ##the total recruits till that week

recrui_wk_verified$total_verified.cum <- cumsum(recrui_wk_verified$total_verifieds)

#new response rate:
recrui_wk_verified$new.active.response.rate <- ifelse(recrui_wk_verified$active_recruits >0, 100*(recrui_wk_verified$active_verifieds/recrui_wk_verified$active_recruits), 0)
recrui_wk_verified$new.passive.response.rate <- ifelse(recrui_wk_verified$active_recruits!=0, 100*(recrui_wk_verified$passive_verifieds/recrui_wk_verified$active_recruits),NA)
recrui_wk_verified$new.total.response.rate <- ifelse(recrui_wk_verified$active_recruits>0, 100*(recrui_wk_verified$total_verifieds/recrui_wk_verified$active_recruits), 0)

#cumalative rate
recrui_wk_verified$cum.active.response.rate <- 100*(cumsum(recrui_wk_verified$active_verifieds)/cumsum(recrui_wk_verified$active_recruits))
recrui_wk_verified$cum.passive.response.rate <- 100*(cumsum(recrui_wk_verified$passive_verifieds)/cumsum(recrui_wk_verified$active_recruits))
recrui_wk_verified$cum.total.response.rate <- 100*(cumsum(recrui_wk_verified$total_verifieds)/cumsum(recrui_wk_verified$active_recruits))

###for the verified group on their biospecimen collections, module completions, eligibility and refusal and withdrawal
veri_resp$elgible.time <- ymd_hms(veri_resp$d_130371375_d_266600170_d_787567527) 
veri_resp$eligible.week <- ifelse(!is.na( veri_resp$d_130371375_d_266600170_d_787567527) & veri_resp$d_821247024==197316935,
                                  ceiling(as.numeric(difftime(as_date(veri_resp$elgible.time),as_date(recrstart.date-days(5)),units="days"))/7),NA)

# 4 264644252 Date/time of Completion of Where You Live and Work                                      SrvLAW_TmComplete_v1r0
# 5 315032037 Date/Time SSN Survey completed                                                          SrvSS_TmComplete_v1r0 
# 6 517311251 Date/time Status of Completion of Background and Overall Health                         SrvBOH_TmComplete_v1r0
# 7 764863765 Date/Time blood/urine survey completed                                                  SrvBlU_TmComplete_v1r0
# 8 770257102 Date/time of Completion of Smoking, Alcohol, and Sun Exposure                           SrvSAS_TmComplete_v1r0
# 9 832139544 Date/time Status of Completion of Medications, Reproductive Health, Exercise, and Sleep SrvMRE_TmComplete_v1r0
# 170 d_173836415_d_266600170_d_561681068                                 Date/time Research Blood Collected
# d_173836415_d_266600170_d_847159717                                 Date/time Research Urine Collected
#d_173836415_d_266600170_d_448660695                                      Date/time Mouthwash Collected
###For clinical samples you can use the 'any clinical sample' variable that includes blood or urine.
#d_173836415_d_266600170_d_139245758                                 Date/time Clinical Urine Collected
# d_173836415_d_266600170_d_982213346                                 Date/time Clinical Blood Collected

#Mar. 29, 2023, based on Michelle's comments: "any baseline blood or urine or mouthwash collected" would be the participants  
#with any biospecimen collected, in this way, the following up columns will be fixed soon. 
#and for the completion of all activities= complete of 4 modules and completion of all biospecimen by their settings: 
# research and clinic, but the incentive won't be included here
# the cumulative passive recruits are passive verified participants

veri_act <- filter(veri_resp,d_821247024==197316935) %>% 
  mutate(law.time = ymd_hms(d_264644252),
         sas.time = ymd_hms(d_770257102),
         mre.time = ymd_hms(d_832139544),
         boh.time = ymd_hms(d_517311251),
         bldcol.time = case_when(d_878865966 == 353358909 ~ pmin(as.POSIXct(d_173836415_d_266600170_d_561681068),as.POSIXct(d_173836415_d_266600170_d_982213346),as.POSIXct(d_173836415_d_266600170_d_398645039),as.POSIXct(d_173836415_d_266600170_d_822274939),na.rm=TRUE)),
         urine.time = case_when(d_167958071 == 353358909 ~ pmin(as.POSIXct(d_173836415_d_266600170_d_847159717),as.POSIXct(d_173836415_d_266600170_d_139245758),as.POSIXct(d_173836415_d_266600170_d_541311218),as.POSIXct(d_173836415_d_266600170_d_224596428),na.rm=TRUE)),
         mw.time = ymd_hms(d_173836415_d_266600170_d_448660695),
         biospeDonation = ifelse(d_878865966 %in% c(104430631,NA)  & d_167958071 %in% c(104430631,NA) & d_684635302 %in% c(104430631,NA),"No Sample Donations",
                                 ifelse(d_878865966 == 353358909 & d_167958071 == 353358909 & d_684635302 == 353358909,"Completed All 3 Sample Donations", 
                                        "Completed Some but Not All 3 Sample Donations")),
         biospeComplete = case_when(biospeDonation =="Completed All 3 Sample Donations" | 
                                      (d_173836415_d_266600170_d_592099155==664882224 & d_878865966 == 353358909 & d_167958071 == 353358909)  ~ 1,
                                    biospeDonation == "No Sample Donations" | ( biospeDonation == "Completed Some but Not All 3 Sample Donations" & 
                                                                                  d_173836415_d_266600170_d_592099155 %in% c(534621077,NA)) | 
                                      d_173836415_d_266600170_d_592099155==664882224 & d_878865966 %in% c(104430631, NA) | d_167958071 %in% c(104430631, NA) ~ 0),
         Module.complete = ifelse(d_100767870==353358909,"Complete","NotComplete"),
         HIPAARevVer = ifelse( d_773707518 == 353358909  & d_747006172 == 104430631 & d_831041022 == 104430631, 353358909,
                               ifelse( d_773707518 != 353358909  | d_747006172 != 104430631 | d_831041022 != 104430631,104430631, NA)),
         WdConsentVer = ifelse(d_747006172 == 353358909 & d_831041022 == 104430631, 353358909,
                               ifelse(d_747006172 != 353358909  | d_831041022 != 104430631,104430631, NA)),
         DestroyDataVer = ifelse(d_831041022 == 353358909, 353358909, ifelse(d_831041022 != 353358909,104430631, NA)))

veri_act$module.tm <- do.call(pmax, c(veri_act[,c("sas.time","mre.time","law.time","boh.time")],na.rm=TRUE))
veri_act <- veri_act%>% 
  mutate(module.time  = as_datetime(ifelse(d_100767870 ==353358909,module.tm,ifelse( d_100767870 ==104430631,NA,NA))),
         bioany.time = pmin(as.POSIXct(bldcol.time),as.POSIXct(urine.time),as.POSIXct(mw.time), na.rm = TRUE), #the earliest time of any collection
         biocol.time = pmax(as.POSIXct(bldcol.time),as.POSIXct(urine.time),as.POSIXct(mw.time), na.rm = TRUE)) ##the most recent time of any collection
           

veri_act <- veri_act%>% mutate(
  module.week = ifelse(!is.na(module.time),ceiling(as.numeric(difftime(as_date(module.time)+days(5),as_date(recrstart.date),units="days"))/7),NA),
  anybio.week = ifelse(!is.na(bioany.time),ceiling(as.numeric(difftime(as_date(bioany.time+days(5)),as_date(recrstart.date), units="days"))/7),NA),
  biocol.week = ifelse(!is.na(biocol.time),ceiling(as.numeric(difftime(as_date(biocol.time+days(5)),as_date(recrstart.date), units="days"))/7),NA),
  revoke.week = ifelse(!is.na(d_664453818),ceiling(as.numeric(difftime(as_date(ymd_hms(d_664453818)+days(5)),as_date(recrstart.date), units="days"))/7),NA),
  dtdestroy.week = ifelse(!is.na(d_269050420),ceiling(as.numeric(difftime(as_date(ymd_hms(d_269050420)+days(5)),as_date(recrstart.date), units="days"))/7),NA),
  wdconsent.week = ifelse(!is.na(d_659990606),ceiling(as.numeric(difftime(as_date(ymd_hms(d_659990606)+days(5)),as_date(recrstart.date), units="days"))/7),NA))

veri_act <- veri_act%>% mutate(allacts = case_when(d_100767870 == 353358909 & biospeComplete==1 ~ 353358909,
                                                d_100767870 == 104430631  | biospeComplete %in% c(0,NA) ~ 104430631 ))
veri_act$allacts.time <- apply(veri_act[,c("module.time","biocol.time")],1,max)
veri_act$allacts.week <- ceiling(as.numeric(difftime(as_date(ymd_hms(veri_act$allacts.time)+days(5)),as_date(recrstart.date), units="days"))/7)

eligible.wk.total <- veri_resp[which(veri_resp$d_821247024 == 197316935 & veri_resp$d_130371375_d_266600170_d_731498909 ==353358909 ),] %>% 
  group_by(eligible.week) %>%
  dplyr::summarize(total_eligible=n(),
                   eligible.time.max=max(elgible.time,rm.na=T))

module.wk.total <- filter(veri_act,d_100767870==353358909) %>% arrange(module.week,verified.week) %>% 
  group_by(module.week)%>%
  dplyr::summarize(total_module=n(),
                   module.time.max=max(as_date(module.time),rm.na=T))

anybio.wk.total <- filter(veri_act,biospeDonation!= "No Sample Donations") %>% arrange(anybio.week,verified.week) %>% 
  group_by(anybio.week)%>%
  dplyr::summarize(total_anybio=n(),
                   anybio.time.max=max(bioany.time,rm.na=T))


biocol.wk.total <- filter(veri_act, (biospeDonation =="Completed All 3 Sample Donations" | 
                     (d_173836415_d_266600170_d_592099155==664882224 & d_878865966 == 353358909 & d_167958071 == 353358909)))%>% 
 arrange(biocol.week,verified.week) %>% 
  group_by(biocol.week)%>%
  dplyr::summarize(total_biocol=n(),
                   biocol.time.max=max(biocol.time,rm.na=T))

allacts.wk.total <- filter(veri_act,allacts==353358909) %>% arrange(allacts.week,verified.week) %>% 
  group_by(allacts.week)%>%
  dplyr::summarize(total_allacts=n(),
                   allacts.time.max=max(allacts.time,rm.na=T))

#revoke.wk.total <- veri_act[which(veri_act$HIPAARevVer  ==353358909 ),] %>% 
#  group_by(revoke.week) %>%
#  dplyr::summarize(total_revoke=n())

dtdestroy.wk.total <- filter(veri_act,DestroyDataVer ==353358909) %>% arrange(dtdestroy.week,verified.week) %>% 
  group_by(dtdestroy.week)%>%
  dplyr::summarize(total_dtdestroy=n())

wdconsent.wk.total <- filter(veri_act,WdConsentVer ==353358909 & !is.na(wdconsent.week)) %>% arrange(wdconsent.week,verified.week) %>% 
  group_by(wdconsent.week)%>%
  dplyr::summarize(total_wdconsent=n())

veri_wk_eligble <- merge(verified.wk.total, eligible.wk.total,by.x="verified.week",by="eligible.week", all.x=TRUE,all.y=TRUE)
veri_wk_eligble <- merge(veri_wk_eligble, module.wk.total,by.x="verified.week",by="module.week", all.x=TRUE,all.y=TRUE)
veri_wk_eligble <- merge(veri_wk_eligble, anybio.wk.total,by.x="verified.week",by="anybio.week", all.x=TRUE,all.y=TRUE)
veri_wk_eligble <- merge(veri_wk_eligble, biocol.wk.total,by.x="verified.week",by="biocol.week", all.x=TRUE,all.y=TRUE)
veri_wk_eligble <- merge(veri_wk_eligble, dtdestroy.wk.total,by.x="verified.week",by="dtdestroy.week", all.x=TRUE,all.y=TRUE)
veri_wk_eligble <- merge(veri_wk_eligble, wdconsent.wk.total,by.x="verified.week",by="wdconsent.week", all.x=TRUE,all.y=TRUE)
veri_wk_eligble <- merge(veri_wk_eligble, allacts.wk.total,by.x="verified.week",by="allacts.week", all.x=TRUE,all.y=TRUE)
veri_wk_eligble <- veri_wk_eligble %>% 
  mutate(verified.week.date=as_date(ifelse(is.na(verified.week.date),as_date(recrstart.date)+dweeks(verified.week-1)+days(5),verified.week.date)))
###mutate_at(vars(match())) cannot work on here with an error messages
vars <- c("total_verifieds.x","total_module","total_anybio","total_eligible","total_biocol","total_dtdestroy","total_wdconsent","total_allacts")
recr_veri_wk <-  merge(recrui_wk_verified,veri_wk_eligble, by.x="recruit.week",by.y="verified.week",all.x=TRUE,all.y=TRUE)
recr_veri_wk <- recr_veri_wk %>% dplyr::select(.,-c("total_verifieds.y","verified_time.max.y"))

recr_veri_wk <- recr_veri_wk %>% mutate_at(vars,~replace_na(., 0)) %>%  arrange(recruit.week)%>% 
  mutate(total_eligible.cum=cumsum(total_eligible),
         total_module.cum=cumsum(total_module),
         total_anybio.cum=cumsum(total_anybio),
         total_biocol.cum=cumsum(total_biocol),
         total_dtdestroy.cum=cumsum(total_dtdestroy),
         total_wdconsent.cum=cumsum(total_wdconsent),
         total_allacts.cum=cumsum(total_allacts))



#recr_veri_wk <- recr_veri_wk %>% dplyr::select(-c(total_verifieds.y,verified_time.max.y))

#write.csv(recrui_wk_verified,"~/Documents/Connect_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/prod_verified_recruits_cumulative_0306.csv",row.names = F,na="")
var.list <- c("eligible","module","anybio","biocol","allacts","dtdestroy","wdconsent")

recr_veri_wk <- recr_veri_wk %>% mutate_at(vars,~replace_na(., 0))
ratio <- function(x,y){ifelse(y==0, 0,100*x/y)}
for (i in 1:length(var.list)){
  name <-paste0("total_",var.list[i],".cum")
  x <- recr_veri_wk[,name]
  recr_veri_wk$ratio1 <- ratio(x,recr_veri_wk$active_recruits.cum)
  colnames(recr_veri_wk)[which(colnames(recr_veri_wk)=="ratio1")] <- paste(var.list[i],"Invites","ratio",sep="_")
  recr_veri_wk$ratio2 <- ratio(x,recr_veri_wk$total_verified.cum)
  colnames(recr_veri_wk)[which(colnames(recr_veri_wk)=="ratio2")] <- paste(var.list[i],"Verifieds","ratio",sep="_")
}

recr_veri_wk$Week.Starting <- recr_veri_wk$recruit.week.date-days(6)
recr_veri_wk$Week.Ending <- recr_veri_wk$recruit.week.date
recr_veri_wk$week.day <- wday(recr_veri_wk$Week.Starting,label=TRUE,abbr=F)
recr_veri_wk <- recr_veri_wk %>% mutate(total_analysis=cumsum(total_verifieds.x)-cumsum(total_dtdestroy),
                                        total_followup=cumsum(total_verifieds.x)-cumsum(total_wdconsent))
#write.csv(recr_veri_wk,"~/Documents/Connect_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/prod_Allratio_recruits_cumulative_0306.csv",row.names = F,na="")
#"recruit.week", "week.day", "recruit.week.date","passive_verifieds",
var.select <- c(  "active_recruits.cum", "passive_verifieds.cum", "total_verified.cum", "cum.total.response.rate", 
                  "active_recruits", "total_verifieds.x", "total_anybio.cum","anybio_Invites_ratio","anybio_Verifieds_ratio",
                  "total_anybio","total_module.cum", "module_Invites_ratio", "module_Verifieds_ratio", "total_module", "total_eligible.cum", "eligible_Invites_ratio",
                  "eligible_Verifieds_ratio", "total_eligible", "total_allacts.cum", "allacts_Invites_ratio", "allacts_Verifieds_ratio", "total_allacts", 
                  "total_wdconsent.cum", "wdconsent_Verifieds_ratio", "total_wdconsent", "total_dtdestroy.cum", "dtdestroy_Verifieds_ratio", "total_dtdestroy", 
                  "total_analysis", "total_followup")        

#"total_biocol.cum", "biocol_Invites_ratio", "biocol_Verifieds_ratio", "total_biocol",  this part is about the completed biospecimen collection counts

labels <- c("Cumulative Invitations", "Cumulative Passive Verified Participants", "Cumulative Verified Participants", 
            "Response Ratio = Verfication/ Invitations", "Invitations per week", "Verifications per week", 
            "Cumulative Specimens defined as any baseline blood or urine or mouthwash collected", 
            "Specimen Response Ratio among Invited = Specimens/ Invited", "Specimen Response Ratio among Verified = Specimens/ Verified", 
            "Specimens collected per week", "Cumulative All Baseline Surveys (Modules 1-4)", "Survey Response Ratio among Invited = All Baseline Surveys/Invited", 
            "Survey Response Ratio among Verified = All Baseline Surveys/ Verified", "Survey Completion per week", 
            "Cumulative Incentive Eligible", "Incentive Eligible Response Ratio among Invited = Incentive Eligible/ Invited", 
            "Incentive Eligible Response Ratio among Verified = Incentive Eligible/ Verified", "Incentive Eligible  per week ", 
            "Cumulative Completed All Participant Study Activities", "Completed All Participant Study Activity Response Ratio among Invited = Completed All Activities/ Invited", 
            "Completed All Participant Study Activity Response Ratio among Verified = Completed All Activities/ Verified", 
            "Completed all Participant Study Activities per week",
            "Cumulative Withdrawals", "Withdrawal/ Verfied", "Withdrawals per week ", "Cumulative Data Destruction", "Data Destruction/ Verified", 
            "Data Destruction per week", "Available for Analysis (Verified - Data Destruction)", "Available for Follow-up (Verified - Withdrawals)")

base <- recr_veri_wk[,c("recruit.week", "Week.Starting", "Week.Ending","week.day")] #"Cumulative Revocations", "Revocation/ Verified", "Revocations per week", 
#colnames(base)[2] <- "week.date"
for (v in 1:length(var.select)){
  base$x <- recr_veri_wk[,var.select[v]]
  colnames(base)[v+4] <- labels[v]
}

##Mar. 27, 2023, as Amelia 
if (write_to_box){
  box_auth(client_id = "627lww8un9twnoa8f9rjvldf7kb56q1m",
           client_secret = "gSKdYKLd65aQpZGrq9x4QVUNnn5C8qqm")
  box_setwd(dir_id = 200244295811)

  box_write(object = base[which(base$Week.Starting!=currentDate),], 
            file_name =paste("CCC_metrics_weekly_log_labels_",currentDate,".csv",sep=""),na="",row.names=F)
}
#write.csv(base,paste("~/Documents/CONNECT_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/CCC_metrics_weekly_log_labels_",currentDate,".csv",sep=""),na="",row.names=F)

#write.csv(base,"~/Documents/CONNECT_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/CCC_metrics_weekly_log_labels_03062023.csv",na.rm="",row.names=F)
###by site
veri_act <- apply_labels(veri_act,d_827220437 = "Site",#RcrtES_Site_v1r0
                         d_827220437 = c("HealthPartners"= 531629870, "Henry Ford Health System"=548392715, "Kaiser Permanente Colorado" = 125001209,
                                         "Kaiser Permanente Georgia" = 327912200,"Kaiser Permanente Hawaii" = 300267574,"Kaiser Permanente Northwest" = 452412599,
                                         "Marshfield Clinic Health System" = 303349821,"Sanford Health" = 657167265, "University of Chicago Medicine" = 809703864,
                                         "National Cancer Institute" = 517700004,"National Cancer Institute" = 13,"Other" = 181769837))

veri_act$site <- factor(veri_act$d_827220437,exclude=NULL,
                        levels=c("HealthPartners", "Henry Ford Health System","Marshfield Clinic Health System",
                                 "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado",
                                 "Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest",
                                 "National Cancer Institute","Other"))

recruit.wk.active.site <- veri_resp[which(veri_resp$d_512820379==486306141),] %>% arrange(site,recruit.week) %>%
  group_by(site,recruit.week,recruit.week.date) %>%
  dplyr::summarize(active_recruits=n(),
                   recruitdate_max=max(recru_time,rm.na=T))

verified.wk.active.site <- veri_resp[which(veri_resp$d_821247024 == 197316935 & veri_resp$d_512820379==486306141),] %>% 
  arrange(site,verified.week) %>% group_by(site,verified.week,verified.week.date) %>%
  dplyr::summarize(active_verifieds=n(),
                   verified_activetime.max=max(verified_time,rm.na=T))

verified.wk.total.site <- veri_resp[which(veri_resp$d_821247024 == 197316935),] %>% arrange(site,verified.week) %>% 
  group_by(site,verified.week,verified.week.date) %>%
  dplyr::summarize(total_verifieds=n(),
                   verified_time.max=max(verified_time,rm.na=T))

verified.all.site <- merge(verified.wk.total.site,verified.wk.active.site, by.x=c("site","verified.week","verified.week.date"), by.y=c("site","verified.week","verified.week.date"),all.y=TRUE,all.x=TRUE)
recrui_wk_verified.site <- merge(recruit.wk.active.site,verified.all.site, by.x=c("site","recruit.week","recruit.week.date"),by.y=c("site","verified.week","verified.week.date"),all.y=TRUE,all.x=TRUE)
recrui_wk_verified.site <- recrui_wk_verified.site %>% mutate_at(c("active_recruits","active_verifieds","total_verifieds"),~replace_na(., 0))

recrui_wk_verified.site <- recrui_wk_verified.site %>% 
  mutate(passive_verifieds = total_verifieds-active_verifieds,
         total_recruits = total_verifieds + active_recruits - active_verifieds)

###verified group
eligible.wk.total.site <- veri_resp[which(veri_resp$d_821247024 == 197316935 & veri_resp$d_130371375_d_266600170_d_731498909 ==353358909 ),] %>% 
  group_by(site,eligible.week) %>%
  dplyr::summarize(total_eligible=n(),
                   eligible.time.max=max(elgible.time,rm.na=T))

module.wk.total.site <- filter(veri_act,d_100767870==353358909) %>% arrange(site,module.week,verified.week)  %>%
  group_by(site,module.week)%>%
  dplyr::summarize(total_module=n(),
                   module.time.max=max(as_date(module.time),rm.na=T))

anybio.wk.total.site <- filter(veri_act,biospeDonation!= "No Sample Donations") %>% arrange(site,anybio.week,verified.week) %>% 
  group_by(site,anybio.week)%>%
  dplyr::summarize(total_anybio=n(),
                   anybio.time.max=max(bioany.time,rm.na=T))


biocol.wk.total.site <- filter(veri_act, (biospeDonation =="Completed All 3 Sample Donations" | 
                                       (d_173836415_d_266600170_d_592099155==664882224 & d_878865966 == 353358909 & d_167958071 == 353358909)))%>% 
  arrange(site,biocol.week,verified.week) %>% 
  group_by(site,biocol.week)%>%
  dplyr::summarize(total_biocol=n(),
                   biocol.time.max=max(biocol.time,rm.na=T))

allacts.wk.total.site <- filter(veri_act,allacts==353358909) %>% arrange(site,allacts.week,verified.week) %>% 
  group_by(site,allacts.week)%>%
  dplyr::summarize(total_allacts=n(),
                   allacts.time.max=max(allacts.time,rm.na=T))
#revoke.wk.total <- veri_act[which(veri_act$HIPAARevVer  ==353358909 ),] %>% 
#  group_by(revoke.week) %>%
#  dplyr::summarize(total_revoke=n())

dtdestroy.wk.total.site <- filter(veri_act,DestroyDataVer ==353358909) %>% arrange(site,dtdestroy.week) %>% 
  group_by(site,dtdestroy.week)%>%
  dplyr::summarize(total_dtdestroy=n())

wdconsent.wk.total.site <- filter(veri_act,WdConsentVer ==353358909 & !is.na(wdconsent.week)) %>% arrange(site,wdconsent.week) %>% 
  group_by(site,wdconsent.week)%>%
  dplyr::summarize(total_wdconsent=n())


veri_wk_eligble.site <- merge(verified.wk.total.site, eligible.wk.total.site,by.x=c("site","verified.week"),by=c("site","eligible.week"), all.x=TRUE,all.y=TRUE)
veri_wk_eligble.site <- merge(veri_wk_eligble.site, module.wk.total.site,by.x=c("site","verified.week"),by=c("site","module.week"), all.x=TRUE,all.y=TRUE)
veri_wk_eligble.site <- merge(veri_wk_eligble.site,anybio.wk.total.site,by.x=c("site","verified.week"),by=c("site","anybio.week"), all.x=TRUE,all.y=TRUE)
veri_wk_eligble.site <- merge(veri_wk_eligble.site, biocol.wk.total.site,by.x=c("site","verified.week"),by=c("site","biocol.week"), all.x=TRUE,all.y=TRUE)
veri_wk_eligble.site <- merge(veri_wk_eligble.site, dtdestroy.wk.total.site,by.x=c("site","verified.week"),by=c("site","dtdestroy.week"), all.x=TRUE,all.y=TRUE)
veri_wk_eligble.site <- merge(veri_wk_eligble.site, wdconsent.wk.total.site,by.x=c("site","verified.week"),by=c("site","wdconsent.week"), all.x=TRUE,all.y=TRUE)
veri_wk_eligble.site <- merge(veri_wk_eligble.site, allacts.wk.total.site,by.x=c("site","verified.week"),by=c("site","allacts.week"), all.x=TRUE,all.y=TRUE)

#veri_wk_eligble.site <- veri_wk_eligble.site %>% mutate_at(vars(matches("total")),~replace_na(., 0))

recr_veri_wk.site <-  merge(recrui_wk_verified.site,veri_wk_eligble.site, by.x=c("site","recruit.week", "verified_time.max","total_verifieds"),by.y=c("site","verified.week", "verified_time.max","total_verifieds"),all.x=TRUE,all.y=TRUE)

vars0 <- c("active_recruits","active_verifieds","passive_verifieds", "total_recruits","total_verifieds","total_module",
          "total_anybio","total_eligible","total_biocol","total_dtdestroy","total_wdconsent","total_allacts")


recr_veri_wk.site <- recr_veri_wk.site %>% mutate_at(vars0,~replace_na(., 0))
#recr_veri_wk.site <- recr_veri_wk.site %>% mutate_at(c("active_recruits","active_verifieds","passive_verifieds"),~replace_na(., 0))
recr_veri_wk.site$recruit.week.date <- as_date(ifelse(is.na(recr_veri_wk.site$recruit.week.date), recrstart.date + days(2)+dweeks(recr_veri_wk.site$recruit.week-1),recr_veri_wk.site$recruit.week.date))
recr_veri_wk.site$Week.Starting <- recr_veri_wk.site$recruit.week.date - days(6)
recr_veri_wk.site$week.day <- wday(recr_veri_wk.site$Week.Starting,label=TRUE,abbr=F)
recr_veri_wk.site$Week.Ending <- recr_veri_wk.site$recruit.week.date

site_recruit_verified <- list()
site <- levels(droplevels(recr_veri_wk.site$site))
for(i in 1:length(site)){
  s = site[i]
  subs.recrui_verified <- filter(recr_veri_wk.site,site==s)
  #subs.recrui_verified[is.na(subs.recrui_verified)] = 0
  
  subs.recrui_verified <- subs.recrui_verified %>% arrange(recruit.week,recruit.week.date)
  subs.recrui_verified$active_verifieds.cum <- cumsum(subs.recrui_verified$active_verifieds)
  subs.recrui_verified$passive_verifieds.cum <- cumsum(subs.recrui_verified$total_verifieds-subs.recrui_verified$active_verifieds)
  subs.recrui_verified$cum.total_verifieds <- cumsum(subs.recrui_verified$total_verifieds)
  subs.recrui_verified$active_recruits.cum <- cumsum(subs.recrui_verified$active_recruits)
  subs.recrui_verified$total_recruits.cum <- cumsum(subs.recrui_verified$active_recruits + subs.recrui_verified$passive_verifieds)
  
  subs.recrui_verified$new.active.response.rate <- 100*(subs.recrui_verified$active_verifieds/subs.recrui_verified$active_recruits)
  subs.recrui_verified$new.passive.response.rate <- 100*(subs.recrui_verified$passive_verifieds/subs.recrui_verified$active_recruits)
  subs.recrui_verified$new.total.response.rate <- 100*(subs.recrui_verified$total_verifieds/subs.recrui_verified$active_recruits)
  
  subs.recrui_verified$cum.active.response.rate <- 100*(cumsum(subs.recrui_verified$active_verifieds)/cumsum(subs.recrui_verified$active_recruits))
  subs.recrui_verified$cum.passive.response.rate <- 100*(cumsum(subs.recrui_verified$passive_verifieds)/cumsum(subs.recrui_verified$active_recruits))
  subs.recrui_verified$cum.total.response.rate <- 100*(cumsum(subs.recrui_verified$total_verifieds)/cumsum(subs.recrui_verified$active_recruits))
  
  
  subs.recr_veri_wk <- subs.recrui_verified %>% arrange(recruit.week)%>% 
    mutate(total_anybio.cum=cumsum(total_anybio),
           anybio.invite.ratio=100*cumsum(total_anybio)/active_recruits.cum,
           anybio.verified.ratio=100*cumsum(total_anybio)/cum.total_verifieds,
           total_module.cum=cumsum(total_module),
           module.invite.ratio=100*cumsum(total_module)/active_recruits.cum,
           module.verified.ratio=100*cumsum(total_module)/cum.total_verifieds,
           
           total_eligible.cum=cumsum(total_eligible),
           eligible.invite.ratio=100*cumsum(total_eligible)/active_recruits.cum,
           eligible.verified.ratio=100*cumsum(total_eligible)/cum.total_verifieds,
           total_allacts.cum=cumsum(total_allacts),
           allacts.verified.ratio=100*cumsum(total_allacts)/cum.total_verifieds,
           allacts.invite.ratio=100*cumsum(total_allacts)/active_recruits.cum,
           
           total_dtdestroy.cum=cumsum(total_dtdestroy),
           dtdestroy.invite.ratio=100*cumsum(total_dtdestroy)/active_recruits.cum,
           dtdestroy.verified.ratio=100*cumsum(total_dtdestroy)/cum.total_verifieds,
           total_wdconsent.cum=cumsum(total_wdconsent),
           wdconsent.verifed.ratio=100*cumsum(total_wdconsent)/cum.total_verifieds,
           wdconsent.invite.ratio=100*cumsum(total_wdconsent)/active_recruits.cum,
           total_analysis=cumsum(total_verifieds)-cumsum(total_dtdestroy),
           total_followup=cumsum(total_verifieds)-cumsum(total_wdconsent),
           total_biocol.cum=cumsum(total_biocol),
           biocol.invite.ratio=100*cumsum(total_biocol)/active_recruits.cum,
           biocol.verified.ratio=100*cumsum(total_biocol)/cum.total_verifieds)
  #var.list <- c("eligible","module","biocol","allacts","dtdestroy","wdconsent")
  var.select <- c(  "active_recruits.cum", "passive_verifieds.cum", "cum.total_verifieds", "cum.total.response.rate", 
                    "active_recruits", "total_verifieds", "total_anybio.cum", "anybio.invite.ratio", "anybio.verified.ratio", "total_anybio", 
                    "total_module.cum", "module.invite.ratio", "module.verified.ratio", "total_module", "total_eligible.cum", "eligible.invite.ratio",
                    "eligible.verified.ratio", "total_eligible", "total_allacts.cum", "allacts.invite.ratio", "allacts.verified.ratio", "total_allacts", 
                    "total_wdconsent.cum", "wdconsent.verifed.ratio", "total_wdconsent", "total_dtdestroy.cum", "dtdestroy.verified.ratio", "total_dtdestroy", 
                    "total_analysis", "total_followup")
  labels <- c("Cumulative Invitations", "Cumulative Passive Verified Participants", "Cumulative Verified Participants", 
              "Response Ratio = Verfication/ Invitations", "Invitations per week", "Verifications per week", 
              "Cumulative Specimens defined as any baseline blood or urine or mouthwash collected", 
              "Specimen Response Ratio among Invited = Specimens/ Invited", "Specimen Response Ratio among Verified = Specimens/ Verified", 
              "Specimens collected per week", "Cumulative All Baseline Surveys (Modules 1-4)", "Survey Response Ratio among Invited = All Baseline Surveys/Invited", 
              "Survey Response Ratio among Verified = All Baseline Surveys/ Verified", "Survey Completion per week", 
              "Cumulative Incentive Eligible", "Incentive Eligible Response Ratio among Invited = Incentive Eligible/ Invited", 
              "Incentive Eligible Response Ratio among Verified = Incentive Eligible/ Verified", "Incentive Eligible  per week ", 
              "Cumulative Completed All Participant Study Activities", "Completed All Participant Study Activity Response Ratio among Invited = Completed All Activities/ Invited", 
              "Completed All Participant Study Activity Response Ratio among Verified = Completed All Activities/ Verified", 
              "Completed all Participant Study Activities per week",
              "Cumulative Withdrawals", "Withdrawal/ Verfied", "Withdrawals per week ", "Cumulative Data Destruction", "Data Destruction/ Verified", 
              "Data Destruction per week", "Available for Analysis (Verified - Data Destruction)", "Available for Follow-up (Verified - Withdrawals)")
  
  sub.base <- subs.recr_veri_wk[,c("site","recruit.week", "Week.Starting", "Week.Ending", "week.day")] #"Cumulative Revocations", "Revocation/ Verified", "Revocations per week", 
  #colnames(sub.base)[3] <- "Week Date"
  for (v in 1:length(var.select)){
    sub.base$x <- subs.recr_veri_wk[,var.select[v]]
    colnames(sub.base)[v+5] <- labels[v]
  }
  
  #write.csv(sub.base[which(subs.recr_veri_wk$Week.Starting != currentDate),],paste("~/Documents/CONNECT_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/CCC_metrics_weekly_log_labels_",site[i],"03202023.csv", sep=""))
  #write.csv(sub.base[which(subs.recr_veri_wk$Week.Starting != currentDate),],paste("~/Documents/CONNECT_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/CCC_metrics_weekly_log_labels_",site[i],currentDate,".csv", sep=""),na="",row.names=F)
  
  if (write_to_box){
    box_write(object = sub.base[which(sub.base$Week.Starting!=currentDate),], 
              file_name =paste("CCC_metrics_weekly_log_labels_",site[i],currentDate,".csv",sep=""),na="",row.names=F)
  }
  site_recruit_verified[[i]] <- subs.recr_veri_wk
  #write.csv(subs.recr_veri_wk,paste("~/Documents/CONNECT_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/CCC_metrics_weekly_log",site[i],"03202023.csv", sep=""))
  #write.csv(subs.recr_veri_wk,paste("~/Documents/CONNECT_projects/Biospecimen_Feb2022/Jing_projects/biospecQC_03082022/data/CCC_metrics_weekly_log",site[i],currentDate,".csv", sep=""),na="",row.names=F)
  
}  

```